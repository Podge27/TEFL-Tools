<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Column Sort: Speed & Accuracy</title>
    <link rel="icon" type="image/png" href="gameicon.png">
    <link rel="stylesheet" href="global.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- Custom Styles --- */
        body {
            background: linear-gradient(135deg, #00BCD4, #4DD0E1);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .game-column {
            transition: all 0.2s ease;
            min-height: 250px;
            border: 3px dashed #cbd5e1;
        }

        .game-column:hover {
            border-color: #00BCD4;
            background-color: #f0f9ff;
        }

        .game-column.target-active {
            background-color: #e0f7fa;
            border-color: #00BCD4;
            box-shadow: 0 0 15px rgba(0, 188, 212, 0.3);
            border-style: solid;
        }

        /* --- Card Styles --- */
        .word-card {
            cursor: grab;
            touch-action: manipulation;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            user-select: none;
        }

        .word-card:active { cursor: grabbing; }

        .word-card.selected {
            border-color: #F59E0B;
            background-color: #FEF3C7;
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.4);
            z-index: 50;
        }

        /* --- Feedback Styles --- */
        .word-card.correct {
            background-color: #D1FAE5; 
            border-color: #10B981;
            color: #065F46;
        }
        
        .word-card.incorrect {
            background-color: #FEE2E2; 
            border-color: #EF4444;
            color: #7F1D1D;
        }

        .word-card.was-incorrect {
            background-color: #FEF9C3 !important;
            border: 3px solid #EAB308 !important;
            color: #854D0E;
            position: relative;
        }
        
        /* Style for Cloned cards (Ghost cards showing alternate answers) */
        .word-card.clone-answer {
            opacity: 0.8;
            border-style: dashed !important;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <div class="w-full max-w-7xl flex justify-between items-center mb-6">
        <a href="index.html" class="btn-back shadow-md">‚Üê Back</a>
        <div class="bg-white px-4 py-2 rounded-xl shadow-lg font-black text-gray-700 text-xl" id="timer">00:00</div>
    </div>

    <main class="w-full max-w-7xl glass-panel p-6 flex flex-col min-h-[80vh]">
        
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-8 tracking-tight">
            Categorization Challenge
        </h1>

        <div id="setup-screen" class="w-full max-w-2xl mx-auto space-y-6">
            
            <div id="csv-section" class="bg-gray-50 p-6 rounded-xl border border-gray-200 text-center transition-all duration-500">
                <h2 class="text-xl font-bold text-gray-700 mb-2">Upload CSV File</h2>
                <p class="text-sm text-gray-500 mb-4">Note: Wrap sentences with commas in "quotes".</p>
                <label class="cursor-pointer inline-block bg-gray-800 text-white font-bold px-6 py-3 rounded-lg hover:bg-gray-900 transition shadow-lg">
                    <span>üìÇ Select File</span>
                    <input type="file" accept=".csv, .txt" class="hidden" onchange="handleFileUpload(event)">
                </label>
                <p id="file-name" class="mt-2 text-sm font-medium text-green-600"></p>
            </div>

            <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                <h2 class="text-xl font-bold text-blue-800 mb-2">Search Database</h2>
                <div class="flex gap-2">
                    <input type="text" id="db-search" placeholder="Search topics..." 
                           class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                           onkeyup="handleSearchInput()">
                    <button onclick="searchSupabase()" class="bg-blue-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                        Search
                    </button>
                </div>
                <div id="search-results" class="mt-2 hidden space-y-2 max-h-60 overflow-y-auto custom-scroll"></div>
            </div>

            <div id="popular-sets-section" class="pt-4 border-t border-gray-200">
                <h3 class="text-lg font-bold text-gray-500 mb-4 uppercase tracking-wider text-center">Available Sets</h3>
                <div id="popular-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="p-4 text-center text-gray-400 italic">Loading sets...</div>
                </div>
            </div>
        </div>

        <div id="game-area" class="hidden flex-col flex-1">
            <div class="mb-8 flex flex-col items-center">
                <div class="flex justify-between items-end mb-2 w-full max-w-3xl">
                    <h3 class="font-bold text-gray-500 uppercase tracking-wider text-sm">Next Item</h3>
                    <div class="text-sm font-bold text-blue-600"><span id="items-left">0</span> items waiting</div>
                </div>
                <div id="spawn-zone" class="bg-white rounded-xl p-6 min-h-[120px] w-full max-w-md flex justify-center items-center border-2 border-gray-200 shadow-inner"></div>
            </div>

            <div id="columns-container" class="grid gap-4 flex-1"></div>

            <div class="mt-8 flex justify-center gap-4 flex-wrap">
                <button id="btn-check" onclick="checkAnswers()" class="hidden bg-indigo-600 text-white text-xl font-black px-8 py-3 rounded-xl shadow-xl hover:bg-indigo-700 transition transform hover:-translate-y-1">
                    Check Answers
                </button>
                <button id="btn-solve" onclick="solveGame()" class="bg-blue-50 text-blue-600 font-bold px-6 py-3 rounded-xl hover:bg-blue-100 transition border border-blue-200">
                    Show Answers
                </button>
                <button id="btn-reset" onclick="resetGame()" class="bg-gray-400 text-white font-bold px-6 py-3 rounded-xl hover:bg-gray-500 transition">
                    Reset
                </button>
            </div>
            
            <div id="result-message" class="text-center mt-4 text-xl font-bold"></div>
        </div>

    </main>

    <script>
        const SUPABASE_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";


        let supabaseClient = null;
        try {
            if(SUPABASE_URL.includes('your-project') === false) {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch(e) { console.error("Supabase Init Error", e); }

        let gameState = {
            categories: [], 
            items: [],      
            queue: [],      
            timer: null,
            seconds: 0,
            selectedCard: null 
        };

        // --- CSV PARSER (The Fix) ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('file-name').innerText = file.name;
            const reader = new FileReader();
            reader.onload = (e) => parseCSV(e.target.result);
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            if (lines.length < 2) { alert("CSV needs headers and data."); return; }
            
            const headers = lines[0].split(',').map(h => h.trim());
            
            let itemMap = {}; 
            
            // Regex to split by comma ONLY if not inside quotes
            const csvRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

            for (let i = 1; i < lines.length; i++) {
                const rowData = lines[i].split(csvRegex);
                
                rowData.forEach((cellText, colIndex) => {
                    if (!cellText) return;

                    let cleanText = cellText.trim();
                    // Remove wrapping quotes if present
                    if (cleanText.startsWith('"') && cleanText.endsWith('"')) {
                        cleanText = cleanText.slice(1, -1);
                    }
                    // Handle escaped quotes
                    cleanText = cleanText.replace(/""/g, '"');

                    const category = headers[colIndex];
                    
                    if (cleanText !== "" && category) {
                        if (itemMap[cleanText]) {
                            itemMap[cleanText].category += "|" + category;
                        } else {
                            itemMap[cleanText] = {
                                text: cleanText,
                                category: category
                            };
                        }
                    }
                });
            }

            let items = [];
            let idCounter = 0;
            Object.values(itemMap).forEach(item => {
                items.push({
                    id: `csv-item-${idCounter++}`,
                    text: item.text,
                    category: item.category 
                });
            });

            startGame(headers, items);
        }

        // --- SUPABASE & UI LOGIC ---

        function handleSearchInput() {
            const query = document.getElementById('db-search').value;
            const csvSection = document.getElementById('csv-section');
            const popularSection = document.getElementById('popular-sets-section');
            const resultsDiv = document.getElementById('search-results');
            if (query.length > 0) {
                csvSection.classList.add('hidden');
                popularSection.classList.add('hidden');
            } else {
                csvSection.classList.remove('hidden');
                popularSection.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
            }
        }

        async function searchSupabase() {
            const query = document.getElementById('db-search').value;
            const resultsDiv = document.getElementById('search-results');
            if (!query || query.length < 2) return;
            if (!supabaseClient) { alert("Supabase not configured!"); return; }

            document.getElementById('csv-section').classList.add('hidden');
            document.getElementById('popular-sets-section').classList.add('hidden');

            resultsDiv.innerHTML = '<div class="p-2 text-gray-500">Searching...</div>';
            resultsDiv.classList.remove('hidden');

            const { data, error } = await supabaseClient
                .from('sorter_sets')
                .select('*')
                .or(`title.ilike.%${query}%,topic.ilike.%${query}%`)
                .limit(10);

            if (error) { resultsDiv.innerHTML = '<div class="p-2 text-red-500">Error.</div>'; return; }
            resultsDiv.innerHTML = '';
            if (data.length === 0) { resultsDiv.innerHTML = '<div class="p-2 text-gray-500">No results.</div>'; return; }
            renderSetButtons(data, resultsDiv);
        }

        async function loadPopularSets() {
            if (!supabaseClient) return;
            const listDiv = document.getElementById('popular-list');
            const { data, error } = await supabaseClient
                .from('sorter_sets')
                .select('*')
                .limit(100)
                .order('created_at', { ascending: false });

            if (error || !data) { listDiv.innerHTML = '<div class="col-span-2 text-center text-red-400">Could not load sets.</div>'; return; }
            listDiv.innerHTML = '';
            if (data.length === 0) { listDiv.innerHTML = '<div class="col-span-2 text-center text-gray-400">No sets found.</div>'; return; }
            renderSetButtons(data, listDiv);
        }

        function renderSetButtons(sets, container) {
            sets.forEach(set => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 bg-white border border-gray-200 rounded-xl hover:bg-blue-50 hover:border-blue-300 transition shadow-sm flex flex-col gap-1";
                btn.innerHTML = `
                    <div class="font-bold text-gray-800 text-lg">${set.title}</div>
                    <div class="text-xs text-blue-500 uppercase font-bold tracking-wide bg-blue-100 px-2 py-1 rounded w-fit">${set.topic}</div>
                `;
                btn.onclick = () => loadGameFromSet(set);
                container.appendChild(btn);
            });
        }

        function loadGameFromSet(set) {
            const headers = set.game_data.headers;
            let idCounter = 0;
            const items = set.game_data.items.map(item => ({
                id: `db-item-${idCounter++}`,
                text: item.text,
                category: item.category
            }));
            startGame(headers, items);
        }

        // --- GAME ENGINE ---

        function startGame(categories, items) {
            gameState.categories = categories;
            gameState.items = items;
            gameState.queue = [...items].sort(() => Math.random() - 0.5);
            
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('game-area').classList.add('flex');

            buildBoard();
            startTimer();
            spawnNextCard();
        }

        function buildBoard() {
            const container = document.getElementById('columns-container');
            container.innerHTML = '';
            const colCount = gameState.categories.length;
            container.className = "grid gap-4 flex-1 items-start";
            
            if(colCount === 2) container.classList.add('grid-cols-2');
            else if(colCount === 3) container.classList.add('grid-cols-3');
            else if(colCount === 4) container.classList.add('grid-cols-2', 'md:grid-cols-4');
            else container.classList.add('grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');

            gameState.categories.forEach(cat => {
                const col = document.createElement('div');
                col.className = "game-column bg-white rounded-xl p-4 shadow-sm flex flex-col gap-2 relative";
                col.innerHTML = `<h3 class="text-center font-black text-gray-600 border-b pb-2 mb-2 pointer-events-none select-none">${cat}</h3>`;
                col.id = `col-${cat}`;
                col.dataset.category = cat;
                col.onclick = () => handleColumnClick(col);
                col.ondragover = (e) => { e.preventDefault(); col.classList.add('target-active'); };
                col.ondragleave = (e) => { col.classList.remove('target-active'); };
                col.ondrop = (e) => handleDrop(e, col);
                container.appendChild(col);
            });
        }

        function spawnNextCard() {
            const spawnZone = document.getElementById('spawn-zone');
            if (spawnZone.children.length > 0) return;
            if (gameState.queue.length === 0) {
                document.getElementById('items-left').innerText = "0";
                document.getElementById('btn-check').classList.remove('hidden');
                return;
            }
            const item = gameState.queue.pop();
            document.getElementById('items-left').innerText = gameState.queue.length;
            createCardDOM(item, spawnZone);
        }

        function createCardDOM(item, parent) {
            const div = document.createElement('div');
            div.className = "word-card bg-white border-2 border-gray-200 px-6 py-4 rounded-xl font-bold text-gray-800 shadow-md text-xl md:text-2xl";
            div.innerText = item.text;
            div.id = item.id;
            div.draggable = true;
            div.dataset.category = item.category;
            div.onclick = (e) => { e.stopPropagation(); selectCard(div); };
            div.ondragstart = (e) => { e.dataTransfer.setData("text", item.id); div.classList.add('opacity-50'); };
            div.ondragend = () => { div.classList.remove('opacity-50'); clearColumnHighlights(); };
            parent.appendChild(div);
        }

        function selectCard(cardEl) {
            if (gameState.selectedCard === cardEl) {
                cardEl.classList.remove('selected');
                gameState.selectedCard = null;
                clearColumnHighlights();
            } else {
                if (gameState.selectedCard) gameState.selectedCard.classList.remove('selected');
                gameState.selectedCard = cardEl;
                cardEl.classList.add('selected');
                document.querySelectorAll('.game-column').forEach(col => col.classList.add('target-active'));
            }
        }

        function handleColumnClick(colEl) {
            if (gameState.selectedCard) moveCardToColumn(gameState.selectedCard, colEl);
        }

        function handleDrop(e, colEl) {
            e.preventDefault();
            const id = e.dataTransfer.getData("text");
            const cardEl = document.getElementById(id);
            if (cardEl) moveCardToColumn(cardEl, colEl);
        }

        function moveCardToColumn(cardEl, colEl) {
            colEl.appendChild(cardEl);
            cardEl.className = "word-card bg-white border-2 border-gray-200 px-4 py-2 rounded-lg font-bold text-gray-700 shadow-sm text-sm mb-2 w-full block"; 
            cardEl.classList.remove('selected', 'correct', 'incorrect');
            gameState.selectedCard = null;
            clearColumnHighlights();
            spawnNextCard();
        }

        function clearColumnHighlights() {
            document.querySelectorAll('.game-column').forEach(col => col.classList.remove('target-active'));
        }

        // --- MULTI-CATEGORY CHECK LOGIC ---

        function checkAnswers() {
            let errors = 0;
            const cards = document.querySelectorAll('.game-column .word-card');
            
            cards.forEach(card => {
                const parentCol = card.closest('.game-column');
                const correctCategories = card.dataset.category.split('|'); 
                const placedCategory = parentCol.dataset.category;

                if (correctCategories.includes(placedCategory)) {
                    card.classList.add('correct');
                    card.classList.remove('incorrect');
                } else {
                    card.classList.add('incorrect');
                    card.classList.remove('correct');
                    errors++;
                }
            });

            const msgDiv = document.getElementById('result-message');
            if (errors === 0) {
                clearInterval(gameState.timer);
                msgDiv.innerHTML = `<span class="text-green-600 text-3xl">üéâ Perfect Score! Time: ${document.getElementById('timer').innerText}</span>`;
                document.getElementById('btn-check').classList.add('hidden');
                document.getElementById('btn-solve').classList.add('hidden');
            } else {
                msgDiv.innerHTML = `<span class="text-red-600">You have ${errors} errors. Keep trying!</span>`;
            }
        }

        // --- CLONING LOGIC FOR SHOW ANSWERS ---
        function solveGame() {
            clearInterval(gameState.timer);

            // 1. Audit Phase
            const cardsOnBoard = document.querySelectorAll('.game-column .word-card');
            cardsOnBoard.forEach(card => {
                const currentParent = card.parentElement;
                const correctCategories = card.dataset.category.split('|');
                const currentCat = currentParent.dataset.category;
                
                if (currentParent.classList.contains('game-column')) {
                    if (correctCategories.includes(currentCat)) {
                        card.classList.add('correct');
                    } else {
                        card.classList.add('was-incorrect');
                    }
                }
            });

            // 2. Helper to determine style
            const getStyleClass = (card) => {
                if (card.classList.contains('was-incorrect')) return "was-incorrect";
                if (card.classList.contains('correct')) return "correct";
                return ""; 
            };

            // 3. Helper to Clone and Place
            const placeInCorrectColumns = (card) => {
                const correctCats = card.dataset.category.split('|');
                const styleClass = getStyleClass(card);

                correctCats.forEach((cat, index) => {
                    const col = document.getElementById(`col-${cat}`);
                    if (col) {
                        let cardToPlace;
                        
                        if (index === 0 && card.parentElement !== col) {
                             cardToPlace = card; 
                        } else if (index === 0 && card.parentElement === col) {
                             cardToPlace = card; 
                        } else {
                             cardToPlace = card.cloneNode(true);
                             cardToPlace.id = card.id + "-clone-" + index; 
                             cardToPlace.classList.add('clone-answer'); 
                        }

                        cardToPlace.className = "word-card px-4 py-2 rounded-lg font-bold shadow-sm text-sm mb-2 w-full block " + styleClass;
                        if(styleClass === "") cardToPlace.className += " bg-white border-2 border-gray-200 text-gray-700";
                        
                        if(cardToPlace.parentElement !== col) {
                            col.appendChild(cardToPlace);
                        }
                    }
                });
            };

            // Process Queue
            while(gameState.queue.length > 0) {
                const item = gameState.queue.pop();
                const div = document.createElement('div');
                div.innerText = item.text;
                div.dataset.category = item.category;
                placeInCorrectColumns(div);
            }

            // Process Spawn Zone
            const spawnZone = document.getElementById('spawn-zone');
            while(spawnZone.children.length > 0) {
                placeInCorrectColumns(spawnZone.children[0]);
            }

            // Process Board
            const allCards = Array.from(document.querySelectorAll('.game-column .word-card'));
            const originalCards = allCards.filter(c => !c.id.includes('-clone-'));
            
            originalCards.forEach(card => {
                placeInCorrectColumns(card);
            });

            document.getElementById('items-left').innerText = "0";
            document.getElementById('spawn-zone').innerHTML = '';
            document.getElementById('btn-check').classList.add('hidden');
            document.getElementById('btn-solve').classList.add('hidden');
            document.getElementById('result-message').innerHTML = `<span class="text-blue-600 text-2xl">Answers Revealed. <span class="text-yellow-600 text-base font-black">(Yellow = Ones you missed)</span></span>`;
        }

        function startTimer() {
            gameState.seconds = 0;
            if(gameState.timer) clearInterval(gameState.timer);
            gameState.timer = setInterval(() => {
                gameState.seconds++;
                const m = Math.floor(gameState.seconds / 60).toString().padStart(2, '0');
                const s = (gameState.seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function resetGame() { location.reload(); }

        async function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const setId = urlParams.get('id');
            if (setId) {
                document.getElementById('setup-screen').innerHTML = '<div class="text-center text-white text-2xl font-bold mt-20">Loading set: ' + setId + '...</div>';
                if (!supabaseClient) { console.error("Supabase not configured"); return; }
                const { data, error } = await supabaseClient
                    .from('sorter_sets')
                    .select('*')
                    .eq('id', setId)
                    .single();
                if (error || !data) {
                    alert("Set not found: " + setId);
                    window.location.href = window.location.pathname;
                    return;
                }
                loadGameFromSet(data);
            } else {
                loadPopularSets();
            }
        }

        checkUrlParams();

    </script>
</body>
</html>