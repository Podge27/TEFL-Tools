<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="global.css">

    <style>
        body { background-color: #F8FAFC; font-family: 'Inter', sans-serif; }
        
        /* The "Real Exam Paper" Look - Softened */
        .exam-paper {
            background: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 16px; /* Rounded corners */
            font-family: 'Merriweather', serif;
            color: #1F2937;
            position: relative;
            overflow: hidden;
        }

        /* Paper decorative top border */
        .exam-paper::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: linear-gradient(90deg, #4F46E5, #818CF8);
        }

        /* Sidebar Styling */
        .sidebar-container {
            backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.95);
        }

        /* Smooth Accordion */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .accordion-open {
            max-height: 800px;
        }

        /* Custom Checkbox Design */
        .custom-checkbox:checked + div {
            background-color: #EEF2FF; /* Indigo-50 */
            border-color: #6366F1;
            color: #4338CA;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
        }
        
        /* Scrollbar polish */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <header class="bg-white/90 backdrop-blur-md border-b border-gray-200 h-18 flex items-center px-8 justify-between flex-shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-6">
            <a href="writing-index.html" class="text-gray-400 hover:text-indigo-600 font-bold flex items-center gap-2 text-sm transition-colors group">
                <div class="p-2 bg-gray-100 rounded-lg group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                </div>
                <span>Back</span>
            </a>
            
            <div>
                <h1 class="text-xl font-extrabold text-gray-900 tracking-tight">Writing Architect</h1>
                <div class="flex items-center gap-2 mt-0.5">
                    <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Level:</span>
                    <span id="level-badge" class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 text-gray-500 animate-pulse">LOADING...</span>
                </div>
            </div>
        </div>
        
        <button onclick="generateEssay()" id="btn-generate" class="bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white pl-5 pr-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all hover:scale-105 active:scale-95 flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
            <span>Generate WAGOLL</span>
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden">

        <aside class="w-1/3 min-w-[380px] max-w-[480px] sidebar-container border-r border-gray-200 overflow-y-auto p-8 flex flex-col gap-10 z-10 custom-scrollbar">

            <div class="space-y-3">
                <label class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                    <span class="w-5 h-5 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-[10px]">1</span>
                    Select Task
                </label>
                <div class="relative">
                    <select id="topic-select" onchange="loadQuestion()" class="w-full p-4 bg-white border border-gray-200 rounded-xl font-semibold text-gray-700 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none appearance-none transition-shadow hover:border-indigo-300">
                        <option value="" disabled selected>Loading topics from database...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                </div>
            </div>

            <div id="ingredients-section" class="hidden opacity-0 transition-all duration-500 transform translate-y-4">
                <label class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">
                    <span class="w-5 h-5 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-[10px]">2</span>
                    Essay Content
                </label>
                
                <div class="bg-indigo-50/50 p-5 rounded-2xl border border-indigo-100">
                    <p class="text-sm text-indigo-900 font-bold mb-4 flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                        <span id="instruction-text">Discussion Points</span>
                    </p>
                    
                    <div id="points-container" class="space-y-3">
                        </div>

                    <div id="own-idea-container" class="mt-4 hidden animate-fade-in">
                        <input type="text" id="own-idea-input" placeholder="Type the student's idea here..." class="w-full p-3 text-sm bg-white border border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none shadow-sm transition-all">
                    </div>
                </div>
            </div>

            <div id="tools-section" class="hidden space-y-4">
                <label class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                    <span class="w-5 h-5 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-[10px]">3</span>
                    Ingredients
                </label>

                <div class="border border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm">
                    <button onclick="toggleAccordion('acc-grammar')" class="w-full flex justify-between items-center p-4 bg-white hover:bg-gray-50 transition-colors font-bold text-gray-700 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">ðŸ§¬</span>
                            <span>Required Grammar</span>
                        </div>
                        <svg class="w-4 h-4 transform transition-transform text-gray-400" id="icon-acc-grammar" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="acc-grammar" class="accordion-content bg-gray-50/50">
                        <div class="p-4 grid grid-cols-1 gap-2" id="grammar-list">
                            </div>
                    </div>
                </div>

                <div class="border border-gray-200 rounded-xl overflow-hidden bg-white shadow-sm">
                    <button onclick="toggleAccordion('acc-linkers')" class="w-full flex justify-between items-center p-4 bg-white hover:bg-gray-50 transition-colors font-bold text-gray-700 text-sm">
                         <div class="flex items-center gap-2">
                            <span class="text-lg">ðŸ”—</span>
                            <span>Required Linkers</span>
                        </div>
                        <svg class="w-4 h-4 transform transition-transform text-gray-400" id="icon-acc-linkers" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="acc-linkers" class="accordion-content bg-gray-50/50">
                        <div class="p-4 space-y-2" id="linkers-list">
                            </div>
                    </div>
                </div>
            </div>

            <div id="quality-section" class="hidden pb-8">
                 <label class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">
                    <span class="w-5 h-5 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-[10px]">4</span>
                    Target Band Score
                </label>
                 <div class="flex bg-gray-100 p-1.5 rounded-xl shadow-inner">
                     <button onclick="setQuality('fail')" class="quality-btn flex-1 py-2.5 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-700 transition-all">Band 1-2 (Fail)</button>
                     <button onclick="setQuality('pass')" class="quality-btn flex-1 py-2.5 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-700 transition-all">Band 3 (Pass)</button>
                     <button onclick="setQuality('distinction')" class="quality-btn flex-1 py-2.5 text-xs font-bold rounded-lg bg-white shadow-sm text-indigo-600 ring-1 ring-black/5">Band 5 (Top)</button>
                 </div>
            </div>

        </aside>

        <main class="flex-1 bg-slate-50 overflow-y-auto p-10 flex justify-center custom-scrollbar">
            
            <div class="w-full max-w-4xl space-y-8">

                <div id="paper-view" class="exam-paper p-10 hidden opacity-0 transform translate-y-4 transition-all duration-700">
                    <div class="flex justify-between items-start mb-8 border-b border-gray-100 pb-6">
                        <div>
                            <h2 class="text-sm font-sans font-bold text-gray-400 uppercase tracking-widest">Part 1</h2>
                            <h1 class="text-4xl font-bold text-gray-900 mt-2 tracking-tight">Essay</h1>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-3 py-1 rounded bg-gray-100 text-xs font-sans font-bold text-gray-500">45 minutes</span>
                        </div>
                    </div>

                    <p class="text-xl leading-relaxed text-gray-600 mb-8" id="question-scenario">
                        </p>

                    <div class="bg-gray-50 rounded-xl border border-gray-200 p-8 mb-8 relative">
                         <div class="absolute -top-3 left-8 w-12 h-4 bg-gray-200 rounded-full opacity-50"></div>

                        <p class="font-bold text-2xl text-gray-800 mb-6 font-sans" id="essay-prompt">
                            </p>
                        
                        <div class="bg-white border border-gray-300 shadow-[2px_2px_0px_rgba(0,0,0,0.05)] p-6 inline-block min-w-[60%] rotate-1 transform transition hover:rotate-0">
                            <p class="text-xs font-sans font-bold text-gray-400 mb-3 uppercase tracking-wider border-b border-gray-100 pb-2">Notes</p>
                            <ul class="list-disc pl-5 space-y-2 font-medium text-lg text-gray-700" id="paper-notes">
                                </ul>
                        </div>
                    </div>

                    <div id="paper-opinions" class="hidden mt-8 pt-8 border-t border-gray-100">
                        <p class="text-xs font-sans font-bold text-gray-400 mb-4 uppercase tracking-wider">Opinions expressed in the discussion:</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="opinions-grid">
                            </div>
                    </div>
                </div>

                <div id="result-view" class="hidden animate-fade-in-up">
                    <div class="bg-white rounded-2xl shadow-xl border border-indigo-100 overflow-hidden ring-1 ring-black/5">
                        <div class="bg-gradient-to-r from-indigo-50 to-white px-8 py-5 border-b border-indigo-50 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-100 text-green-700 p-2 rounded-lg">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <h3 class="font-bold text-gray-900 text-lg">Model Answer</h3>
                            </div>
                            <div class="flex gap-2">
                                <button class="text-xs font-bold text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg transition-colors border border-transparent hover:border-indigo-100">Copy Text</button>
                            </div>
                        </div>
                        <div class="p-10 prose prose-lg prose-indigo max-w-none font-serif text-gray-700 leading-loose" id="ai-output-text">
                            <div class="flex flex-col items-center justify-center py-12 text-gray-400 gap-4">
                                <svg class="w-10 h-10 animate-spin text-indigo-200" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span class="font-sans text-sm font-medium">Writing your essay...</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

<script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";

        
        // FIX: We use 'db' instead of 'supabase' to avoid the name collision
        // We also access 'createClient' via the global 'supabase' object provided by the CDN
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const LEVEL = urlParams.get('level') || 'B2';
        let currentQuality = 'distinction';
        let allQuestions = []; 
        let currentQuestion = null;

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            setupLevelBadge();
            await fetchTopics();
            await fetchResources();
        });

        function setupLevelBadge() {
            const badge = document.getElementById('level-badge');
            badge.innerText = LEVEL;
            badge.classList.remove('animate-pulse');
            
            if (LEVEL === 'C1') {
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700 border border-purple-200";
                document.getElementById('instruction-text').innerText = "Select EXACTLY 2 Points";
            } else {
                badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200";
                document.getElementById('instruction-text').innerText = "Confirm Discussion Points";
            }
        }

        // --- 3. DATA FETCHING ---
        async function fetchTopics() {
            const select = document.getElementById('topic-select');
            
            // UPDATED: Use 'db' instead of 'supabase'
            const { data, error } = await db
                .from('writing_exam_questions')
                .select('*')
                .eq('level', LEVEL);

            if (error) {
                console.error('Error fetching topics:', error);
                select.innerHTML = '<option disabled>Error loading topics</option>';
                return;
            }

            allQuestions = data;
            
            select.innerHTML = '<option value="" disabled selected>Select a task...</option>';
            data.forEach(q => {
                const opt = document.createElement('option');
                opt.value = q.id;
                opt.innerText = q.title; 
                select.appendChild(opt);
            });
        }

async function fetchResources() {
            // UPDATED: Use 'db' instead of 'supabase'
            const { data, error } = await db
                .from('writing_resources')
                .select('*')
                .eq('level', LEVEL)
                .order('category', { ascending: true }); // Sort by category A-Z

            if (error) return console.error(error);

            // 1. POPULATE GRAMMAR (Simple List)
            const gList = document.getElementById('grammar-list');
            const grammarItems = data.filter(r => r.type === 'grammar');
            
            gList.innerHTML = ''; // Clear existing
            grammarItems.forEach(g => {
                gList.innerHTML += `
                    <label class="flex items-start gap-3 p-3 rounded-lg border border-transparent hover:bg-white hover:border-gray-200 hover:shadow-sm transition-all cursor-pointer group">
                        <input type="checkbox" value="${g.content}" class="mt-1 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <div>
                            <span class="block text-sm font-medium text-gray-700 group-hover:text-indigo-700">${g.content}</span>
                            ${g.explanation ? `<span class="block text-[10px] text-gray-400 leading-tight mt-0.5">${g.explanation}</span>` : ''}
                        </div>
                    </label>
                `;
            });

            // 2. POPULATE LINKERS (Grouped by Category)
            const lList = document.getElementById('linkers-list');
            const linkerItems = data.filter(r => r.type === 'linker');
            
            // Helper: Group array by 'category'
            const groupedLinkers = linkerItems.reduce((acc, item) => {
                const cat = item.category || 'General';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});

            lList.innerHTML = ''; // Clear existing

            // Iterate through categories
            Object.keys(groupedLinkers).sort().forEach(category => {
                // A. Add Category Header
                lList.innerHTML += `
                    <div class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest mt-4 mb-2 pl-1 border-b border-gray-100 pb-1">
                        ${category}
                    </div>
                `;

                // B. Add Items in that category
                groupedLinkers[category].forEach(l => {
                    lList.innerHTML += `
                        <label class="flex items-center justify-between p-2 rounded hover:bg-indigo-50 cursor-pointer transition-colors ml-1">
                            <span class="text-sm text-gray-600 font-medium">${l.content}</span>
                            <input type="checkbox" value="${l.content}" class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        </label>
                    `;
                });
            });
        }
        // --- 4. UI INTERACTION ---
        function loadQuestion() {
            const id = document.getElementById('topic-select').value;
            currentQuestion = allQuestions.find(q => q.id === id);
            if (!currentQuestion) return;

            const uiElements = ['ingredients-section', 'tools-section', 'quality-section'];
            uiElements.forEach((el, index) => {
                const domEl = document.getElementById(el);
                domEl.classList.remove('hidden');
                setTimeout(() => {
                    domEl.classList.remove('opacity-0', 'translate-y-4');
                }, index * 100); 
            });

            const paper = document.getElementById('paper-view');
            paper.classList.remove('hidden');
            setTimeout(() => { paper.classList.remove('opacity-0', 'translate-y-4'); }, 100);

            document.getElementById('question-scenario').innerText = currentQuestion.question_text;
            document.getElementById('essay-prompt').innerText = currentQuestion.essay_prompt;

            const notesList = document.getElementById('paper-notes');
            notesList.innerHTML = '';
            const points = currentQuestion.structure_data.points || [];
            points.forEach(p => {
                notesList.innerHTML += `<li>${p}</li>`;
            });

            const opDiv = document.getElementById('paper-opinions');
            const opGrid = document.getElementById('opinions-grid');
            const opinions = currentQuestion.structure_data.opinions;

            if (LEVEL === 'C1' && opinions) {
                opDiv.classList.remove('hidden');
                opGrid.innerHTML = '';
                opinions.forEach(op => {
                    opGrid.innerHTML += `<div class="bg-white border border-gray-200 p-4 rounded-lg text-xs italic text-gray-500 shadow-sm leading-relaxed">"${op.replace(/"/g, '')}"</div>`;
                });
            } else {
                opDiv.classList.add('hidden');
            }

            generateIngredientCheckboxes(points);
        }

        function generateIngredientCheckboxes(points) {
            const container = document.getElementById('points-container');
            container.innerHTML = '';
            const ownIdeaInput = document.getElementById('own-idea-container');

            if (LEVEL === 'B2') {
                points.forEach((p, idx) => {
                    const isOwnIdea = idx === (points.length - 1); 
                    
                    container.innerHTML += `
                        <label class="flex items-center p-3 border border-gray-200 rounded-xl bg-gray-50 cursor-not-allowed opacity-80">
                            <input type="checkbox" checked disabled class="w-5 h-5 text-gray-400 rounded border-gray-300">
                            <span class="ml-3 text-sm font-bold text-gray-500">${p}</span>
                        </label>
                    `;
                    
                    if (isOwnIdea) {
                        ownIdeaInput.classList.remove('hidden');
                        document.getElementById('own-idea-input').placeholder = `Type your idea for '${p}'...`;
                    }
                });
            } else {
                ownIdeaInput.classList.add('hidden');
                points.forEach(p => {
                    container.innerHTML += `
                        <label class="flex items-center cursor-pointer group">
                            <input type="checkbox" name="c1_point" value="${p}" onclick="limitChecks(this)" class="custom-checkbox sr-only">
                            <div class="w-full p-3 border border-gray-200 rounded-xl text-sm font-medium text-gray-600 group-hover:border-indigo-300 transition-all">
                                ${p}
                            </div>
                        </label>
                    `;
                });
            }
        }

        // --- 5. HELPERS ---
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (content.classList.contains('accordion-open')) {
                content.classList.remove('accordion-open');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('accordion-open');
                icon.classList.add('rotate-180');
            }
        }

        function limitChecks(checkbox) {
            const checked = document.querySelectorAll('input[name="c1_point"]:checked');
            if (checked.length > 2) {
                checkbox.checked = false;
                alert("For C1, you must select exactly TWO points.");
            }
        }

        function setQuality(level) {
            currentQuality = level;
            const buttons = document.querySelectorAll('.quality-btn');
            buttons.forEach(btn => {
                btn.className = "quality-btn flex-1 py-2.5 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-700 transition-all";
            });
            event.target.className = "quality-btn flex-1 py-2.5 text-xs font-bold rounded-lg bg-white shadow-sm text-indigo-600 ring-1 ring-black/5 transition-all transform scale-105";
        }

        // --- 6. GENERATION LOGIC ---
        function generateEssay() {
            if (!currentQuestion) return alert("Please select a task first.");

            const grammar = Array.from(document.querySelectorAll('#grammar-list input:checked')).map(cb => cb.value);
            const linkers = Array.from(document.querySelectorAll('#linkers-list input:checked')).map(cb => cb.value);
            
            let selectedPoints = [];
            let ownIdea = "";

            if (LEVEL === 'B2') {
                selectedPoints = currentQuestion.structure_data.points; 
                ownIdea = document.getElementById('own-idea-input').value;
                if (!ownIdea) return alert("Please type an idea for the 'Own Idea' point.");
            } else {
                selectedPoints = Array.from(document.querySelectorAll('input[name="c1_point"]:checked')).map(cb => cb.value);
                if (selectedPoints.length !== 2) return alert("Please select exactly 2 points to discuss.");
            }

            document.getElementById('result-view').classList.remove('hidden');
            const outputDiv = document.getElementById('ai-output-text');
            
            outputDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 text-gray-400 gap-4">
                    <svg class="w-10 h-10 animate-spin text-indigo-200" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="font-sans text-sm font-medium animate-pulse">Consulting Cambridge Examiners...</span>
                </div>
            `;
            document.getElementById('result-view').scrollIntoView({ behavior: 'smooth' });

            console.log("SENDING TO AI:", {
                level: LEVEL,
                quality: currentQuality,
                topic: currentQuestion.topic,
                points: selectedPoints,
                ownIdea: ownIdea,
                grammar: grammar,
                linkers: linkers
            });
            
            // Temporary Fake Result for Testing
            setTimeout(() => {
                outputDiv.innerHTML = `
                    <p class="font-bold text-indigo-700">Database Connection Successful!</p>
                    <p>This is a placeholder result to prove we can read the question and user inputs.</p>
                    <ul class="list-disc pl-5 mt-4 space-y-2">
                        <li><strong>Level:</strong> ${LEVEL}</li>
                        <li><strong>Topic:</strong> ${currentQuestion.title}</li>
                        <li><strong>Discussing:</strong> ${selectedPoints.join(', ')}</li>
                        <li><strong>Own Idea:</strong> ${ownIdea || 'N/A'}</li>
                    </ul>
                `;
            }, 1500);
        }
    </script>
</body>
</html>