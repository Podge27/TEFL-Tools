<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Architect | Builder Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="global.css">

    <style>
        body { background-color: #F8FAFC; font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .custom-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .builder-block {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            user-select: none;
        }
        .builder-block:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15); }
        .builder-block:active { transform: scale(0.98); }

        /* --- COLORS --- */
        .block-idea { background-color: #FFF7ED; border-left: 6px solid #F97316; color: #9A3412; } /* Orange (Ideas) */
        .block-grammar { background-color: #F0FDF4; border-left: 6px solid #22C55E; color: #166534; } /* Green (Grammar) */
        .block-linker { background-color: #EFF6FF; border-left: 6px solid #3B82F6; color: #1E40AF; } /* Blue (Linkers) */
        
        /* NEW: MAGENTA/FUCHSIA FOR VOCABULARY (Colorblind Safe) */
        .block-vocab { background-color: #FDF4FF; border-left: 6px solid #C026D3; color: #86198F; } 

        .used-item { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }

        /* SCAFFOLDING STYLES */
        .scaffold-box { background: white; border: 2px solid #E2E8F0; border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
        .scaffold-header { background: #F1F5F9; padding: 12px 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748B; font-size: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        .scaffold-item { padding: 10px 16px; border-bottom: 1px solid #F1F5F9; display: flex; flex-direction: column; }
        .scaffold-row { display: flex; justify-content: space-between; align-items: center; width: 100%; cursor: pointer; }
        .scaffold-item:last-child { border-bottom: none; }
        
        .guidance-btn { color: #94A3B8; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .guidance-btn:hover { background: #E0E7FF; color: #4338CA; }
        .guidance-btn svg { width: 16px; height: 16px; stroke-width: 3; }
        .guidance-btn.rotated { transform: rotate(180deg); color: #4338CA; }

        .guidance-content { display: none; margin-top: 8px; background: #F8FAFC; padding: 10px; border-radius: 8px; border: 1px solid #E2E8F0; font-size: 0.85rem; }
        .guidance-content.open { display: block; animation: slideDown 0.2s ease-out; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .exam-paper { background: white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-radius: 2px; font-family: 'Merriweather', serif; position: relative; overflow: hidden; border: 1px solid #E2E8F0; }
        .exam-paper::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #F97316, #3B82F6); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        @media print {
            body * { visibility: hidden; }
            #result-view, #result-view * { visibility: visible; }
            #result-view { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 0; margin: 0; overflow: visible; }
            .no-print { display: none !important; }
            .prose { font-size: 12pt; line-height: 1.6; color: black; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-slate-50">

    <header class="bg-white border-b border-gray-200 h-16 flex items-center px-6 justify-between flex-shrink-0 z-40 relative shadow-sm">
        <div class="flex items-center gap-4">
            <a href="writing-index.html" class="flex items-center gap-2 text-gray-400 hover:text-indigo-600 font-bold transition">
                <div class="p-2 bg-gray-100 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg></div>
                <span class="hidden sm:inline">Back</span>
            </a>
            <div id="mode-toggle-container" class="hidden absolute left-1/2 transform -translate-x-1/2 flex bg-gray-100 p-1 rounded-lg">
                <button onclick="switchMode('question')" id="btn-mode-question" class="px-6 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-indigo-600 transition-all">üìñ Read Question</button>
                <button onclick="switchMode('builder')" id="btn-mode-builder" class="px-6 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-indigo-600 transition-all">üèóÔ∏è Build Essay</button>
            </div>
            <div class="flex items-center gap-2">
                <div id="level-badge" class="px-4 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-500">LOADING...</div>
                <a href="#" id="level-switch-link" class="text-[10px] font-bold text-gray-400 hover:text-indigo-600 underline">Switch Level</a>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">

        <div id="view-question" class="absolute inset-0 z-30 bg-slate-50 flex flex-col items-center justify-center p-8 transition-opacity duration-300">
            <div id="initial-select-container" class="w-full max-w-md mb-10 transition-all duration-500">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 block text-center">Start here:</label>
                <div class="relative group">
                    <select id="topic-select-main" onchange="loadQuestion(this.value)" class="w-full p-4 pr-10 bg-white border-2 border-indigo-100 rounded-2xl font-bold text-xl text-gray-700 shadow-lg focus:ring-4 focus:ring-indigo-100 outline-none appearance-none cursor-pointer text-center">
                        <option value="" disabled selected>Select a Task...</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-4 flex items-center text-indigo-400"><svg class="h-6 w-6 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg></div>
                </div>
            </div>
            
            <div id="big-paper-container" class="hidden w-full max-w-5xl animate-fade">
                <div class="exam-paper p-12 md:p-16 transform transition hover:scale-[1.01] duration-500">
                    <div class="flex justify-between items-start mb-10 border-b border-gray-100 pb-6">
                        <div><h2 class="text-sm font-sans font-bold text-gray-400 uppercase tracking-widest">Part 1</h2><h1 class="text-5xl font-bold text-gray-900 mt-2 tracking-tight">Essay Task</h1></div>
                        <div class="text-right"><div class="inline-block px-4 py-2 rounded bg-gray-100 text-sm font-sans font-bold text-gray-500">45 minutes</div></div>
                    </div>
                    
                    <div id="big-content-area"></div>

                    <div class="mt-12 flex justify-center">
                        <button onclick="switchMode('builder')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold px-10 py-4 rounded-full shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-1 flex items-center gap-3">
                            <span>Start Building This Essay</span>
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-builder" class="absolute inset-0 z-20 flex hidden opacity-0 transition-opacity duration-300">
            <aside class="w-[380px] bg-white border-r border-gray-200 flex flex-col z-20 shadow-xl">
                <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8">
                    <div>
                        <label class="flex items-center gap-2 text-xs font-bold text-orange-600 uppercase tracking-wider mb-3">
                            <span class="p-1 bg-orange-100 rounded">1</span> Build Ideas
                        </label>
                        <div id="c1-point-selector" class="hidden mb-4 bg-orange-50 p-3 rounded-xl border border-orange-100">
                            <p class="text-xs font-bold text-orange-800 mb-2">Select 2 points to discuss:</p>
                            <div id="c1-checkboxes" class="space-y-2"></div>
                        </div>
                        <div id="idea-inputs-container" class="space-y-4"></div>
                    </div>
                    
                    <div>
                        <label class="flex items-center gap-2 text-xs font-bold text-blue-600 uppercase tracking-wider mb-3">
                            <span class="p-1 bg-blue-100 rounded">2</span> Add Ingredients
                        </label>
                        <div class="mb-6">
                            <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Linking Words</h3>
                            <div id="warehouse-linkers" class="flex flex-wrap gap-2"></div>
                            <button onclick="toggleExtra('linker')" id="btn-show-c1-linkers" class="hidden text-xs font-bold text-blue-600 mt-2 hover:underline">+ Show C1 Linkers</button>
                            <div id="warehouse-linkers-extra" class="hidden flex-wrap gap-2 mt-2 border-t border-dashed border-blue-200 pt-2"></div>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Grammar</h3>
                            <div id="warehouse-grammar" class="flex flex-wrap gap-2"></div>
                            <button onclick="toggleExtra('grammar')" id="btn-show-c1-grammar" class="hidden text-xs font-bold text-green-600 mt-2 hover:underline">+ Show C1 Grammar</button>
                            <div id="warehouse-grammar-extra" class="hidden flex-wrap gap-2 mt-2 border-t border-dashed border-green-200 pt-2"></div>
                        </div>
                    </div>

                    <div>
                        <label class="flex items-center gap-2 text-xs font-bold text-fuchsia-600 uppercase tracking-wider mb-3">
                            <span class="p-1 bg-fuchsia-100 rounded">3</span> Useful Vocabulary
                        </label>
                        <div id="warehouse-vocab" class="flex flex-wrap gap-2 mb-3"></div>
                        
                        <div class="flex gap-2">
                            <input type="text" id="custom-vocab-input" placeholder="Add your own word..." class="flex-1 text-xs border border-fuchsia-200 rounded px-2 py-1 focus:ring-2 focus:ring-fuchsia-200 outline-none">
                            <button onclick="addCustomVocab()" class="bg-fuchsia-100 hover:bg-fuchsia-200 text-fuchsia-700 font-bold px-3 py-1 rounded text-xs transition">+</button>
                        </div>
                    </div>

                </div>
                <div class="p-6 border-t border-gray-200 bg-slate-50">
                    <div class="flex bg-white p-1 rounded-lg mb-4 shadow-sm border border-gray-200">
                        <button onclick="setQuality('fail')" class="quality-btn flex-1 py-2 text-xs font-bold rounded text-gray-500 hover:bg-gray-50">Fail</button>
                        <button onclick="setQuality('pass')" class="quality-btn flex-1 py-2 text-xs font-bold rounded text-gray-500 hover:bg-gray-50">Pass</button>
                        <button onclick="setQuality('distinction')" class="quality-btn flex-1 py-2 text-xs font-bold rounded bg-indigo-50 text-indigo-600 shadow-sm border border-indigo-100">Distinction</button>
                    </div>
                    <button onclick="generateEssay()" class="w-full bg-slate-800 hover:bg-slate-900 text-white text-lg font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-3">
                        <span>Construct Essay</span>
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    </button>
                </div>
            </aside>

            <main class="flex-1 bg-slate-100 overflow-y-auto custom-scrollbar p-8 relative">
                <div class="max-w-4xl mx-auto pb-32">
                    <div class="exam-paper p-6 mb-8 opacity-90 hover:opacity-100 transition-opacity">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xs font-sans font-bold text-gray-400 uppercase tracking-widest">Reference Task</h2>
                            <button onclick="switchMode('question')" class="text-xs font-bold text-indigo-500 hover:text-indigo-700">View Big</button>
                        </div>
                        <p class="font-bold text-lg text-gray-800 mb-2" id="small-prompt">...</p>
                        <div class="flex flex-col gap-4 mt-3 pt-3 border-t border-gray-100">
                             <div>
                                <span class="text-[10px] uppercase font-bold text-gray-400">Notes:</span>
                                <ul class="list-disc pl-5 text-sm text-gray-700 font-medium" id="small-notes"></ul>
                             </div>
                             <div id="small-opinions-wrapper" class="hidden">
                                <span class="text-[10px] uppercase font-bold text-gray-400">Opinions:</span>
                                <div id="small-opinions-list" class="flex flex-wrap gap-2 mt-1"></div>
                             </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-extrabold text-slate-700">Construction Site</h2>
                        <span class="text-xs font-bold text-gray-400 bg-white px-3 py-1 rounded-full shadow-sm">Tap blocks to remove</span>
                    </div>

                    <div class="space-y-4">
                        <div id="scaffold-intro" class="scaffold-box animate-fade"></div>
                        <div id="essay-slots" class="space-y-4"></div>
                        <div id="scaffold-conclusion" class="scaffold-box animate-fade"></div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Added Ingredients</h3>
                        <div id="construction-ingredients" class="min-h-[100px] bg-slate-200/50 rounded-2xl border-2 border-slate-300 border-dashed p-4 flex flex-wrap gap-3 content-start transition-all"></div>
                    </div>
                </div>
            </main>
        </div>

        <div id="result-view" class="absolute inset-0 z-50 bg-slate-900/50 backdrop-blur-sm hidden flex items-center justify-center p-8">
            <div class="bg-white w-full max-w-5xl max-h-full rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="bg-indigo-900 text-white px-8 py-5 flex justify-between items-center flex-shrink-0 no-print">
                    <h3 class="font-bold text-2xl">Essay Complete</h3>
                    <div class="flex gap-2">
                        <button onclick="saveEssayToDB()" id="btn-save" class="bg-indigo-800 hover:bg-indigo-700 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2"><span>üíæ Save</span></button>
                        <button onclick="window.print()" class="bg-indigo-800 hover:bg-indigo-700 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2"><span>üñ®Ô∏è PDF</span></button>
                        <button onclick="document.getElementById('result-view').classList.add('hidden')" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg font-bold text-sm">Close</button>
                    </div>
                </div>
                <div class="bg-indigo-50 px-8 py-3 border-b border-indigo-100 flex gap-4 flex-shrink-0 items-center no-print">
                    <span class="text-xs font-bold text-indigo-400 uppercase">Analysis:</span>
                    <button onclick="toggleHighlights('grammar')" class="px-3 py-1 text-xs font-bold rounded bg-white text-green-700 border border-green-200 shadow-sm hover:bg-green-50">Grammar</button>
                    <button onclick="toggleHighlights('linker')" class="px-3 py-1 text-xs font-bold rounded bg-white text-blue-700 border border-blue-200 shadow-sm hover:bg-blue-50">Linkers</button>
                    <button onclick="toggleHighlights('vocab')" class="px-3 py-1 text-xs font-bold rounded bg-white text-fuchsia-700 border border-fuchsia-200 shadow-sm hover:bg-fuchsia-50">Vocab</button>
                </div>
                <div class="p-10 overflow-y-auto prose prose-lg prose-slate max-w-none font-serif leading-loose custom-scrollbar" id="ai-output-text"></div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";

        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const LEVEL = urlParams.get('level') || 'B2';
        let currentQuality = 'distinction';
        let allQuestions = [];
        let currentQuestion = null;
        let activeIngredients = [];
        let activePoints = {};
        let c1SelectedPoints = [];
        let lastGeneratedData = null;

        const scaffoldingData = {
            intro: [
                { title: "The Hook", desc: "Start broad. Don't state your opinion yet.", vocab: "Nowadays, In recent years, It is often argued that..." },
                { title: "The Comparison", desc: "Connect the two sides of the argument.", vocab: "However, Whereas, While, On the one hand..." },
                { title: "The Rhetorical Question", desc: "Rewrite the prompt as a question to tell the reader what you will answer.", vocab: "But is it truly better to...? Which option is superior?" }
            ],
            conclusionB2: [
                { title: "The Verdict", desc: "Answer the question directly (Yes/No/Choice).", vocab: "In conclusion, To sum up, On balance..." },
                { title: "The Evidence", desc: "Remind us why (refer to your body paragraphs).", vocab: "As discussed regarding [Point 1] and [Point 2]..." },
                { title: "Final Wish", desc: "A closing thought or recommendation.", vocab: "I strongly recommend that..., It is clear that..." }
            ],
            conclusionC1: [
                { title: "The Weighing", desc: "Acknowledge that both sides have merits.", vocab: "All things considered, Taking everything into account..." },
                { title: "The Decision", desc: "Explain why one argument is slightly stronger.", vocab: "The argument for X is more compelling because..." },
                { title: "The Implication", desc: "Future consequence if we ignore this.", vocab: "Unless we address this, the issue will worsen." }
            ]
        };

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('level-badge').innerText = LEVEL;
            if (LEVEL === 'C1') {
                document.getElementById('level-badge').classList.add('bg-purple-100', 'text-purple-700');
                document.getElementById('level-switch-link').href = "?level=B2";
                document.getElementById('level-switch-link').innerText = "Switch to B2";
            } else {
                document.getElementById('level-switch-link').href = "?level=C1";
                document.getElementById('level-switch-link').innerText = "Switch to C1";
            }
            renderScaffolding();
            await fetchTopics();
            await fetchResources();
        });

        // --- RENDERERS ---
        function renderScaffolding() {
            const renderBox = (containerId, items, label) => {
                const container = document.getElementById(containerId);
                let html = `<div class="scaffold-header"><span>${label} CHECKLIST</span></div>`;
                items.forEach((item, idx) => {
                    const uniqueId = `${containerId}-${idx}`;
                    html += `
                        <div class="scaffold-item">
                            <div class="scaffold-row" onclick="toggleGuidance('${uniqueId}', this)">
                                <span class="font-bold text-sm text-gray-700">${item.title}</span>
                                <div class="guidance-btn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div id="${uniqueId}" class="guidance-content">
                                <p class="mb-2 text-gray-600 italic">${item.desc}</p>
                                <p class="text-indigo-600 font-bold text-xs">TRY: ${item.vocab}</p>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            };
            renderBox('scaffold-intro', scaffoldingData.intro, "Introduction");
            const concData = LEVEL === 'B2' ? scaffoldingData.conclusionB2 : scaffoldingData.conclusionC1;
            renderBox('scaffold-conclusion', concData, "Conclusion");
        }

        window.toggleGuidance = function(id, row) {
            const content = document.getElementById(id);
            const btn = row.querySelector('.guidance-btn');
            if(content) content.classList.toggle('open');
            if(btn) btn.classList.toggle('rotated');
        }

        function switchMode(mode) {
            const qView = document.getElementById('view-question');
            const bView = document.getElementById('view-builder');
            const qBtn = document.getElementById('btn-mode-question');
            const bBtn = document.getElementById('btn-mode-builder');
            if (mode === 'question') {
                qView.classList.remove('hidden'); bView.classList.add('hidden'); setTimeout(() => bView.classList.remove('opacity-100'), 0); 
                qBtn.className = "px-6 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-indigo-600 transition-all";
                bBtn.className = "px-6 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-indigo-600 transition-all";
            } else {
                qView.classList.add('hidden'); bView.classList.remove('hidden'); setTimeout(() => bView.classList.add('opacity-100'), 10);
                bBtn.className = "px-6 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-indigo-600 transition-all";
                qBtn.className = "px-6 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-indigo-600 transition-all";
            }
        }

        async function fetchTopics() {
            const select = document.getElementById('topic-select-main');
            const { data, error } = await db.from('writing_exam_questions').select('*').eq('level', LEVEL);
            if (error) return console.error(error);
            allQuestions = data;
            select.innerHTML = '<option value="" disabled selected>Select a Task...</option>';
            data.forEach(q => select.innerHTML += `<option value="${q.id}">${q.title}</option>`);
        }

        async function fetchResources() {
            const { data, error } = await db.from('writing_resources').select('*').order('category', { ascending: true });
            if (error) return console.error(error);
            renderWarehouseItems(data);
        }

        function renderWarehouseItems(data) {
            const createChip = (item, color, type) => `<div onclick="addIngredient('${item.id}', '${item.content.replace(/'/g, "\\'")}', '${type}')" id="chip-${item.id}" class="px-3 py-2 rounded-lg text-xs font-bold border border-gray-200 cursor-pointer hover:scale-105 active:scale-95 transition-all shadow-sm bg-white ${color}">${item.content}</div>`;
            
            const gContainer = document.getElementById('warehouse-grammar');
            const lContainer = document.getElementById('warehouse-linkers');
            const vContainer = document.getElementById('warehouse-vocab');
            const gExtra = document.getElementById('warehouse-grammar-extra');
            const lExtra = document.getElementById('warehouse-linkers-extra');

            if(LEVEL === 'B2') { document.getElementById('btn-show-c1-linkers').classList.remove('hidden'); document.getElementById('btn-show-c1-grammar').classList.remove('hidden'); }

            data.forEach(item => {
                const isC1 = item.level === 'C1';
                
                if (item.type === 'vocabulary') {
                    if (item.level === LEVEL) {
                        // MAGENTA TEXT
                        vContainer.innerHTML += createChip(item, 'text-fuchsia-700 hover:bg-fuchsia-50', 'vocab');
                    }
                } else if (item.type === 'grammar') {
                    const target = (isC1 && LEVEL === 'B2') ? gExtra : gContainer;
                    target.innerHTML += createChip(item, 'text-green-700 hover:bg-green-50', 'grammar');
                } else if (item.type === 'linker') {
                    const target = (isC1 && LEVEL === 'B2') ? lExtra : lContainer;
                    target.innerHTML += createChip(item, 'text-blue-700 hover:bg-blue-50', 'linker');
                }
            });
        }

        // --- NEW: ADD CUSTOM VOCAB ---
        function addCustomVocab() {
            const input = document.getElementById('custom-vocab-input');
            const word = input.value.trim();
            if (!word) return;
            const customId = 'custom-vocab-' + Date.now();
            addIngredient(customId, word, 'vocab');
            input.value = '';
        }

        function loadQuestion(id) {
            currentQuestion = allQuestions.find(q => q.id === id);
            if (!currentQuestion) return;

            document.getElementById('initial-select-container').classList.add('hidden');
            document.getElementById('big-paper-container').classList.remove('hidden');
            document.getElementById('mode-toggle-container').classList.remove('hidden');

            const contentArea = document.getElementById('big-content-area');
            const scenarioText = currentQuestion.question_text;
            const promptText = currentQuestion.essay_prompt || "Write your essay.";
            const points = currentQuestion.structure_data.points || [];
            const opinions = currentQuestion.structure_data.opinions || [];

            let html = `
                <p class="text-2xl leading-relaxed text-gray-600 mb-10 font-serif">${scenarioText}</p>
                <div class="bg-slate-50 border-l-8 border-indigo-500 p-8 rounded-r-xl">
            `;

            if (LEVEL === 'C1') {
                html += `
                    <div class="flex flex-col md:flex-row gap-8 items-start mb-8">
                        <div class="bg-white border border-gray-200 shadow-sm p-6 inline-block min-w-[45%] -rotate-1 flex-1">
                            <p class="text-xs font-sans font-bold text-gray-400 mb-4 uppercase tracking-wider border-b border-gray-100 pb-2">Notes</p>
                            <ul class="list-disc pl-6 space-y-3 font-medium text-xl text-gray-700">
                                ${points.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                        </div>
                `;
                if (opinions.length > 0) {
                    html += `
                        <div class="flex-1 w-full">
                            <p class="text-xs font-sans font-bold text-gray-400 mb-4 uppercase tracking-wider">Opinions expressed in the discussion:</p>
                            <div class="space-y-4">
                                ${opinions.map(op => `<div class="bg-white border-l-4 border-gray-300 p-3 text-sm italic text-gray-600 shadow-sm">"${op.replace(/"/g, '')}"</div>`).join('')}
                            </div>
                        </div>
                    `;
                }
                html += `</div>
                    <div class="font-bold text-xl text-gray-800 mt-6 font-sans border-t border-indigo-100 pt-6">
                        ${promptText}
                    </div>
                `;
            } else {
                html += `
                    <p class="font-bold text-3xl text-gray-800 mb-8 font-sans">${promptText}</p>
                    <div class="bg-white border border-gray-200 shadow-sm p-6 inline-block min-w-[50%] -rotate-1">
                        <p class="text-xs font-sans font-bold text-gray-400 mb-4 uppercase tracking-wider border-b border-gray-100 pb-2">Notes</p>
                        <ul class="list-disc pl-6 space-y-3 font-medium text-xl text-gray-700">
                            ${points.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            html += `</div>`;
            contentArea.innerHTML = html;

            // FIXED: Use innerHTML here
            document.getElementById('small-prompt').innerHTML = promptText;
            document.getElementById('small-notes').innerHTML = points.map(p => `<li>${p}</li>`).join('');
            
            if (LEVEL === 'C1' && opinions.length > 0) {
                document.getElementById('small-opinions-wrapper').classList.remove('hidden');
                document.getElementById('small-opinions-list').innerHTML = opinions.map(op => `<span class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded border border-gray-200 italic">"${op.replace(/"/g, '')}"</span>`).join('');
            } else {
                document.getElementById('small-opinions-wrapper').classList.add('hidden');
            }

            setupIdeaSystem(points);
            activeIngredients = [];
            updateIngredientDisplay();
        }

        // --- IDEA & BLOCK LOGIC ---
        function setupIdeaSystem(points) {
            const inputContainer = document.getElementById('idea-inputs-container');
            const slotContainer = document.getElementById('essay-slots');
            const c1Selector = document.getElementById('c1-point-selector');
            const c1Checkboxes = document.getElementById('c1-checkboxes');
            inputContainer.innerHTML = ''; slotContainer.innerHTML = ''; activePoints = {}; c1SelectedPoints = [];

            if (LEVEL === 'B2') {
                c1Selector.classList.add('hidden');
                points.forEach((pointName, index) => createInputAndSlot(pointName, index));
            } else {
                c1Selector.classList.remove('hidden');
                c1Checkboxes.innerHTML = '';
                points.forEach((pointName, index) => {
                    c1Checkboxes.innerHTML += `<label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-orange-100 transition"><input type="checkbox" value="${pointName}" onchange="handleC1Selection(this, ${index})" class="c1-checkbox w-5 h-5 text-orange-500 rounded focus:ring-orange-400"><div class="text-sm font-bold text-gray-600">${pointName}</div></label>`;
                });
            }
        }

        function createInputAndSlot(pointName, index) {
            const inputContainer = document.getElementById('idea-inputs-container');
            const slotContainer = document.getElementById('essay-slots');
            inputContainer.innerHTML += `<div id="wrapper-input-${index}" class="bg-orange-50 p-3 rounded-xl border border-orange-100 transition-all animate-fade"><div class="text-[10px] font-bold text-orange-400 uppercase mb-1">${pointName}</div><div class="flex gap-2"><input type="text" id="input-${index}" placeholder="Type idea..." class="flex-1 bg-white border border-orange-200 rounded-lg px-2 py-1 text-sm focus:ring-2 focus:ring-orange-400 outline-none"><button onclick="commitIdea(${index}, '${pointName}')" class="bg-orange-500 hover:bg-orange-600 text-white rounded-lg px-3 font-bold">‚úî</button></div></div>`;
            slotContainer.innerHTML += `<div id="slot-${index}" class="min-h-[80px] bg-white border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center p-4 transition-all animate-fade"><span class="text-gray-400 font-bold text-xs uppercase tracking-wide">Slot: ${pointName}</span></div>`;
        }

        function handleC1Selection(checkbox, index) {
            const pointName = checkbox.value;
            if (checkbox.checked) {
                if (c1SelectedPoints.length >= 2) { checkbox.checked = false; return alert("You can only select 2 points for C1."); }
                c1SelectedPoints.push(pointName);
                createInputAndSlot(pointName, index);
            } else {
                c1SelectedPoints = c1SelectedPoints.filter(p => p !== pointName);
                const wrapper = document.getElementById(`wrapper-input-${index}`);
                const slot = document.getElementById(`slot-${index}`);
                if(wrapper) wrapper.remove();
                if(slot) slot.remove();
                delete activePoints[pointName];
            }
        }

        function commitIdea(index, pointName) {
            const text = document.getElementById(`input-${index}`).value.trim();
            if (!text) return;
            activePoints[pointName] = text;
            document.getElementById(`wrapper-input-${index}`).classList.add('hidden');
            const slot = document.getElementById(`slot-${index}`);
            slot.className = "builder-block block-idea p-4 rounded-xl animate-fade relative group cursor-default";
            slot.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[10px] font-bold opacity-75 uppercase">${pointName}</div>
                    <button onclick="editIdea(${index}, '${pointName}')" class="text-[10px] font-bold uppercase underline opacity-50 hover:opacity-100">Edit</button>
                </div>
                <div class="font-bold text-lg leading-tight mb-4 border-b border-orange-200/50 pb-2">"${text}"</div>
                <div class="space-y-2 opacity-80">
                    <div class="flex gap-2 items-center text-xs font-bold text-orange-800/60 bg-white/40 p-2 rounded">
                        <span class="w-4 h-4 flex items-center justify-center bg-orange-200 rounded-full text-[9px]">2</span>
                        <span>EXPLANATION: <span class="font-normal italic">Why is this true?</span></span>
                    </div>
                    <div class="flex gap-2 items-center text-xs font-bold text-orange-800/60 bg-white/40 p-2 rounded">
                        <span class="w-4 h-4 flex items-center justify-center bg-orange-200 rounded-full text-[9px]">3</span>
                        <span>EVIDENCE: <span class="font-normal italic">Give an example.</span></span>
                    </div>
                </div>
            `;
        }

        function editIdea(index, pointName) {
            delete activePoints[pointName];
            document.getElementById(`wrapper-input-${index}`).classList.remove('hidden');
            const slot = document.getElementById(`slot-${index}`);
            slot.className = "min-h-[80px] bg-white border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center p-4 transition-all";
            slot.innerHTML = `<span class="text-gray-400 font-bold text-xs uppercase tracking-wide">Slot: ${pointName}</span>`;
            document.getElementById(`input-${index}`).focus();
        }

        function addIngredient(id, content, type) {
            if (activeIngredients.find(i => i.id === id)) return;
            activeIngredients.push({ id, content, type });
            updateIngredientDisplay();
        }

        function removeIngredient(id) {
            activeIngredients = activeIngredients.filter(i => i.id !== id);
            updateIngredientDisplay();
        }

        function updateIngredientDisplay() {
            const container = document.getElementById('construction-ingredients');
            document.querySelectorAll('[id^="chip-"]').forEach(el => el.classList.remove('used-item'));
            activeIngredients.forEach(i => { const chip = document.getElementById(`chip-${i.id}`); if(chip) chip.classList.add('used-item'); });
            container.innerHTML = '';
            if (activeIngredients.length === 0) {
                container.innerHTML = `<div class="w-full text-center text-gray-400 font-medium py-4 text-sm" id="empty-msg">Tap ingredients on the left to add them here.</div>`;
                return;
            }
            activeIngredients.forEach(item => {
                let cssClass = 'block-linker';
                if(item.type === 'grammar') cssClass = 'block-grammar';
                if(item.type === 'vocab') cssClass = 'block-vocab'; // MAGENTA CLASS
                container.innerHTML += `<div onclick="removeIngredient('${item.id}')" class="builder-block ${cssClass} px-3 py-2 rounded-lg font-bold text-xs animate-fade flex items-center gap-2 mb-2 mr-2"><span>${item.content}</span><span class="opacity-50 hover:opacity-100">‚úï</span></div>`;
            });
        }

        function toggleExtra(type) {
            const id = type === 'grammar' ? 'warehouse-grammar-extra' : 'warehouse-linkers-extra';
            document.getElementById(id).classList.toggle('hidden'); document.getElementById(id).classList.toggle('flex');
        }

        function setQuality(q) {
            currentQuality = q;
            document.querySelectorAll('.quality-btn').forEach(b => {
                b.classList.remove('bg-indigo-50', 'text-indigo-600', 'shadow-sm', 'border-indigo-100');
                b.classList.add('text-gray-500');
            });
            event.target.classList.remove('text-gray-500');
            event.target.classList.add('bg-indigo-50', 'text-indigo-600', 'shadow-sm', 'border-indigo-100');
        }

        async function generateEssay() {
            if (!currentQuestion) return alert("Please select a task.");
            const pointsData = Object.keys(activePoints).map(key => ({ topic: key, argument: activePoints[key] }));
            if (LEVEL === 'C1' && pointsData.length !== 2) return alert("For C1, you must build exactly 2 idea blocks.");
            
            const grammarList = activeIngredients.filter(i => i.type === 'grammar').map(i => i.content);
            const linkerList = activeIngredients.filter(i => i.type === 'linker').map(i => i.content);
            const vocabList = activeIngredients.filter(i => i.type === 'vocab').map(i => i.content);

            document.getElementById('result-view').classList.remove('hidden');
            const outputDiv = document.getElementById('ai-output-text');
            outputDiv.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-gray-400 gap-4"><svg class="w-16 h-16 animate-spin text-indigo-300" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="font-sans font-bold text-2xl animate-pulse text-indigo-900">Constructing Essay...</span></div>`;

            try {
                const response = await fetch('/.netlify/functions/generate_essay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        level: LEVEL, 
                        quality: currentQuality, 
                        topic: currentQuestion.topic, 
                        points_data: pointsData, 
                        grammar: grammarList, 
                        vocabulary: vocabList, 
                        linkers: linkerList 
                    })
                });
                
                if (!response.ok) {
                   const errorText = await response.text();
                   throw new Error(errorText || "Network error");
                }
                
                const aiData = await response.json(); 
                
                lastGeneratedData = {
                    level: LEVEL,
                    topic_title: currentQuestion.title,
                    essay_text: aiData.essay_text,
                    analysis_json: aiData.analysis
                };

                let formattedText = aiData.essay_text.replace(/\n/g, '<br>');
                
                // Highlight Logic (Updated Colors)
                aiData.analysis.forEach(item => {
                    const regex = new RegExp(`(${item.phrase.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                    let className = 'highlight-linker';
                    if (item.type === 'grammar') className = 'highlight-grammar';
                    if (item.type === 'vocab' || item.type === 'vocabulary') className = 'highlight-vocab';
                    
                    formattedText = formattedText.replace(regex, `<span class="${className}" style="background-color: transparent; border-bottom: none;" title="${item.label}: ${item.explanation}">$1</span>`);
                });
                outputDiv.innerHTML = formattedText;
            } catch (error) {
                outputDiv.innerHTML = `<div class="p-6 bg-red-50 text-red-600 rounded-xl font-bold">Error: ${error.message}</div>`;
            }
        }

        async function saveEssayToDB() {
            if (!lastGeneratedData) return;
            const btn = document.getElementById('btn-save');
            btn.innerHTML = `<span class="animate-spin">‚è≥</span> Saving...`;
            const { error } = await db.from('saved_essays').insert([lastGeneratedData]);
            if (error) {
                alert("Error saving: " + error.message);
                btn.innerHTML = `<span>üíæ Save</span>`;
            } else {
                btn.innerHTML = `<span>‚úÖ Saved</span>`;
                btn.classList.add('bg-green-600', 'hover:bg-green-600');
                setTimeout(() => btn.innerHTML = `<span>üíæ Save</span>`, 3000);
            }
        }

        // --- HIGHLIGHT TOGGLES (MAGENTA UPDATE) ---
        window.toggleHighlights = function(type) {
            const selector = type === 'grammar' ? '.highlight-grammar' : (type === 'vocab' ? '.highlight-vocab' : '.highlight-linker');
            
            // COLORS:
            // Grammar: Green-50 / Green-600
            // Linker: Blue-50 / Blue-600
            // Vocab: Fuchsia-50 / Fuchsia-700
            
            const color = type === 'grammar' ? '#d1fae5' : (type === 'vocab' ? '#FDF4FF' : '#dbeafe');
            const border = type === 'grammar' ? '2px solid #059669' : (type === 'vocab' ? '2px solid #C026D3' : '2px solid #2563eb');
            
            document.querySelectorAll(selector).forEach(el => {
                el.style.backgroundColor = el.style.backgroundColor === 'transparent' ? color : 'transparent';
                el.style.borderBottom = el.style.borderBottom === 'none' ? border : 'none';
            });
        };
    </script>
</body>
</html>