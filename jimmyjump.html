<!DOCTYPE html>
<html>
<head>
    <title>Stickman Pizza Run: The Final Version</title>
    <style>
        body { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            background-color: #222; 
            margin: 0; 
            font-family: sans-serif;
            overflow: hidden; 
        }
        
        #gameContainer {
            position: relative;
            border: 5px solid white;
            box-shadow: 0 0 30px black;
            width: 800px;
            height: 450px;
        }

        canvas { 
            display: block;
            background-color: #87CEEB; 
        }

        /* --- OVERLAYS (Menu, Win, Lose) --- */
        .overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); /* Dark see-through background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            display: none; /* Hidden by default */
        }

        /* Show Menu by default via inline style in HTML, 
           but CSS class keeps others hidden */

        button {
            padding: 15px 40px;
            font-size: 24px;
            background-color: #ff9900; 
            border: 2px solid white;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
            transition: transform 0.1s;
            font-family: sans-serif;
        }
        button:hover { background-color: #ffcc00; transform: scale(1.05); }

        /* Image Styling in Overlays */
        .overlay-img {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
        }
        
        h1 { margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        p { font-size: 18px; color: #ddd; }

    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="450"></canvas>
    
    <div id="menuOverlay" class="overlay" style="display:flex;"> <h1 style="color: #87CEEB;">STICKMAN PIZZA RUN</h1>
        <p>Use Arrows to Move, Space to Jump</p>
        <button id="startBtn">START GAME</button>
    </div>

    <div id="gameOverOverlay" class="overlay">
        <h1 style="color: #ff4444;">YOU DIED!</h1>
        <img class="overlay-img" src="images/dead_jimmy.png" alt="Dead Jimmy">
        <div id="deathMessage">Try harder next time!</div>
        <button id="restartBtn">TRY AGAIN</button>
    </div>

    <div id="winOverlay" class="overlay">
        <h1 style="color: #FFD700;">DELICIOUS VICTORY!</h1>
        <img class="overlay-img" src="images/win_pizza.png" alt="Pizza">
        <p>You reached the Pizzeria safely!</p>
        <button id="winRestartBtn">EAT & RUN AGAIN</button>
    </div>
</div>

<audio id="bgMusic" src="sounds/background.mp3" loop></audio> 
<audio id="sfxJump" src="sounds/jump.mp3"></audio>
<audio id="sfxWin" src="sounds/win.mp3"></audio>
<audio id="sfxHit" src="sounds/hit.mp3"></audio>
<audio id="sfxEaten" src="sounds/eaten.mp3"></audio>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const menuOverlay = document.getElementById('menuOverlay');
    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const winOverlay = document.getElementById('winOverlay'); // New Win Overlay
    
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const winRestartBtn = document.getElementById('winRestartBtn'); // New Win Button
    
    const deathMsg = document.getElementById('deathMessage');

    // --- AUDIO ---
    const sounds = {
        bg: document.getElementById('bgMusic'),
        jump: document.getElementById('sfxJump'),
        win: document.getElementById('sfxWin'),
        hit: document.getElementById('sfxHit'),
        eaten: document.getElementById('sfxEaten')
    };
    sounds.bg.volume = 0.3; 

    // --- IMAGES ---
    const imgHero1 = new Image(); imgHero1.src = 'images/hero_run1.png';
    const imgHero2 = new Image(); imgHero2.src = 'images/hero_run2.png';
    const imgMonster = new Image(); imgMonster.src = 'images/monster.png';
    const imgPizzeria = new Image(); imgPizzeria.src = 'images/pizzeria.png';
    
    // We don't need imgWin in canvas anymore, it's in the HTML overlay now!

    // OBSTACLE IMAGES
    const obsImages = {
        1: new Image(),
        2: new Image(),
        3: new Image(),
        4: new Image()
    };
    obsImages[1].src = 'images/obstacle_1.png';
    obsImages[2].src = 'images/obstacle_2.png';
    obsImages[3].src = 'images/obstacle_3.png';
    obsImages[4].src = 'images/obstacle_4.png';

    // --- GAME VARIABLES ---
    let currentState = "MENU"; 
    let frameCount = 0;
    
    let hero = { x: 200, y: 300, w: 60, h: 100, vy: 0, speed: 5, grounded: false };
    let monster = { x: -500, y: 280, speed: 2.8 }; 
    let pizzeriaX = 4500; 

    let obstacles = []; // Populated in resetGame

    // --- CONTROLS ---
    let keys = { right: false, left: false, up: false };

    document.addEventListener('keydown', (e) => {
        if (e.code === 'ArrowRight') keys.right = true;
        if (e.code === 'ArrowLeft') keys.left = true;
        if (e.code === 'Space') keys.up = true;
    });
    document.addEventListener('keyup', (e) => {
        if (e.code === 'ArrowRight') keys.right = false;
        if (e.code === 'ArrowLeft') keys.left = false;
        if (e.code === 'Space') keys.up = false;
    });

    // --- BUTTON LISTENERS ---
    startBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', startGame);
    winRestartBtn.addEventListener('click', startGame);

    function startGame() {
        resetGame();
        currentState = "PLAYING";
        
        // Hide ALL overlays
        menuOverlay.style.display = "none";
        gameOverOverlay.style.display = "none"; 
        winOverlay.style.display = "none"; 
        
        sounds.bg.currentTime = 0;
        sounds.bg.play().catch(e => console.log("Audio play blocked"));
    }

    // --- LOGIC ---

    function resetGame() {
        hero.x = 200; 
        hero.y = 300; 
        hero.vy = 0;
        monster.x = -500; 
        
        // Reset Obstacle Positions
        obstacles = [
            {x: 800,  y: 360, w: 40, h: 40, type: 1},
            {x: 1300, y: 330, w: 40, h: 70, type: 2},
            {x: 1800, y: 360, w: 40, h: 40, type: 3},
            {x: 2300, y: 340, w: 50, h: 60, type: 4},
            {x: 2800, y: 360, w: 40, h: 40, type: 1},
            {x: 3300, y: 330, w: 40, h: 70, type: 2},
            {x: 3800, y: 360, w: 40, h: 40, type: 3},
            {x: 4200, y: 320, w: 50, h: 80, type: 4}
        ];
    }

    function update() {
        if (currentState !== "PLAYING") return;

        // Move Hero
        if (keys.right) hero.x += hero.speed;
        if (keys.left && hero.x > 0) hero.x -= hero.speed;

        // Jump
        if (keys.up && hero.grounded) {
            hero.vy = -18; 
            hero.grounded = false;
            sounds.jump.currentTime = 0; 
            sounds.jump.play();
        }

        // Physics
        hero.vy += 0.8;
        hero.y += hero.vy;

        if (hero.y > 300) {
            hero.y = 300;
            hero.vy = 0;
            hero.grounded = true;
        }

        // Monster Movement & Collision
        monster.x += monster.speed;
        if (monster.x + 100 > hero.x) {
            gameOver("monster"); 
        }

        // Obstacle Collision Check
        obstacles.forEach(obs => {
            if (
                hero.x + 10 < obs.x + obs.w &&
                hero.x + hero.w - 10 > obs.x &&
                hero.y < obs.y + obs.h &&
                hero.y + hero.h > obs.y
            ) {
                gameOver("obstacle"); 
            }
        });

        // Win Condition
        if (hero.x > pizzeriaX) {
            gameWin();
        }
        frameCount++;
    }

    function gameOver(reason) {
        currentState = "GAMEOVER";
        sounds.bg.pause();

        // Play sound & Set text based on death type
        if (reason === "monster") {
            sounds.eaten.play();
            deathMsg.innerText = "The monster ate you!";
        } else {
            sounds.hit.play();
            deathMsg.innerText = "You hit an obstacle!";
        }

        // Show Death Screen
        gameOverOverlay.style.display = "flex";
    }

    function gameWin() {
        currentState = "WIN";
        sounds.bg.pause();
        sounds.win.play();
        
        // Show Win Screen
        winOverlay.style.display = "flex";
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Camera Logic
        let cameraX = 0;
        // Camera stays active on Win/Lose so we see where we ended
        if (currentState !== "MENU") {
            cameraX = hero.x - 200;
            if (cameraX < 0) cameraX = 0;
        }

        ctx.save();
        ctx.translate(-cameraX, 0);

        // Ground
        ctx.fillStyle = "#4a3c31";
        ctx.fillRect(0, 400, 6000, 50); 
        ctx.fillStyle = "#4CAF50";
        ctx.fillRect(0, 400, 6000, 10);

        // Pizzeria
        ctx.drawImage(imgPizzeria, pizzeriaX, 150, 300, 250);

        // Monster
        ctx.drawImage(imgMonster, monster.x, monster.y, 150, 150);

        // Obstacles
        obstacles.forEach(obs => {
            let imageToUse = obsImages[obs.type]; 
            ctx.drawImage(imageToUse, obs.x, obs.y, obs.w, obs.h);
        });

        // Hero
        // Only draw hero if playing (or if you want him visible on win/loss behind overlay)
        // Let's keep him visible
        let currentImg = imgHero1;
        if (keys.right || keys.left) {
             if (Math.floor(frameCount / 10) % 2 === 0) currentImg = imgHero2;
        }
        if (!hero.grounded) currentImg = imgHero1;
        ctx.drawImage(currentImg, hero.x, hero.y, hero.w, hero.h);

        ctx.restore();
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    loop();

</script>
</body>
</html>