<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listening Part 2 (Sentence Completion)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style type="text/tailwindcss">
        /* --- CORE THEME --- */
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; min-height: 100vh; }
        
        #app-container { 
            @apply w-full max-w-6xl mx-auto mt-12 mb-12; 
            background-color: white; 
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08); 
            border-radius: 24px; 
            min-height: 750px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- LEVEL BUTTONS --- */
        .level-select-btn { 
            font-size: 3.5rem; 
            padding: 2.5rem; 
            width: 100%; 
            @apply font-black rounded-[2rem] transition-all duration-300 transform border-4 cursor-pointer shadow-xl opacity-80 filter grayscale; 
        }
        .level-select-btn.active { 
            transform: scale(1.02) translateY(-5px); 
            opacity: 1; 
            filter: grayscale(0); 
            z-index: 10; 
            box-shadow: 0 20px 30px rgba(0,0,0,0.15);
        }
        .level-select-btn:hover { 
            transform: scale(1.02) translateY(-5px); 
            opacity: 1; 
            filter: grayscale(0); 
        }

        /* Gradient Styles */
        .btn-b2-style { background: linear-gradient(135deg, #4F46E5 0%, #818CF8 100%); color: white; border-color: #C7D2FE; }
        .btn-c1-style { background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%); color: white; border-color: #FFE082; }
        .btn-c2-style { background: linear-gradient(135deg, #10B981 0%, #34D399 100%); color: white; border-color: #A7F3D0; }

        /* --- MODE BUTTONS --- */
        .mode-select-btn { 
            @apply flex flex-col items-center justify-center p-8 rounded-[1.5rem] border-4 border-gray-100 bg-white text-gray-400 transition-all duration-200 cursor-pointer shadow-sm hover:border-indigo-200 hover:bg-indigo-50 hover:text-indigo-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:border-gray-100 disabled:hover:bg-white; 
            min-height: 220px; 
        }
        .mode-select-btn.active { 
            @apply border-indigo-500 bg-indigo-50 text-indigo-700 shadow-xl ring-4 ring-indigo-100; 
            transform: translateY(-4px);
        }

        /* --- TYPOGRAPHY & INPUTS --- */
        .gap-input { 
            @apply inline-block border-b-2 border-indigo-300 px-2 mx-1 font-bold text-indigo-900 focus:outline-none focus:border-indigo-600 focus:bg-indigo-50 transition-colors; 
            background-color: transparent; 
            min-width: 120px; 
            text-align: center; 
        }
        .input-correct { @apply border-green-500 bg-green-100 text-green-800; }
        .input-wrong { @apply border-red-500 bg-red-100 text-red-800 line-through decoration-2 decoration-red-500; }
        
        .gap-box { 
            @apply inline-flex items-center justify-center border-b-2 border-gray-300 font-bold text-gray-400 px-3 mx-1 transition-all duration-200 select-none rounded-t; 
            min-width: 3rem; cursor: pointer; background-color: rgba(0,0,0,0.02); 
        }
        .gap-box:hover { @apply bg-yellow-100 text-yellow-700 border-yellow-400; }
        .gap-box.revealed { @apply border-green-500 text-green-700 bg-green-100; }

        .correction-badge { @apply inline-block ml-2 px-2 py-0.5 rounded bg-red-100 text-red-700 border border-red-200 text-xs font-bold uppercase tracking-wide; }
        
        /* --- AUDIO PLAYER & SCRIPT --- */
        audio { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); border-radius: 9999px; }
        
        .script-line { @apply cursor-pointer hover:bg-yellow-200 hover:text-gray-900 transition-colors duration-200 px-1 rounded inline-block mb-1; }

        /* --- UI UTILS --- */
        .app-btn { @apply px-10 py-5 font-black text-xl rounded-2xl shadow-xl transition-all duration-200 transform hover:scale-[1.02] active:scale-95; }
        .btn-action { @apply px-6 py-3 font-bold text-white rounded-xl shadow-md transition hover:opacity-90 active:scale-95 text-sm uppercase tracking-wide; }
        
        /* FIXED: Removed 'group' from @apply here */
        .list-item-btn { @apply w-full text-left p-5 bg-white hover:bg-indigo-50 border border-gray-100 hover:border-indigo-200 rounded-xl transition duration-150 font-bold text-lg text-gray-700 hover:text-indigo-700 flex justify-between items-center shadow-sm; }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <a id="main-menu-btn" href="index.html" class="absolute top-8 left-8 flex items-center gap-2 text-gray-500 hover:text-indigo-600 font-bold transition z-50 group">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform group-hover:-translate-x-1 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
        <span>Back to Menu</span>
    </a>

    <div id="app-container">
        
        <div class="bg-white p-8 border-b border-gray-100 flex justify-between items-center">
            <h1 class="text-3xl font-black text-gray-900 tracking-tight">Listening <span class="text-indigo-600">Part 2</span></h1>
            <button onclick="app.showDashboard()" id="nav-menu-btn" class="hidden px-5 py-2.5 text-sm font-bold text-gray-500 hover:text-indigo-600 bg-gray-50 hover:bg-indigo-50 rounded-lg transition">
                Change Settings
            </button>
        </div>

        <div id="screen-dashboard" class="flex-1 p-12 flex flex-col gap-10 w-full overflow-y-auto">
            
            <div>
                <h3 class="text-lg font-bold mb-6 text-center text-gray-400 uppercase tracking-widest">1. Select Level</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full px-4">
                    <button onclick="app.selectLevel('B2')" id="btn-b2" class="level-select-btn btn-b2-style">B2</button>
                    <button onclick="app.selectLevel('C1')" id="btn-c1" class="level-select-btn btn-c1-style">C1</button>
                    <button onclick="app.selectLevel('C2')" id="btn-c2" class="level-select-btn btn-c2-style">C2</button>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-bold mb-6 text-center text-gray-400 uppercase tracking-widest">2. Select Mode</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full px-4">
                    <button onclick="app.selectMode('classroom')" id="mode-class" disabled class="mode-select-btn">
                        <span class="text-5xl mb-4 grayscale opacity-80">üè´</span>
                        <span class="text-2xl font-bold text-gray-800">Classroom Mode</span>
                        <span class="text-sm mt-2 text-gray-400 font-medium">Click-to-reveal gaps. <br>Script control included.</span>
                    </button>
                    <button onclick="app.selectMode('exam')" id="mode-exam" disabled class="mode-select-btn">
                        <span class="text-5xl mb-4 grayscale opacity-80">üìù</span>
                        <span class="text-2xl font-bold text-gray-800">Exam Mode</span>
                        <span class="text-sm mt-2 text-gray-400 font-medium">Type answers manually. <br>Script locked until submission.</span>
                    </button>
                </div>
            </div>

            <div class="mt-8 flex flex-col items-center gap-4 pb-8">
                <button onclick="app.startActivity()" id="start-btn" disabled class="app-btn bg-indigo-600 text-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-indigo-700 shadow-indigo-200">
                    Start Activity ‚Üí
                </button>
                <button onclick="app.showList()" id="list-btn" disabled class="text-gray-400 font-bold hover:text-indigo-600 disabled:opacity-0 transition text-sm">
                    or Select from Library
                </button>
            </div>
            
            <p id="data-loading-status" class="text-center text-xs text-gray-300 font-mono mt-auto">System: Connecting...</p>
        </div>

        <div id="screen-list" class="hidden flex-1 p-10 flex flex-col w-full bg-gray-50/50">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-3xl font-bold text-gray-800">Library</h2>
                <span id="list-badge" class="bg-indigo-600 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-lg shadow-indigo-200"></span>
            </div>
            <div id="titles-container" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
            <button onclick="app.showDashboard()" class="mt-8 self-start px-6 py-3 bg-white border border-gray-200 font-bold rounded-xl hover:bg-gray-50 text-gray-600 shadow-sm">‚Üê Back</button>
        </div>

        <div id="screen-activity" class="hidden flex-1 flex flex-col relative bg-white h-full overflow-hidden">
            
            <div class="bg-white border-b border-gray-100 z-30 shadow-[0_4px_20px_rgba(0,0,0,0.03)]">
                <div class="p-5 max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h2 id="text-title" class="text-xl font-bold text-gray-800 truncate pr-4"></h2>
                        <span id="activity-level-badge" class="text-xs font-black bg-gray-100 text-gray-500 px-3 py-1 rounded-md tracking-widest"></span>
                    </div>
                    
                    <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-2xl border border-gray-100">
                        <audio id="main-audio" controls class="w-full h-10 outline-none"></audio>
                    </div>

                    <div id="classroom-script-controls" class="hidden flex justify-end mt-2">
                         <button onclick="app.toggleScript()" class="text-xs font-bold text-indigo-500 hover:text-indigo-700 flex items-center gap-1 transition-colors">
                            <span id="script-btn-text">Show Transcript</span>
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                </div>
                
                <div id="script-panel" class="hidden bg-yellow-50/80 border-b border-yellow-100 max-h-56 overflow-y-auto p-6 text-gray-700 text-lg leading-relaxed transition-all backdrop-blur-sm">
                    </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 md:p-10 bg-[#FAFAFA]">
                <div class="max-w-4xl mx-auto bg-white p-8 md:p-12 rounded-2xl shadow-sm border border-gray-100 min-h-[400px]">
                    <h3 class="text-xs font-bold text-gray-400 mb-8 uppercase tracking-widest border-b border-gray-100 pb-4">Complete the sentences</h3>
                    <div id="questions-display" class="text-xl leading-loose text-gray-700"></div>
                </div>
            </div>

            <div class="p-6 bg-white border-t border-gray-100">
                <div class="max-w-4xl mx-auto flex flex-wrap justify-between items-center gap-4">
                    
                    <div id="result-bar" class="hidden px-5 py-2.5 rounded-lg bg-gray-50 border border-gray-200 font-bold text-gray-600">
                        Score: <span id="score-display" class="text-indigo-600">0/0</span>
                    </div>
                    
                    <div class="flex gap-3 ml-auto">
                        <div id="classroom-actions" class="hidden flex gap-3">
                             <button onclick="app.revealAll()" class="btn-action bg-purple-600 hover:bg-purple-700">Reveal All</button>
                             <button onclick="app.resetCurrent()" class="btn-action bg-gray-400 hover:bg-gray-500">Reset</button>
                        </div>

                        <div id="exam-actions" class="hidden flex gap-3">
                            <button onclick="app.checkExamAnswers()" id="btn-check" class="btn-action bg-green-500 hover:bg-green-600 shadow-green-200">Submit</button>
                            <button onclick="app.resetCurrent()" id="btn-retry" class="hidden btn-action bg-amber-500 hover:bg-amber-600">Retry</button>
                        </div>

                        <button onclick="app.nextText()" class="btn-action bg-indigo-600 hover:bg-indigo-700 ml-2 shadow-indigo-200">Next ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";

        const TABLE_NAME = "listening_part2"; 

        // Mock Data
        const MOCK_DATA = [
            {
                id: 1, level: "B2", title: "Volcano Photography", 
                audio_url: "https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.wav",
                questions: "The photographer says that [1] is the most important quality. She found that [2] animals were harder to photograph.",
                answers: { "1": ["patience"], "2": ["small", "tiny"] },
                script: [
                    { time: 0, text: "Hi everyone." },
                    { time: 2, text: "Many people think you need expensive cameras, but patience is the only thing that matters." },
                    { time: 8, text: "Honestly, the tiny beetles were much more difficult to capture than the big cats." }
                ]
            }
        ];

        const app = {
            supabase: null,
            data: [],
            filteredData: [],
            state: { level: null, mode: null, currentIndex: 0 },
            isRandom: false,
            isScriptOpen: false,

            init: async function() {
                if (SUPABASE_URL !== "YOUR_SB_URL" && typeof supabase !== 'undefined') {
                    this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    await this.loadData();
                } else {
                    this.data = MOCK_DATA;
                    this.updateStatus("Demo Mode");
                }
            },

            loadData: async function() {
                this.updateStatus("Loading...");
                try {
                    let { data, error } = await this.supabase.from(TABLE_NAME).select('*');
                    if (error) throw error;
                    this.data = data;
                    this.updateStatus("Connected");
                } catch (e) {
                    console.error(e);
                    this.data = MOCK_DATA;
                    this.updateStatus("Offline Mode");
                }
            },

            updateStatus: function(msg) {
                document.getElementById('data-loading-status').innerText = `System: ${msg}`;
            },

            // --- NAVIGATION ---
            selectLevel: function(lvl) {
                this.state.level = lvl;
                this.updateUI();
            },

            selectMode: function(m) {
                this.state.mode = m;
                this.updateUI();
            },

            updateUI: function() {
                // Levels
                ['b2','c1','c2'].forEach(l => {
                    const btn = document.getElementById(`btn-${l}`);
                    btn.classList.remove('active');
                    if(this.state.level && l === this.state.level.toLowerCase()) btn.classList.add('active');
                });
                
                // Modes
                const hasLevel = !!this.state.level;
                document.querySelectorAll('.mode-select-btn').forEach(btn => btn.disabled = !hasLevel);
                
                ['class','exam'].forEach(md => {
                    const btn = document.getElementById(`mode-${md}`);
                    btn.classList.remove('active');
                    const modeKey = md === 'class' ? 'classroom' : 'exam';
                    if(this.state.mode === modeKey) btn.classList.add('active');
                });

                // Start
                const canStart = this.state.level && this.state.mode;
                document.getElementById('start-btn').disabled = !canStart;
                document.getElementById('list-btn').disabled = !canStart;
            },

            // --- START ---
            startActivity: function() {
                this.isRandom = true;
                this.filterData();
                this.startEngine();
            },

            showList: function() {
                this.filterData();
                this.isRandom = false;
                const container = document.getElementById('titles-container');
                container.innerHTML = '';
                document.getElementById('list-badge').innerText = this.state.level;

                this.filteredData.forEach((item, index) => {
                    const btn = document.createElement('button');
                    // FIXED: group added manually here, not in CSS
                    btn.className = 'list-item-btn group'; 
                    btn.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="bg-gray-100 text-gray-500 font-bold px-2 py-1 rounded text-xs">#${index+1}</span>
                            <span>${item.title}</span>
                        </div>
                        <span class="text-indigo-600 opacity-0 group-hover:opacity-100 transition">Select ‚Üí</span>
                    `;
                    btn.onclick = () => {
                        this.currentIndex = index;
                        this.startEngine();
                    };
                    container.appendChild(btn);
                });
                this.switchScreen('screen-list');
            },

            filterData: function() {
                this.filteredData = this.data.filter(i => i.level === this.state.level);
                if (!this.filteredData.length) { alert("No data for this level"); return; }
                if (this.isRandom) {
                    this.filteredData.sort(() => Math.random() - 0.5);
                    this.currentIndex = 0;
                }
            },

            startEngine: function() {
                this.loadContent();
                this.switchScreen('screen-activity');
            },

            // --- RENDER CONTENT ---
            loadContent: function() {
                const item = this.filteredData[this.currentIndex];
                
                document.getElementById('text-title').innerText = item.title;
                document.getElementById('activity-level-badge').innerText = item.level;
                
                const audio = document.getElementById('main-audio');
                audio.src = item.audio_url;
                audio.load();

                // Script Setup
                const scriptPanel = document.getElementById('script-panel');
                scriptPanel.innerHTML = '';
                scriptPanel.classList.add('hidden');
                this.isScriptOpen = false;
                document.getElementById('script-btn-text').innerText = "Show Transcript";

                if(item.script && Array.isArray(item.script)) {
                    item.script.forEach(line => {
                        const span = document.createElement('span');
                        span.className = "script-line";
                        span.innerText = line.text;
                        span.onclick = () => {
                            audio.currentTime = line.time;
                            audio.play();
                        };
                        scriptPanel.appendChild(span);
                        scriptPanel.appendChild(document.createTextNode(" "));
                    });
                }

                // Questions
                const qDisplay = document.getElementById('questions-display');
                let htmlContent = item.questions;
                const gapCount = (htmlContent.match(/\[\d+\]/g) || []).length;
                
                for(let i = 1; i <= gapCount; i++) {
                    const rawAns = item.answers[i] || item.answers[String(i)] || "?";
                    const displayAns = Array.isArray(rawAns) ? rawAns.join(' / ') : rawAns;

                    if (this.state.mode === 'classroom') {
                        const gapHtml = `<span class="gap-box" onclick="app.toggleGap(this)" data-answer="${displayAns}" data-index="${i}">[${i}]</span>`;
                        htmlContent = htmlContent.replace(`[${i}]`, gapHtml);
                    } else {
                        const inputHtml = `<input id="input-${i}" class="gap-input" type="text" autocomplete="off" placeholder="(${i})">`;
                        htmlContent = htmlContent.replace(`[${i}]`, inputHtml);
                    }
                }
                qDisplay.innerHTML = htmlContent;

                // Mode Controls
                if (this.state.mode === 'classroom') {
                    document.getElementById('classroom-script-controls').classList.remove('hidden');
                    document.getElementById('classroom-actions').classList.remove('hidden');
                    document.getElementById('exam-actions').classList.add('hidden');
                    document.getElementById('result-bar').classList.add('hidden');
                } else {
                    document.getElementById('classroom-script-controls').classList.add('hidden');
                    document.getElementById('classroom-actions').classList.add('hidden');
                    document.getElementById('exam-actions').classList.remove('hidden');
                    document.getElementById('btn-check').classList.remove('hidden');
                    document.getElementById('btn-retry').classList.add('hidden');
                    document.getElementById('result-bar').classList.add('hidden');
                }
            },

            // --- INTERACTIONS ---
            toggleGap: function(el) {
                const ans = el.getAttribute('data-answer');
                if (el.classList.contains('revealed')) {
                    el.innerText = `[${el.getAttribute('data-index')}]`;
                    el.classList.remove('revealed');
                } else {
                    el.innerText = ans.toUpperCase();
                    el.classList.add('revealed');
                }
            },

            revealAll: function() {
                document.querySelectorAll('.gap-box').forEach(el => {
                    el.innerText = el.getAttribute('data-answer').toUpperCase();
                    el.classList.add('revealed');
                });
            },

            toggleScript: function() {
                const panel = document.getElementById('script-panel');
                const btnText = document.getElementById('script-btn-text');
                if (this.isScriptOpen) {
                    panel.classList.add('hidden');
                    btnText.innerText = "Show Transcript";
                } else {
                    panel.classList.remove('hidden');
                    btnText.innerText = "Hide Transcript";
                }
                this.isScriptOpen = !this.isScriptOpen;
            },

            checkExamAnswers: function() {
                const item = this.filteredData[this.currentIndex];
                let score = 0;
                const gapCount = (item.questions.match(/\[\d+\]/g) || []).length;

                for(let i=1; i<=gapCount; i++) {
                    const input = document.getElementById(`input-${i}`);
                    if (!input) continue;

                    const userVal = input.value.trim().toLowerCase();
                    let validKey = item.answers[i] || item.answers[String(i)];
                    let validOptions = [];
                    
                    if(Array.isArray(validKey)) validOptions = validKey.map(s => s.toLowerCase());
                    else if (validKey) validOptions = [validKey.toLowerCase()];

                    input.disabled = true;

                    if (validOptions.includes(userVal)) {
                        score++;
                        input.classList.add('input-correct');
                    } else {
                        input.classList.add('input-wrong');
                        const badge = document.createElement('span');
                        badge.className = 'correction-badge';
                        badge.innerText = validOptions.join(' / ').toUpperCase();
                        input.parentNode.insertBefore(badge, input.nextSibling);
                    }
                }

                document.getElementById('score-display').innerText = `${score} / ${gapCount}`;
                document.getElementById('result-bar').classList.remove('hidden');
                document.getElementById('btn-check').classList.add('hidden');
                document.getElementById('btn-retry').classList.remove('hidden');
                document.getElementById('script-panel').classList.remove('hidden');
            },

            nextText: function() {
                if (this.isRandom) {
                    this.currentIndex = (this.currentIndex + 1) % this.filteredData.length;
                } else {
                    if (this.currentIndex < this.filteredData.length - 1) this.currentIndex++;
                    else { alert("End of Library"); this.showList(); return; }
                }
                this.loadContent();
            },

            resetCurrent: function() { this.loadContent(); },

            switchScreen: function(id) {
                ['screen-dashboard', 'screen-list', 'screen-activity'].forEach(s => document.getElementById(s).classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                window.scrollTo(0,0);
                
                const navBtn = document.getElementById('nav-menu-btn');
                if (id === 'screen-activity') navBtn.classList.remove('hidden');
                else navBtn.classList.add('hidden');
            },

            showDashboard: function() {
                const audio = document.getElementById('main-audio');
                if(audio) { audio.pause(); audio.currentTime = 0; }
                this.switchScreen('screen-dashboard');
            }
        };

        app.init();
    </script>
</body>
</html>