<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speaking Exam Tool (Part 3 & 4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- Configuration & Colors (Matching Python PySide Style) --- */
        :root {
            --deep-blue: #003366;
            --cambridge-yellow: #FFC300;
            --darker-blue: #002244;
            --time-alert-red: #D32F2F;
            --text-light-blue: #99cfff;
        }

        /* FIX: Resetting Body/HTML scroll behavior */
        html, body {
            height: 100%; /* Use full height */
            margin: 0;
            padding: 0;
            overflow-y: auto; /* Allow scrolling only on the main body */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--deep-blue);
            color: white;
            display: flex;
            justify-content: center;
        }
        
        #app-container {
            max-width: 900px;
            background-color: var(--deep-blue);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 2.5rem; /* Standard padding applied here */
        }
        
        /* FIX: New style to manage screen visibility and scrolling within the container */
        .screen-wrapper {
            width: 100%;
            flex-grow: 1; /* Allows it to take up available vertical space */
            padding-top: 20px; /* Separates content from header */
        }
        
        /* FIX: Hide screens that are not active */
        .screen-wrapper.hidden {
            display: none !important;
        }

        /* --- Custom Components --- */

        /* Button Styles */
        .app-btn {
            background-color: var(--cambridge-yellow);
            color: var(--deep-blue);
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        .app-btn:hover {
            background-color: #FEDD5C;
        }
        .app-btn-secondary {
            background-color: #336699;
            color: white;
        }
        .app-btn-secondary:hover {
            background-color: #4477aa;
        }

        /* Timer Styles */
        #timer-label {
            background-color: var(--darker-blue);
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 8px;
            min-width: 100px;
            text-align: center;
        }
        .timer-control {
            background-color: #336699;
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .time-alert {
            background-color: var(--time-alert-red) !important;
            color: var(--cambridge-yellow) !important;
            border: 2px solid var(--cambridge-yellow);
        }

        /* Spidergram Styles (Part 3) */
        #spidergram-central {
            background-color: var(--deep-blue);
            color: var(--cambridge-yellow);
            border: 3px solid var(--cambridge-yellow);
            font-size: 1.375rem; /* 22px */
            font-weight: bold;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
        }
        .spidergram-topic {
            background-color: var(--darker-blue);
            color: white;
            font-size: 1.125rem; /* 18px */
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--cambridge-yellow);
        }

        /* Revealable Question Styles (Part 3 Follow-up / Part 4) */
        .revealable-question {
            font-size: 1.25rem;
            padding: 20px;
            border-radius: 8px;
            min-height: 70px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid var(--cambridge-yellow);
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .hidden-prompt {
            background-color: var(--darker-blue);
            color: var(--text-light-blue);
            border: 3px dashed var(--cambridge-yellow);
            font-size: 1rem;
            font-style: italic;
        }
        .revealed-prompt {
            color: var(--cambridge-yellow);
            background-color: var(--deep-blue);
            border: 3px solid var(--cambridge-yellow);
            font-weight: 500;
        }
        
        /* Level Selection Screen Styling */
        #level-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 600px; /* Keep height minimum for visibility */
            text-align: center;
        }
        
        /* New Back Button Style */
        .back-button {
            @apply bg-transparent text-white font-bold p-2 text-lg hover:text-gray-400 transition;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app-container" class="w-full"> <!-- Removed p-6 md:p-10 to prevent double padding -->

        <!-- --- Top Bar (Part Name, Timer) --- -->
        <!-- Fixed Header remains outside the screen wrappers -->
        <div class="flex justify-between items-center mb-6 px-4 sm:px-8 pt-4"> 
            <h1 class="text-xl font-bold text-white">
                Speaking Exam Practice
            </h1>

            <!-- Timer Group -->
            <div class="flex items-center gap-2">
                <label class="text-sm text-white">Set (s):</label>
                <input type="number" id="time-input" value="120" min="5" max="999" 
                       class="w-16 p-1 text-center bg-white text-gray-800 rounded-md text-sm border-none"
                       onchange="setTargetTimeFromInput()">

                <div id="timer-label" class="text-lg">02:00</div>

                <button id="start-pause-button" class="timer-control">‚ñ∂</button>
                <button id="reset-button" class="timer-control">üîÑ</button>
            </div>
        </div>
        
        
        <!-- --- Content Area (Wrapper for screen switching) --- -->
        <div class="px-4 sm:px-8 pb-4">

            <!-- --- Level Selection Screen (Initial View) --- -->
            <div id="level-selection-screen" class="screen-wrapper">
                <h2 class="text-3xl font-extrabold text-white mb-8">Select Exam Level</h2>
                <div id="level-buttons-container" class="flex gap-6 justify-center">
                    <!-- Buttons generated by JS -->
                </div>
                <p id="level-error-message" class="text-red-400 mt-6 hidden">Error: No questions loaded for this level.</p>
            </div>


            <!-- --- Part 3: Collaborative Task (Spidergram) --- -->
            <div id="part3-screen" class="screen-wrapper hidden">
                <!-- New Navigation Header for Part 3 -->
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                    <button id="back-to-levels-p3" class="back-button">‚Üê Back</button>
                    <h2 class="text-2xl font-extrabold text-center text-white mr-auto ml-4">Part 3: Collaborative Task (<span id="current-level-display"></span>)</h2>
                </div>
                
                <!-- Spidergram Grid (3x3 layout) -->
                <div id="spidergram-grid" class="grid grid-cols-3 gap-4">
                    <!-- Topics will be loaded here -->
                </div>
                
                <!-- Part 3 Follow-up Question -->
                <div id="part3-follow-up-container" class="mt-8">
                    <p class="text-center text-gray-400 mb-2 text-sm">Follow-up Discussion Prompt (Click to Reveal):</p>
                    <div id="part3-follow-up-q" class="revealable-question hidden-prompt">
                        Click to REVEAL the prompt.
                    </div>
                </div>

                <!-- BUTTONS FOR PART 3 (GENERATOR ADDED HERE) -->
                <div class="flex justify-center mt-8 gap-4">
                     <button id="go-to-part4-button" class="app-btn app-btn-secondary w-full max-w-[200px]">
                        Go to Part 4 >>
                    </button>
                     <button id="generate-new-button-p3" class="app-btn w-full max-w-[200px]">
                        Generate New Task
                    </button>
                </div>
            </div>

            <!-- --- Part 4: Discussion (Hidden initially) --- -->
            <div id="part4-screen" class="screen-wrapper hidden">
                <h2 class="text-2xl font-extrabold text-center text-white mb-6">Part 4: Discussion Questions</h2>

                <div id="part4-questions-list" class="space-y-4">
                    <!-- Revealable questions loaded here -->
                </div>

                <div class="flex justify-center mt-8 gap-4">
                    <button id="back-to-part3-button" class="app-btn app-btn-secondary w-full max-w-[200px]">
                        &lt;&lt; Back to Part 3
                    </button>
                    <button id="generate-new-button" class="app-btn w-full max-w-[200px]">
                        Generate New Task
                    </button>
                </div>
            </div>
            
            <!-- Loading Spinner/Message (Removed from view, functionality bypassed) -->
            <div id="loading-overlay" class="hidden"></div> 

        </div>
    </div>

    <script>
        // --- EMBEDDED EXAM DATA (Bypassing Fetch Errors) ---
        const JSON_DATA_STRING = `[
    {"id": "travel_1", "level": "B1", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Talk together about what you like and dislike about different ways of travelling.", "topics": ["cycling", "taking the train", "driving a car", "travelling by plane", "walking"], "second_q": "Which way of travelling is the most convenient in your country?", "part4_qs": ["Do you think people will travel more or less in the future?", "What are the best and worst things about public transportation?", "How important is it to travel to other countries?", "Do you prefer short trips or long holidays, and why?"]}},
    {"id": "jobs_2", "level": "B1", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Talk together about different aspects that make a job interesting or difficult.", "topics": ["pay and salary", "working hours", "helping people", "training opportunities", "stress and pressure"], "second_q": "Which of these aspects do you think is the most important when choosing a career?", "part4_qs": ["How important is it to enjoy your job?", "Do you think technology will create or destroy jobs in the future?", "Should young people focus on university or vocational training?", "What role do hobbies play in maintaining a good work-life balance?"]}},
    {"id": "education_3", "level": "B1", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Discuss the effectiveness of different ways of learning and studying.", "topics": ["group study", "learning alone", "online courses", "using textbooks", "getting a private tutor"], "second_q": "In your opinion, which method is the most beneficial for retaining new information?", "part4_qs": ["Do you think exams are the best way to test students' knowledge?", "What influence do teachers have on a student's success?", "Should education systems be more focused on practical skills or academic subjects?", "What is the biggest challenge facing students today?"]}},
    {"id": "health_4", "level": "B1", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Consider the benefits and drawbacks of different activities on personal health.", "topics": ["meditation", "going to the gym", "eating organic food", "spending time outdoors", "sleeping enough"], "second_q": "Which of these activities has the most immediate positive effect on your mental health?", "part4_qs": ["Is the government responsible for promoting a healthy lifestyle among citizens?", "Do you think people rely too much on medicine?", "How can schools encourage children to be more active?", "What are the best ways to deal with stress in modern life?"]}},
    {"id": "environment_5", "level": "B2", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Discuss ways that individuals and communities can help protect the environment.", "topics": ["recycling more", "using public transport", "saving energy at home", "supporting local farmers", "joining clean-up campaigns"], "second_q": "Which action do you believe makes the biggest long-term difference to the planet?", "part4_qs": ["Do you think it is already too late to reverse climate change?", "Should companies be forced to use sustainable materials?", "How do you feel about protests that interrupt daily life?", "What impact does deforestation have on global weather patterns?"]}},
    {"id": "technology_6", "level": "B2", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Consider the advantages and disadvantages of different forms of technology.", "topics": ["smartphones", "social media", "artificial intelligence", "self-driving cars", "video games"], "second_q": "Which of these forms of technology has had the most significant impact on society in the last ten years?", "part4_qs": ["Do you think artificial intelligence poses a threat to creativity?", "At what age should children be given access to social media?", "How has the way we communicate changed since the invention of the internet?", "Is it possible to live without using technology in the modern world?"]}},
    {"id": "food_7", "level": "B2", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Talk about various ways that people around the world shop for and consume food.", "topics": ["supermarkets", "local markets", "online delivery", "eating out", "growing food at home"], "second_q": "Which of these options offers the best value for money and highest quality produce?", "part4_qs": ["Do you think food waste is a serious problem in your country?", "What role should tradition play in modern cooking?", "How healthy is the average diet in your country?", "Should there be global regulations on farming practices?"]}},
    {"id": "culture_8", "level": "C1", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Discuss the importance of different ways for communities to express their culture.", "topics": ["music and festivals", "traditional clothes", "local language", "historical monuments", "local cuisine"], "second_q": "Which of these is the most effective way for immigrants to share their culture with a new society?", "part4_qs": ["Is it important to preserve local dialects and languages?", "How is culture influenced by global events?", "Do you think cultural appropriation is a genuine problem?", "What is the best way to learn about a culture different from your own?"]}},
    {"id": "entertainment_9", "level": "C1", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Consider the various forms of entertainment and their impact on people's free time.", "topics": ["watching television", "reading books", "going to concerts", "playing sports", "visiting museums"], "second_q": "Which of these forms of entertainment offers the most educational value?", "part4_qs": ["Has the quality of television improved or declined in recent years?", "Do modern forms of entertainment make us less social?", "What do you think will be the most popular form of entertainment in twenty years?", "Should governments fund arts and cultural events?"]}},
    {"id": "housing_10", "level": "C1", "set_time_p3": 120, "set_time_p4": 240, "part3_data": {"initial_q": "Discuss factors that influence where people choose to live.", "topics": ["cost of living", "proximity to work", "safety and security", "access to nature", "size of the house/apartment"], "second_q": "Which factor do you think is the most difficult for young people to balance when looking for a home?", "part4_qs": ["Do you believe house prices are fair in your country?", "What are the pros and cons of renting versus owning a property?", "How important is it to live close to your extended family?", "Do you think urban planning should prioritize cars or people?"]}}
]`;


        // --- Global Data Container ---
        let EXAM_TASK_SETS = []; 
        let AVAILABLE_LEVELS = []; // Will be populated dynamically from data

        // --- Global State ---
        let timeRemaining = 0;
        let targetTimeSeconds = 120;
        let timerInterval = null;
        let isRunning = false;
        
        let currentTaskData = null; 
        let currentLevel = null; 

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const levelSelectionScreen = document.getElementById('level-selection-screen');
        const levelButtonsContainer = document.getElementById('level-buttons-container');
        const levelErrorMessage = document.getElementById('level-error-message');
        const part3Screen = document.getElementById('part3-screen');
        const part4Screen = document.getElementById('part4-screen');
        const timerLabel = document.getElementById('timer-label');
        const timeInput = document.getElementById('time-input');
        const startPauseButton = document.getElementById('start-pause-button');
        const resetButton = document.getElementById('reset-button');
        const spidergramGrid = document.getElementById('spidergram-grid');
        const part3FollowUpQ = document.getElementById('part3-follow-up-q');
        const part4QuestionsList = document.getElementById('part4-questions-list');
        const goToPart4Button = document.getElementById('go-to-part4-button');
        const backToPart3Button = document.getElementById('back-to-part3-button');
        const generateNewButtonP4 = document.getElementById('generate-new-button'); 
        const generateNewButtonP3 = document.getElementById('generate-new-button-p3');
        // NEW: Back to Levels button on Part 3 Screen
        const backToLevelsButtonP3 = document.getElementById('back-to-levels-p3');

        
        // --- Data Loading ---

        /** Loads exam data by parsing the embedded JSON string. (Replaces the failed fetch() call) */
        function loadExamData() {
            try {
                EXAM_TASK_SETS = JSON.parse(JSON_DATA_STRING);
                
                // Dynamically populate AVAILABLE_LEVELS from the loaded data
                const uniqueLevels = new Set(EXAM_TASK_SETS.map(task => task.level).filter(Boolean));
                AVAILABLE_LEVELS = Array.from(uniqueLevels).sort();

                console.log(`Successfully loaded ${EXAM_TASK_SETS.length} embedded exam tasks. Levels found: ${AVAILABLE_LEVELS.join(', ')}`);
                return EXAM_TASK_SETS.length > 0;
            } catch (error) {
                console.error("FATAL ERROR: Failed to parse embedded JSON string:", error);
                
                // Display error message directly on the screen
                levelSelectionScreen.innerHTML = `<h1 style="color:var(--time-alert-red); margin-top: 50px;" class="text-2xl text-center">
                    FATAL ERROR: Embedded data structure is invalid. Cannot start.
                    </h1>`;
                levelSelectionScreen.classList.remove('hidden');
                return false;
            }
        }

        // --- Level Selection and Navigation ---
        
        function hideAllScreens() {
            levelSelectionScreen.classList.add('hidden');
            part3Screen.classList.add('hidden');
            part4Screen.classList.add('hidden');
        }

        function showLevelSelection() {
            hideAllScreens();
            // FIX: Remove scroll to top from here, as it's better handled globally on transition
            levelSelectionScreen.classList.remove('hidden');
            levelButtonsContainer.innerHTML = '';
            levelErrorMessage.classList.add('hidden');
            currentLevel = null; // Reset level state

            if (AVAILABLE_LEVELS.length === 0) {
                 levelErrorMessage.textContent = "Data loaded, but no valid 'level' keys found.";
                 levelErrorMessage.classList.remove('hidden');
                 return;
            }

            AVAILABLE_LEVELS.forEach(level => {
                const button = document.createElement('button');
                button.textContent = level;
                button.className = 'app-btn';
                button.onclick = () => selectLevel(level);
                levelButtonsContainer.appendChild(button);
            });
        }
        
        function selectLevel(level) {
            currentLevel = level;
            // Immediate transition from level selection to Part 3 screen
            showPart3(true);
        }
        
        // NEW: Function to go back from P3 to level selection
        function goBackToLevels() {
            pauseTimer();
            // Using the global scroll behavior for transition start
            window.scrollTo(0, 0); 
            showLevelSelection();
        }


        // --- Task Selection ---

        /** Selects a random task set from the EXAM_TASK_SETS array, filtered by level. */
        function selectRandomTask(level) {
            const filteredTasks = EXAM_TASK_SETS.filter(task => task.level === level);
            
            if (filteredTasks.length === 0) {
                console.error(`No exam tasks available for level: ${level}`);
                return null;
            }
            const randomIndex = Math.floor(Math.random() * filteredTasks.length);
            return filteredTasks[randomIndex];
        }

        // --- Timer Functions (Unchanged) ---

        function secondsToDisplay(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            timerLabel.textContent = secondsToDisplay(timeRemaining);

            timerLabel.classList.remove('time-alert');
            if (timeRemaining <= 5 && isRunning) {
                if (timeRemaining % 2 === 0) {
                    timerLabel.classList.add('time-alert');
                }
            }
        }
        
        function setTargetTimeFromInput() {
            const inputSeconds = parseInt(timeInput.value);
            if (!isNaN(inputSeconds) && inputSeconds >= 5) {
                targetTimeSeconds = inputSeconds;
                resetTimerToTarget();
            } else {
                 timeInput.value = targetTimeSeconds;
            }
        }

        function startTimer() {
            if (isRunning || timeRemaining <= 0) return;

            isRunning = true;
            startPauseButton.textContent = "‚è∏";

            timerInterval = setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining -= 1;
                    updateTimerDisplay();
                } else {
                    pauseTimer();
                    timerLabel.textContent = "TIME UP!";
                    timerLabel.classList.add('time-alert');
                    startPauseButton.disabled = true;
                }
            }, 1000);
        }

        function pauseTimer() {
            if (!isRunning) return;

            clearInterval(timerInterval);
            timerInterval = null;
            isRunning = false;
            startPauseButton.textContent = "‚ñ∂";
        }

        function resetTimerToTarget() {
            pauseTimer();
            timeRemaining = targetTimeSeconds;
            updateTimerDisplay();
            startPauseButton.textContent = "‚ñ∂";
            startPauseButton.disabled = false;
            timerLabel.classList.remove('time-alert');
        }

        // --- UI Functions ---

        /** Toggles the visibility/style of a revealable prompt. */
        function toggleReveal(element) {
            if (element.classList.contains('hidden-prompt')) {
                // Reveal
                element.textContent = element.dataset.fullText;
                element.classList.remove('hidden-prompt');
                element.classList.add('revealed-prompt');
            } else {
                // Hide
                element.textContent = element.dataset.hiddenText;
                element.classList.remove('revealed-prompt');
                element.classList.add('hidden-prompt');
            }
        }
        
        /** Generates and displays the Part 3 Spidergram content. */
        function showPart3(generateNew = false) {
            if (EXAM_TASK_SETS.length === 0 || !currentLevel) return;

            pauseTimer();

            if (generateNew || !currentTaskData || currentTaskData.level !== currentLevel) {
                // Select a new task, filtered by the current level
                currentTaskData = selectRandomTask(currentLevel);
                if (!currentTaskData) {
                    levelErrorMessage.textContent = `No questions found for level ${currentLevel}.`;
                    levelErrorMessage.classList.remove('hidden');
                    showLevelSelection();
                    return;
                }
            }
            
            levelErrorMessage.classList.add('hidden');
            
            const data = currentTaskData.part3_data;
            targetTimeSeconds = currentTaskData.set_time_p3;
            timeInput.value = targetTimeSeconds;
            resetTimerToTarget();

            hideAllScreens();
            part3Screen.classList.remove('hidden');

            // Set the current level display in the header
            document.getElementById('current-level-display').textContent = currentLevel;


            // 1. Setup Spidergram Grid
            spidergramGrid.innerHTML = '';
            
            const centralQ = document.createElement('div');
            centralQ.id = 'spidergram-central';
            centralQ.textContent = data.initial_q;
            centralQ.classList.add('col-span-1', 'row-span-1');
            
            const positions = [
                { r: 0, c: 0 }, { r: 0, c: 2 }, { r: 2, c: 0 }, { r: 2, c: 2 }, { r: 2, c: 1 }
            ];

            data.topics.forEach((topic, i) => {
                const topicEl = document.createElement('div');
                topicEl.className = 'spidergram-topic';
                topicEl.textContent = topic;
                
                if (positions[i]) {
                     topicEl.style.gridRow = positions[i].r + 1;
                     topicEl.style.gridColumn = positions[i].c + 1;
                }
                spidergramGrid.appendChild(topicEl);
            });
            
            centralQ.style.gridRow = 2;
            centralQ.style.gridColumn = 2;
            spidergramGrid.appendChild(centralQ);

            // 2. Setup Part 3 Follow-up
            part3FollowUpQ.dataset.fullText = data.second_q; 
            part3FollowUpQ.dataset.hiddenText = "Click to REVEAL the prompt.";
            
            // Reset to hidden
            part3FollowUpQ.textContent = part3FollowUpQ.dataset.hiddenText;
            part3FollowUpQ.classList.add('hidden-prompt');
            part3FollowUpQ.classList.remove('revealed-prompt');
            
            // FIX: Use global scroll behavior for transition end
            window.scrollTo(0, 0); 
        }

        /** Generates and displays the Part 4 Discussion content. */
        function showPart4() {
            if (!currentTaskData) return;

            const data = currentTaskData.part3_data;
            targetTimeSeconds = currentTaskData.set_time_p4;
            timeInput.value = targetTimeSeconds;
            resetTimerToTarget();
            
            pauseTimer();

            hideAllScreens();
            part4Screen.classList.remove('hidden');

            part4QuestionsList.innerHTML = ''; 

            data.part4_qs.forEach((q_text, i) => {
                const qEl = document.createElement('div');
                qEl.className = 'revealable-question hidden-prompt';
                qEl.dataset.fullText = `Q${i + 1}. ${q_text}`;
                qEl.dataset.hiddenText = `Click to REVEAL Part 4 Question ${i + 1}`;
                qEl.textContent = qEl.dataset.hiddenText;
                
                qEl.onclick = () => toggleReveal(qEl);
                
                part4QuestionsList.appendChild(qEl);
            });
            
            // Ensure the Part 4 screen is visible from the top
            window.scrollTo(0, 0);
        }
        
        // --- Event Connections ---

        startPauseButton.addEventListener('click', () => {
             if (timeRemaining === targetTimeSeconds && timeRemaining > 0) {
                 startTimer();
             } else {
                 toggleStartPause();
             }
        });
        
        function toggleStartPause() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        resetButton.addEventListener('click', resetTimerToTarget);
        timeInput.addEventListener('change', setTargetTimeFromInput);
        
        // Navigation
        goToPart4Button.addEventListener('click', showPart4);
        backToPart3Button.addEventListener('click', () => showPart3(false));
        generateNewButtonP4.addEventListener('click', () => showPart3(true));
        generateNewButtonP3.addEventListener('click', () => showPart3(true));
        // Part 3 Follow-up Reveal Fix
        part3FollowUpQ.addEventListener('click', () => toggleReveal(part3FollowUpQ));
        // NEW: Back to Levels button handler
        backToLevelsButtonP3.addEventListener('click', goBackToLevels);


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const dataLoaded = loadExamData();
            if (dataLoaded) {
                 showLevelSelection();
            }
        });
    </script>
</body>
</html>