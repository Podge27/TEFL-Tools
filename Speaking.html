<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speaking Exam Tool (Part 3 & 4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- Configuration & Colors (Matching Python PySide Style) --- */
        :root {
            --deep-blue: #003366;
            --cambridge-yellow: #FFC300;
            --darker-blue: #002244;
            --time-alert-red: #D32F2F;
            --text-light-blue: #99cfff;
        }

        /* FIX: Resetting Body/HTML scroll behavior */
        html, body {
            height: 100%; /* Use full height */
            margin: 0;
            padding: 0;
            overflow-y: auto; /* Allow scrolling only on the main body */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--deep-blue);
            color: white;
            display: flex;
            justify-content: center;
        }
        
        #app-container {
            max-width: 900px;
            background-color: var(--deep-blue);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 2.5rem; /* Standard padding applied here */
        }
        
        /* FIX: New style to manage screen visibility and scrolling within the container */
        .screen-wrapper {
            width: 100%;
            flex-grow: 1; /* Allows it to take up available vertical space */
            padding-top: 20px; /* Separates content from header */
        }
        
        /* FIX: Hide screens that are not active */
        .screen-wrapper.hidden {
            display: none !important;
        }

        /* --- Custom Components --- */

        /* Button Styles */
        .app-btn {
            background-color: var(--cambridge-yellow);
            color: var(--deep-blue);
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        .app-btn:hover {
            background-color: #FEDD5C;
        }
        .app-btn-secondary {
            background-color: #336699;
            color: white;
        }
        .app-btn-secondary:hover {
            background-color: #4477aa;
        }

        /* Timer Styles */
        #timer-label {
            background-color: var(--darker-blue);
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 8px;
            min-width: 100px;
            text-align: center;
        }
        .timer-control {
            background-color: #336699;
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .time-alert {
            background-color: var(--time-alert-red) !important;
            color: var(--cambridge-yellow) !important;
            border: 2px solid var(--cambridge-yellow);
        }

        /* Timer Set Buttons */
        .timer-set-button {
            background-color: var(--darker-blue);
            color: var(--cambridge-yellow);
            font-weight: 700;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--cambridge-yellow);
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.9rem;
        }
        .timer-set-button:hover {
            background-color: #336699;
            color: white;
        }
        
        /* Spidergram Styles (Part 3) */
        #spidergram-central {
            background-color: var(--deep-blue);
            color: var(--cambridge-yellow);
            border: 3px solid var(--cambridge-yellow);
            font-size: 1.375rem; /* 22px */
            font-weight: bold;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
        }
        .spidergram-topic {
            background-color: var(--darker-blue);
            color: white;
            font-size: 1.125rem; /* 18px */
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--cambridge-yellow);
        }

        /* Revealable Question Styles (Part 3 Follow-up / Part 4) */
        .revealable-question {
            font-size: 1.25rem;
            padding: 20px;
            border-radius: 8px;
            min-height: 70px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid var(--cambridge-yellow);
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .hidden-prompt {
            background-color: var(--darker-blue);
            color: var(--text-light-blue);
            border: 3px dashed var(--cambridge-yellow);
            font-size: 1rem;
            font-style: italic;
        }
        .revealed-prompt {
            color: var(--cambridge-yellow);
            background-color: var(--deep-blue);
            border: 3px solid var(--cambridge-yellow);
            font-weight: 500;
        }
        
        /* Level Selection Screen Styling */
        #level-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 600px; /* Keep height minimum for visibility */
            text-align: center;
        }
        
        /* New Back Button Style */
        .back-button {
            background-color: var(--darker-blue); 
            color: white;
            font-weight: bold;
            padding: 8px 12px;
            font-size: 1rem; 
            transition: background-color 0.3s, color 0.3s;
            border: 2px solid var(--text-light-blue); 
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .back-button:hover {
            background-color: #336699; 
            color: var(--cambridge-yellow);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app-container" class="w-full"> 

        <div class="flex justify-between items-center mb-6 px-4 sm:px-8 pt-4"> 
            
            <div class="flex items-center gap-4">
                <button id="back-to-tools-button-top" class="back-button hidden">
                    ‚Üê Back to Tools
                </button>
                <h1 class="text-xl font-bold text-white">
                    Speaking Exam Practice
                </h1>
            </div>

            <div class="flex items-center gap-2">
                <button id="set-4min-button" class="timer-set-button app-btn-secondary">4 min</button>
                <button id="set-2min-button" class="timer-set-button">2 min</button>
                <button id="set-1min-button" class="timer-set-button app-btn-secondary">1 min</button>
                
                <div id="timer-label" class="text-lg">02:00</div>

                <button id="start-pause-button" class="timer-control">‚ñ∂</button>
                <button id="reset-button" class="timer-control">üîÑ</button>
            </div>
        </div>
        
        
        <div class="px-4 sm:px-8 pb-4">

            <div id="level-selection-screen" class="screen-wrapper">
                
                <h2 class="text-3xl font-extrabold text-white mb-8">Select Exam Level</h2>
                <div id="level-buttons-container" class="flex gap-6 justify-center">
                    </div>
                <p id="level-error-message" class="text-red-400 mt-6 hidden">Error: No questions loaded for this level.</p>
            </div>


            <div id="part3-screen" class="screen-wrapper hidden">
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                    <button id="back-to-levels-p3" class="back-button">‚Üê Back</button>
                    <h2 class="text-2xl font-extrabold text-center text-white mr-auto ml-4">Part 3: Collaborative Task (<span id="current-level-display"></span>)</h2>
                </div>
                
                <div id="spidergram-grid" class="grid grid-cols-3 gap-4">
                    </div>
                
                <div id="part3-follow-up-container" class="mt-8">
                    <p class="text-center text-gray-400 mb-2 text-sm">Follow-up Discussion Prompt (Click to Reveal):</p>
                    <div id="part3-follow-up-q" class="revealable-question hidden-prompt">
                        Click to REVEAL the prompt.
                    </div>
                </div>

                <div class="flex justify-center mt-8 gap-4">
                    <button id="go-to-part4-button" class="app-btn app-btn-secondary w-full max-w-[200px]">
                        Go to Part 4 >>
                    </button>
                    <button id="generate-new-button-p3" class="app-btn w-full max-w-[200px]">
                        Generate New Task
                    </button>
                </div>
            </div>

            <div id="part4-screen" class="screen-wrapper hidden">
                <h2 class="text-2xl font-extrabold text-center text-white mb-6">Part 4: Discussion Questions</h2>

                <div id="part4-questions-list" class="space-y-4">
                    </div>

                <div class="flex justify-center mt-8 gap-4">
                    <button id="back-to-part3-button" class="app-btn app-btn-secondary w-full max-w-[200px]">
                        &lt;&lt; Back to Part 3
                    </button>
                    <button id="generate-new-button" class="app-btn w-full max-w-[200px]">
                        Generate New Task
                    </button>
                </div>
            </div>
            
            <div id="loading-overlay" class="hidden">
                 <p class="text-xl text-white mt-12">Loading exam data...</p>
            </div> 

        </div>
    </div>

    <script>
        
        // --- Global Data Container ---
        let EXAM_TASK_SETS = []; 
        let AVAILABLE_LEVELS = []; // Will be populated dynamically from data

        // --- Global State ---
        let timeRemaining = 0;
        let targetTimeSeconds = 120;
        let timerInterval = null;
        let isRunning = false;
        
        let currentTaskData = null; 
        let currentLevel = null; 

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const levelSelectionScreen = document.getElementById('level-selection-screen');
        const levelButtonsContainer = document.getElementById('level-buttons-container');
        const levelErrorMessage = document.getElementById('level-error-message');
        const part3Screen = document.getElementById('part3-screen');
        const part4Screen = document.getElementById('part4-screen');
        const timerLabel = document.getElementById('timer-label');
        const startPauseButton = document.getElementById('start-pause-button');
        const resetButton = document.getElementById('reset-button');
        const spidergramGrid = document.getElementById('spidergram-grid');
        const part3FollowUpQ = document.getElementById('part3-follow-up-q');
        const part4QuestionsList = document.getElementById('part4-questions-list');
        const goToPart4Button = document.getElementById('go-to-part4-button');
        const backToPart3Button = document.getElementById('back-to-part3-button');
        const generateNewButtonP4 = document.getElementById('generate-new-button'); 
        const generateNewButtonP3 = document.getElementById('generate-new-button-p3');
        const backToLevelsButtonP3 = document.getElementById('back-to-levels-p3');
        const backToToolsButtonTop = document.getElementById('back-to-tools-button-top');
        // NEW: Time Set Buttons
        const set4MinButton = document.getElementById('set-4min-button'); // NEW
        const set2MinButton = document.getElementById('set-2min-button'); 
        const set1MinButton = document.getElementById('set-1min-button'); 


        // --- Data Loading (Updated to use Fetch) ---

        /** Loads exam data by fetching the external JSON file. */
        async function loadExamData() {
            loadingOverlay.classList.remove('hidden');
            
            try {
                // Fetch the external JSON file
                const response = await fetch('./exam_tasks.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Parse the JSON data
                EXAM_TASK_SETS = await response.json();
                
                // Dynamically populate AVAILABLE_LEVELS from the loaded data
                const uniqueLevels = new Set(EXAM_TASK_SETS.map(task => task.level).filter(Boolean));
                AVAILABLE_LEVELS = Array.from(uniqueLevels).sort();

                console.log(`Successfully loaded ${EXAM_TASK_SETS.length} external exam tasks. Levels found: ${AVAILABLE_LEVELS.join(', ')}`);
                return EXAM_TASK_SETS.length > 0;
            } catch (error) {
                console.error("FATAL ERROR: Failed to load external JSON file:", error);
                
                // Display error message directly on the screen
                levelSelectionScreen.innerHTML = `<h1 style="color:var(--time-alert-red); margin-top: 50px;" class="text-2xl text-center">
                    FATAL ERROR: Could not load data from exam_tasks.json. 
                    <br>Check if the file exists and the path is correct.
                    </h1>`;
                levelSelectionScreen.classList.remove('hidden');
                return false;
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // --- Level Selection and Navigation ---
        
        function hideAllScreens() {
            levelSelectionScreen.classList.add('hidden');
            part3Screen.classList.add('hidden');
            part4Screen.classList.add('hidden');
        }

        function showLevelSelection() {
            hideAllScreens();
            window.scrollTo(0, 0); 
            levelSelectionScreen.classList.remove('hidden');
            backToToolsButtonTop.classList.remove('hidden'); // SHOW BUTTON HERE
            levelButtonsContainer.innerHTML = '';
            levelErrorMessage.classList.add('hidden');
            currentLevel = null; 

            if (AVAILABLE_LEVELS.length === 0) {
                 levelErrorMessage.textContent = "Data loaded, but no valid 'level' keys found.";
                 levelErrorMessage.classList.remove('hidden');
                 return;
            }

            AVAILABLE_LEVELS.forEach(level => {
                const button = document.createElement('button');
                button.textContent = level;
                button.className = 'app-btn';
                button.onclick = () => selectLevel(level);
                levelButtonsContainer.appendChild(button);
            });
        }
        
        function selectLevel(level) {
            currentLevel = level;
            backToToolsButtonTop.classList.add('hidden'); // HIDE BUTTON WHEN STARTING TASK
            showPart3(true);
        }
        
        function goBackToLevels() {
            pauseTimer();
            window.scrollTo(0, 0); 
            showLevelSelection();
        }

        /** Selects a random task set from the EXAM_TASK_SETS array, filtered by level. */
        function selectRandomTask(level) {
            const filteredTasks = EXAM_TASK_SETS.filter(task => task.level === level);
            
            if (filteredTasks.length === 0) {
                console.error(`No exam tasks available for level: ${level}`);
                return null;
            }
            const randomIndex = Math.floor(Math.random() * filteredTasks.length);
            return filteredTasks[randomIndex];
        }

        // --- Timer Functions ---

        function secondsToDisplay(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            timerLabel.textContent = secondsToDisplay(timeRemaining);

            timerLabel.classList.remove('time-alert');
            if (timeRemaining <= 5 && isRunning) {
                if (timeRemaining % 2 === 0) {
                    timerLabel.classList.add('time-alert');
                }
            }
        }
        
        // Function to set and reset time to a specific value
        function setAndResetTimer(seconds) {
            pauseTimer();
            targetTimeSeconds = seconds;
            resetTimerToTarget();
        }

        function startTimer() {
            if (isRunning || timeRemaining <= 0) return;

            isRunning = true;
            startPauseButton.textContent = "‚è∏";

            timerInterval = setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining -= 1;
                    updateTimerDisplay();
                } else {
                    pauseTimer();
                    timerLabel.textContent = "TIME UP!";
                    timerLabel.classList.add('time-alert');
                    startPauseButton.disabled = true;
                }
            }, 1000);
        }

        function pauseTimer() {
            if (!isRunning) return;

            clearInterval(timerInterval);
            timerInterval = null;
            isRunning = false;
            startPauseButton.textContent = "‚ñ∂";
        }

        // This relies only on the global targetTimeSeconds
        function resetTimerToTarget() {
            pauseTimer();
            timeRemaining = targetTimeSeconds;
            updateTimerDisplay();
            startPauseButton.textContent = "‚ñ∂";
            startPauseButton.disabled = false;
            timerLabel.classList.remove('time-alert');
        }

        // --- UI Functions ---

        function toggleReveal(element) {
            if (element.classList.contains('hidden-prompt')) {
                element.textContent = element.dataset.fullText;
                element.classList.remove('hidden-prompt');
                element.classList.add('revealed-prompt');
            } else {
                element.textContent = element.dataset.hiddenText;
                element.classList.remove('revealed-prompt');
                element.classList.add('hidden-prompt');
            }
        }
        
        // showPart3 now calls setAndResetTimer
        function showPart3(generateNew = false) {
            if (EXAM_TASK_SETS.length === 0 || !currentLevel) return;

            pauseTimer();

            if (generateNew || !currentTaskData || currentTaskData.level !== currentLevel) {
                currentTaskData = selectRandomTask(currentLevel);
                if (!currentTaskData) {
                    levelErrorMessage.textContent = `No questions found for level ${currentLevel}.`;
                    levelErrorMessage.classList.remove('hidden');
                    showLevelSelection();
                    return;
                }
            }
            
            levelErrorMessage.classList.add('hidden');
            
            const data = currentTaskData.part3_data;
            
            // Set the timer to the Part 3 target time (e.g., 120 seconds)
            setAndResetTimer(currentTaskData.set_time_p3); 

            hideAllScreens();
            part3Screen.classList.remove('hidden');

            document.getElementById('current-level-display').textContent = currentLevel;


            // 1. Setup Spidergram Grid
            spidergramGrid.innerHTML = '';
            
            const centralQ = document.createElement('div');
            centralQ.id = 'spidergram-central';
            centralQ.textContent = data.initial_q;
            centralQ.classList.add('col-span-1', 'row-span-1');
            
            const positions = [
                { r: 0, c: 0 }, { r: 0, c: 2 }, { r: 2, c: 0 }, { r: 2, c: 2 }, { r: 2, c: 1 }
            ];

            data.topics.forEach((topic, i) => {
                const topicEl = document.createElement('div');
                topicEl.className = 'spidergram-topic';
                topicEl.textContent = topic;
                
                if (positions[i]) {
                     topicEl.style.gridRow = positions[i].r + 1;
                     topicEl.style.gridColumn = positions[i].c + 1;
                }
                spidergramGrid.appendChild(topicEl);
            });
            
            centralQ.style.gridRow = 2;
            centralQ.style.gridColumn = 2;
            spidergramGrid.appendChild(centralQ);

            // 2. Setup Part 3 Follow-up
            part3FollowUpQ.dataset.fullText = data.second_q; 
            part3FollowUpQ.dataset.hiddenText = "Click to REVEAL the prompt.";
            
            // Reset to hidden
            part3FollowUpQ.textContent = part3FollowUpQ.dataset.hiddenText;
            part3FollowUpQ.classList.add('hidden-prompt');
            part3FollowUpQ.classList.remove('revealed-prompt');
            
            window.scrollTo(0, 0); 
        }

        // showPart4 now calls setAndResetTimer
        function showPart4() {
            if (!currentTaskData) return;

            const data = currentTaskData.part3_data;
            
            // Set the timer to the Part 4 target time (e.g., 240 seconds)
            setAndResetTimer(currentTaskData.set_time_p4); 
            
            pauseTimer();

            hideAllScreens();
            part4Screen.classList.remove('hidden');

            part4QuestionsList.innerHTML = ''; 

            data.part4_qs.forEach((q_text, i) => {
                const qEl = document.createElement('div');
                qEl.className = 'revealable-question hidden-prompt';
                qEl.dataset.fullText = `Q${i + 1}. ${q_text}`;
                qEl.dataset.hiddenText = `Click to REVEAL Part 4 Question ${i + 1}`;
                qEl.textContent = qEl.dataset.hiddenText;
                
                qEl.onclick = () => toggleReveal(qEl);
                
                part4QuestionsList.appendChild(qEl);
            });
            
            window.scrollTo(0, 0);
        }
        
        // --- Event Connections ---

        function toggleStartPause() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }
        
        startPauseButton.addEventListener('click', () => {
             if (timeRemaining === targetTimeSeconds && timeRemaining > 0) {
                 startTimer();
             } else {
                 toggleStartPause();
             }
        });

        resetButton.addEventListener('click', resetTimerToTarget);
        
        // NEW: Timer Set Handlers
        set4MinButton.addEventListener('click', () => setAndResetTimer(240));
        set2MinButton.addEventListener('click', () => setAndResetTimer(120));
        set1MinButton.addEventListener('click', () => setAndResetTimer(60));
        
        // Navigation
        goToPart4Button.addEventListener('click', showPart4);
        backToPart3Button.addEventListener('click', () => showPart3(false));
        generateNewButtonP4.addEventListener('click', () => showPart3(true)); // Button on Part 4: Generate New Task
        generateNewButtonP3.addEventListener('click', () => showPart3(true));
        part3FollowUpQ.addEventListener('click', () => toggleReveal(part3FollowUpQ));
        backToLevelsButtonP3.addEventListener('click', goBackToLevels); // Button on Part 3: Back to Tools

        // Top button handler for external link
        backToToolsButtonTop.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // --- Initialization (Updated to use async load) ---
        document.addEventListener('DOMContentLoaded', async () => {
            const dataLoaded = await loadExamData();
            if (dataLoaded) {
                 showLevelSelection();
            }
        });
    </script>
</body>
</html>