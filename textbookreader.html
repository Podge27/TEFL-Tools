<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coursebook Flagship</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Patrick+Hand&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        /* --- 1. CORE LAYOUT --- */
        :root {
            --primary: #2563EB;
            --accent: #F59E0B; /* Exam Tip Yellow */
            --bg: #f3f4f6;
            --sidebar-width: 280px;
        }

        body { 
            background-color: var(--bg); color: #1f2937;
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            display: flex; height: 100vh; overflow: hidden;
        }

        /* --- 2. SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width); background: #111827; color: #e5e7eb;
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 2000;
            transition: margin-left 0.3s ease;
        }
        #sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #374151; font-weight: 700; letter-spacing: 1px; color: white; }
        
        .tools-panel { padding: 1rem; background: rgba(255,255,255,0.05); border-bottom: 1px solid #374151; }
        .sidebar-btn {
            display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px; margin-bottom: 5px;
            background: #374151; border: 1px solid #4b5563; color: white; border-radius: 6px; cursor: pointer;
        }
        .sidebar-btn:hover { background: #4b5563; }
        .sidebar-btn.active { background: var(--primary); border-color: var(--primary); }

        .nav-list { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .nav-section-title { font-size: 0.75rem; text-transform: uppercase; color: #9ca3af; margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 700; }
        .nav-item { padding: 8px; cursor: pointer; color: #d1d5db; border-radius: 4px; font-size: 0.9rem; }
        .nav-item:hover { background: #374151; color: white; }

        /* --- 3. MAIN STAGE --- */
        #main-stage { flex-grow: 1; position: relative; overflow-y: auto; background: #e5e7eb; display: flex; flex-direction: column; align-items: center; }
        .stage-header { position: sticky; top: 0; width: 100%; height: 50px; z-index: 1500; padding: 10px; pointer-events: none; }
        #toggle-btn { pointer-events: auto; background: white; border: 1px solid #d1d5db; width: 40px; height: 40px; border-radius: 6px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        #paper-page {
            width: 100%; max-width: 950px; background: white; min-height: 100vh;
            padding: 4rem 5rem; margin-top: -40px; margin-bottom: 100px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); position: relative;
        }

        /* --- 4. CONTENT COMPONENTS --- */
        .block { margin-bottom: 3.5rem; scroll-margin-top: 60px; }
        h1 { font-size: 3rem; letter-spacing: -1px; margin-bottom: 0.5rem; color: #111; }
        h2 { font-size: 1.8rem; border-bottom: 3px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1.5rem; color: #1f2937; }
        h3 { font-size: 1.2rem; color: #4b5563; margin-bottom: 1rem; font-weight: 600; }
        
        /* Reading Text */
        .reading-text { font-family: 'Merriweather', serif; font-size: 1.1rem; line-height: 1.8; color: #374151; text-align: justify; }
        .reading-columns { column-count: 2; column-gap: 3rem; }

        /* Exam Tip Box */
        .exam-tip {
            background: #fffbeb; border-left: 5px solid #f59e0b; padding: 1.5rem;
            margin: 2rem 0; border-radius: 0 8px 8px 0; position: relative;
            font-family: 'Patrick Hand', cursive; font-size: 1.1rem; color: #78350f;
        }
        .exam-tip::before { content: 'üí° EXAM TIP'; position: absolute; top: -12px; left: 10px; background: #f59e0b; color: white; padding: 2px 8px; font-family: 'Inter', sans-serif; font-size: 0.75rem; font-weight: bold; border-radius: 4px; }

        /* Speaking Box */
        .speaking-box {
            background: #eff6ff; border: 1px solid #bfdbfe; padding: 2rem; border-radius: 12px;
            display: flex; gap: 20px; align-items: start;
        }
        .speaking-icon { font-size: 2.5rem; }

        /* Writing Box */
        .writing-box { background: #fdf2f8; border: 2px dashed #fbcfe8; padding: 2rem; border-radius: 12px; }
        .useful-lang { background: white; padding: 1rem; margin-top: 1rem; border: 1px solid #e5e7eb; border-radius: 6px; }

        /* Magic Gaps & Inputs */
        .magic-gap {
            display: inline-block; min-width: 60px; padding: 0 8px; border-bottom: 2px solid #9ca3af;
            background: #f3f4f6; color: transparent; cursor: pointer; text-align: center; font-weight: bold;
            transition: all 0.2s; user-select: none; font-family: 'Inter', sans-serif;
        }
        .magic-gap.revealed { background: #dcfce7; border-color: #16a34a; color: #166534; }
        
        /* Matching (Click Style) */
        .match-container { display: flex; gap: 2rem; }
        .match-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .match-item {
            padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;
            transition: all 0.2s; font-size: 0.95rem;
        }
        .match-item.selected { background: #eff6ff; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .match-item.matched { background: #dcfce7; border-color: #16a34a; color: #166534; opacity: 0.8; pointer-events: none; }

        /* UOE Parts */
        .wf-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #e5e7eb; padding: 5px 0; }
        .wf-root { font-weight: bold; font-family: monospace; letter-spacing: 1px; }

        /* Drawing Layer */
        #drawing-layer { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 1000; }
        .cursor-pen { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>') 0 24, auto !important; }

        @media print {
            #sidebar, .stage-header { display: none !important; }
            #paper-page { margin: 0; padding: 0; box-shadow: none; max-width: 100%; }
            body { background: white; height: auto; overflow: visible; }
            .magic-gap { color: transparent !important; border-bottom: 1px solid #000; }
        }
    </style>
</head>
<body>

    <aside id="sidebar">
        <div class="sidebar-header">COURSEBOOK PRO</div>
        <div class="tools-panel">
            <button class="sidebar-btn" id="btn-pen" onclick="togglePen()">‚úèÔ∏è Board Pen</button>
            <div id="pen-options" style="display:none; padding-left:10px; margin-bottom:10px;">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <div style="width:20px; height:20px; background:blue; border-radius:50%; cursor:pointer;" onclick="setPenColor('blue')"></div>
                    <div style="width:20px; height:20px; background:red; border-radius:50%; cursor:pointer;" onclick="setPenColor('red')"></div>
                    <div style="width:20px; height:20px; background:black; border-radius:50%; cursor:pointer;" onclick="setPenColor('black')"></div>
                </div>
                <button class="sidebar-btn" onclick="clearDrawings()" style="font-size:0.8rem; padding:5px;">Clear</button>
            </div>
            <button class="sidebar-btn" id="btn-reveal" onclick="toggleRevealAll()">üëÅÔ∏è Reveal All</button>
            <button class="sidebar-btn" onclick="window.print()">üìÑ PDF Export</button>
        </div>
        <div class="nav-list" id="nav-list"></div>
        <div style="padding:1rem;"><button class="sidebar-btn" onclick="loadDemoData()" style="background:transparent; border:1px dashed #666; color:#888;">‚Üª Reset Unit</button></div>
    </aside>

    <div id="main-stage">
        <div class="stage-header">
            <button id="toggle-btn" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">‚ò∞</button>
        </div>
        <div id="paper-page">
            <canvas id="drawing-layer"></canvas>
            <div id="unit-container"></div>
        </div>
    </div>

    <script>
        // STATE
        let db = null;
        let isPenActive = false;
        let signaturePad;
        let revealState = false; // false = hidden, true = revealed
        let selectedMatchItem = null; // For matching exercise

        // INIT
        window.addEventListener('load', () => {
            initCanvas();
            initSupabase();
            const urlParams = new URLSearchParams(window.location.search);
            const unitId = urlParams.get('id');
            if(unitId && db) loadUnit(unitId); else loadDemoData();
        });

        function initSupabase() {
            try {
                // Add keys here if needed
                if(window.supabase) db = window.supabase.createClient('URL', 'KEY');
            } catch(e){}
        }

        // --- RENDERER ---
        function renderBlocks(blocks) {
            const container = document.getElementById('unit-container');
            const nav = document.getElementById('nav-list');
            container.innerHTML = '';
            nav.innerHTML = '';

            // Section Tracker
            let currentSection = '';

            blocks.forEach((block, index) => {
                const blockId = `block-${index}`;
                
                // Add Nav Section Headers
                if(block.section && block.section !== currentSection) {
                    currentSection = block.section;
                    const h = document.createElement('div');
                    h.className = 'nav-section-title';
                    h.innerText = currentSection;
                    nav.appendChild(h);
                }

                const div = document.createElement('div');
                div.className = 'block';
                div.id = blockId;

                switch(block.type) {
                    // HEADER
                    case 'header':
                        div.innerHTML = `
                            <div style="text-transform:uppercase; color:#2563EB; font-weight:bold; letter-spacing:2px; margin-bottom:10px;">${block.level} | Unit ${block.unit_num || '1'}</div>
                            <h1>${block.title}</h1>
                            <p style="font-size:1.2rem; color:#6b7280; max-width:600px;">${block.subtitle || ''}</p>
                            <hr style="margin-top:3rem; border-color:#e5e7eb;">
                        `;
                        addNavLink('Start', blockId);
                        break;

                    // READING
                    case 'text':
                        div.innerHTML = `
                            <h2>${block.headline}</h2>
                            <div class="reading-text ${block.columns ? 'reading-columns' : ''}">${block.content}</div>
                        `;
                        addNavLink('Reading', blockId);
                        break;

                    // AUDIO
                    case 'audio':
                         div.innerHTML = `
                            <div style="background:#f3f4f6; padding:1.5rem; border-radius:8px; border-left:4px solid #2563EB;">
                                <h3>üéß Listening: ${block.title}</h3>
                                <p>${block.instructions}</p>
                                <audio controls style="width:100%; margin-top:10px;">
                                    <source src="${block.url}" type="audio/mpeg">
                                </audio>
                            </div>
                        `;
                        addNavLink('Listening', blockId);
                        break;

                    // IMAGE / CARTOON
                    case 'image':
                        div.innerHTML = `
                            <figure style="text-align:center;">
                                <img src="${block.url}" style="max-width:100%; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                                ${block.caption ? `<figcaption style="margin-top:10px; color:#6b7280; font-style:italic;">${block.caption}</figcaption>` : ''}
                            </figure>
                        `;
                        break;

                    // EXAM TIP
                    case 'exam_tip':
                        div.className = 'exam-tip';
                        div.innerHTML = block.content;
                        break;

                    // SPEAKING BOX
                    case 'speaking':
                        div.className = 'speaking-box';
                        div.innerHTML = `
                            <div class="speaking-icon">üí¨</div>
                            <div>
                                <h3 style="margin-top:0;">Speaking: ${block.title}</h3>
                                <p>${block.content}</p>
                                <ul style="padding-left:20px; color:#4b5563;">
                                    ${block.points.map(p => `<li>${p}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        addNavLink('Speaking', blockId);
                        break;

                    // WRITING BOX
                    case 'writing':
                        div.className = 'writing-box';
                        div.innerHTML = `
                            <h3 style="color:#be185d; margin-top:0;">‚úçÔ∏è Writing: ${block.title}</h3>
                            <p><strong>Task:</strong> ${block.task}</p>
                            <div class="useful-lang">
                                <strong>Useful Language:</strong>
                                <ul style="margin:5px 0; padding-left:20px;">
                                    ${block.useful_lang.map(l => `<li>${l}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        addNavLink('Writing', blockId);
                        break;

                    // UOE Part 2 (Open Cloze)
                    case 'ue_part2':
                        div.innerHTML = `<h2>Use of English Part 2</h2><p>Complete the text with <strong>one word</strong> in each gap.</p>`;
                        const txt = document.createElement('div');
                        txt.className = 'reading-text';
                        txt.innerHTML = block.text.replace(/{{(.*?)}}/g, `<span class="magic-gap" onclick="this.classList.toggle('revealed')">$1</span>`);
                        div.appendChild(txt);
                        addNavLink('Open Cloze', blockId);
                        break;

                    // UOE Part 3 (Word Formation)
                    case 'ue_part3':
                        div.innerHTML = `<h2>Use of English Part 3</h2><p>Form a word from the root to fit the gap.</p>`;
                        const wfList = document.createElement('div');
                        wfList.className = 'reading-text';
                        block.lines.forEach(line => {
                            const row = document.createElement('div');
                            row.className = 'wf-line';
                            const left = document.createElement('div');
                            if(line.gap) {
                                const p = line.text.split('____');
                                left.innerHTML = `${p[0]} <span class="magic-gap" onclick="this.classList.toggle('revealed')">${line.answer}</span> ${p[1]||''}`;
                            } else left.innerHTML = line.text;
                            row.innerHTML = `<div>${left.innerHTML}</div><div class="wf-root">${line.root||''}</div>`;
                            wfList.appendChild(row);
                        });
                        div.appendChild(wfList);
                        addNavLink('Word Formation', blockId);
                        break;

                    // MATCHING (Click Logic)
                    case 'matching':
                        div.innerHTML = `<h2>Matching</h2><p>${block.instruction}</p>`;
                        const container = document.createElement('div');
                        container.className = 'match-container';
                        
                        // Left Col
                        const leftCol = document.createElement('div'); leftCol.className = 'match-col';
                        const rightCol = document.createElement('div'); rightCol.className = 'match-col';
                        
                        block.pairs.forEach((pair, idx) => {
                            // Left Item
                            const l = document.createElement('div');
                            l.className = 'match-item';
                            l.innerText = pair.left;
                            l.dataset.id = idx;
                            l.dataset.side = 'left';
                            l.onclick = (e) => handleMatchClick(e.target);
                            leftCol.appendChild(l);

                            // Right Item (Randomized in real app, keeping simple here)
                            const r = document.createElement('div');
                            r.className = 'match-item';
                            r.innerText = pair.right;
                            r.dataset.id = idx; // Matching ID
                            r.dataset.side = 'right';
                            r.onclick = (e) => handleMatchClick(e.target);
                            rightCol.appendChild(r);
                        });
                        
                        container.appendChild(leftCol);
                        container.appendChild(rightCol);
                        div.appendChild(container);
                        addNavLink('Matching', blockId);
                        break;
                }
                container.appendChild(div);
            });
            setTimeout(resizeCanvas, 500);
        }

        function addNavLink(label, id) {
            const l = document.createElement('div');
            l.className = 'nav-item';
            l.innerText = label;
            l.onclick = () => document.getElementById(id).scrollIntoView({behavior:'smooth'});
            document.getElementById('nav-list').appendChild(l);
        }

        // --- MATCHING LOGIC ---
        function handleMatchClick(el) {
            if(el.classList.contains('matched')) return;

            if(!selectedMatchItem) {
                // Select first
                selectedMatchItem = el;
                el.classList.add('selected');
            } else {
                // Try to match
                if(selectedMatchItem === el) {
                    // Deselect self
                    el.classList.remove('selected');
                    selectedMatchItem = null;
                } else if(selectedMatchItem.dataset.side === el.dataset.side) {
                    // Changed mind, selected same side
                    selectedMatchItem.classList.remove('selected');
                    selectedMatchItem = el;
                    el.classList.add('selected');
                } else {
                    // Cross match attempt
                    if(selectedMatchItem.dataset.id === el.dataset.id) {
                        // SUCCESS
                        el.classList.add('matched');
                        selectedMatchItem.classList.add('matched');
                        selectedMatchItem.classList.remove('selected');
                        selectedMatchItem = null;
                    } else {
                        // FAIL - Shake effect?
                        alert("Try again!");
                        selectedMatchItem.classList.remove('selected');
                        selectedMatchItem = null;
                    }
                }
            }
        }

        // --- REVEAL ALL LOGIC ---
        function toggleRevealAll() {
            revealState = !revealState;
            const btn = document.getElementById('btn-reveal');
            const gaps = document.querySelectorAll('.magic-gap');
            
            if(revealState) {
                gaps.forEach(g => g.classList.add('revealed'));
                btn.innerHTML = "üôà Hide All";
            } else {
                gaps.forEach(g => g.classList.remove('revealed'));
                btn.innerHTML = "üëÅÔ∏è Reveal All";
            }
        }

        // --- DRAWING ---
        function togglePen() {
            isPenActive = !isPenActive;
            const btn = document.getElementById('btn-pen');
            const opts = document.getElementById('pen-options');
            const canvas = document.getElementById('drawing-layer');
            const paper = document.getElementById('paper-page');

            if(isPenActive) {
                btn.classList.add('active'); opts.style.display = 'block';
                canvas.style.pointerEvents = 'auto'; paper.classList.add('cursor-pen');
                signaturePad.on();
            } else {
                btn.classList.remove('active'); opts.style.display = 'none';
                canvas.style.pointerEvents = 'none'; paper.classList.remove('cursor-pen');
                signaturePad.off();
            }
        }
        function setPenColor(c) { signaturePad.penColor = c; }
        function clearDrawings() { signaturePad.clear(); }
        function initCanvas() {
            const canvas = document.getElementById('drawing-layer');
            resizeCanvas();
            if(typeof SignaturePad !== 'undefined') {
                signaturePad = new SignaturePad(canvas, { penColor: 'blue', minWidth: 2, maxWidth: 3 });
                signaturePad.off();
            }
        }
        function resizeCanvas() {
            const canvas = document.getElementById('drawing-layer');
            const paper = document.getElementById('paper-page');
            canvas.width = paper.clientWidth; canvas.height = paper.clientHeight;
        }

        // --- THE MEGA UNIT SIMULATION ---
        function loadDemoData() {
            const blocks = [
                { section: 'Lead-in', type: 'header', title: 'The Future of Work', level: 'B2 UPPER INTERMEDIATE', subtitle: 'Unit 4: Careers & Technology' },
                { section: 'Lead-in', type: 'image', url: 'https://images.unsplash.com/photo-1593642632823-8f7853670961', caption: 'Is the office obsolete?' },
                { section: 'Lead-in', type: 'speaking', title: 'Workplace Trends', content: 'Discuss the following questions in pairs:', points: ['Would you prefer to work entirely from home?', 'What are the disadvantages of being a "digital nomad"?', 'Will AI replace your future job?'] },
                
                { section: 'Reading', type: 'text', headline: 'The Death of the Commute', columns: true, content: 'For decades, the "9-to-5" structure dictated our lives. We squeezed into trains, sat in traffic, and endured the daily grind just to sit at a desk. But the post-2020 world has shattered this model. Asynchronous work‚Äîworking when it suits you, not when the boss is watching‚Äîis the new gold standard. However, this freedom comes at a cost: the blurring of lines between "home" and "office". Sociologists warn that without the physical separation of the workplace, we risk a burnout epidemic.' },
                { section: 'Reading', type: 'exam_tip', content: 'In <strong>Part 6 (Gapped Text)</strong>, look for reference words like "this", "that", or "such" to link the missing paragraphs to the text.' },
                
                { section: 'Vocabulary', type: 'matching', instruction: 'Match the phrasal verbs to their definitions.', pairs: [
                    { left: 'Burn out', right: 'Become exhausted from overwork' },
                    { left: 'Clock off', right: 'Finish work for the day' },
                    { left: 'Take on', right: 'Accept new responsibility' }
                ]},

                { section: 'Use of English', type: 'ue_part2', text: 'The problem with home working is not the isolation {{itself}}, but rather the lack of boundaries. We seem incapable {{of}} switching off. Whenever there is a quiet moment, we instinctively reach {{for}} our phones.' },
                { section: 'Use of English', type: 'ue_part3', lines: [
                    { text: 'The internet has caused a revolution in...', root: 'COMMUNICATE', gap: true, answer: 'COMMUNICATION' },
                    { text: 'Many people find it impossible to...', root: 'CONNECT', gap: true, answer: 'DISCONNECT' },
                    { text: 'This can lead to feelings of...', root: 'LONELY', gap: true, answer: 'LONELINESS' }
                ]},

                { section: 'Listening', type: 'audio', title: 'Remote Work Survey', instructions: 'You will hear five short extracts in which people are talking about their jobs.', url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
                
                { section: 'Writing', type: 'writing', title: 'A Report', task: 'Your manager has asked you to write a report on the benefits of remote working for your department.', useful_lang: ['The purpose of this report is to...', 'It is generally agreed that...', 'I would recommend that...'] }
            ];
            renderBlocks(blocks);
        }
        
        async function loadUnit(id) {
            try {
                const { data } = await db.from('units').select('*').eq('id', id).single();
                if(data && data.content) renderBlocks(data.content.blocks || data.content);
            } catch(e){ loadDemoData(); }
        }
    </script>
</body>
</html>