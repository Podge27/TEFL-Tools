<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Board</title>
    <link rel="stylesheet" href="global.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; min-height: 100vh; }
        #app-container { @apply w-full max-w-[95%] mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden min-h-[850px] flex flex-col relative; }

        .btn-back-wrapper { @apply w-full max-w-[95%] mx-auto mb-6 flex justify-start; }
        .btn-back { display: inline-block; background: linear-gradient(135deg, #00BCD4, #4DD0E1); color: black; padding: 12px 24px; border-radius: 12px; text-decoration: none; font-weight: 800; border: 2px solid white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-back:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }

        .level-select-btn { font-size: 3rem; padding: 2rem; width: 100%; @apply font-black rounded-[2rem] transition duration-300 transform border-4 opacity-70 grayscale cursor-pointer shadow-lg; }
        .level-select-btn.active { transform: scale(1.05) translateY(-5px); opacity: 1; filter: grayscale(0); z-index: 10; @apply ring-4 ring-offset-4 ring-indigo-500; }
        
        .btn-b2-style { background: linear-gradient(145deg, #4F46E5 0%, #818CF8 100%); color: white; border-color: #C7D2FE; }
        .btn-c1-style { background: linear-gradient(145deg, #FF9800 0%, #FFC107 100%); color: #333; border-color: #FFECB3; }
        .btn-c2-style { background: linear-gradient(145deg, #8BC34A 0%, #CDDC39 100%); color: #333; border-color: #DCEDC8; }

        .app-btn { @apply px-8 py-4 font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] active:scale-95 cursor-pointer text-lg; }
        .mode-select-btn { @apply flex flex-col items-center justify-center p-8 rounded-[1.5rem] border-4 border-gray-200 bg-white text-gray-500 transition-all duration-200 cursor-pointer shadow-md hover:border-indigo-300 hover:bg-indigo-50 hover:shadow-xl hover:text-indigo-600; min-height: 180px; }
        .mode-select-btn.active { @apply border-indigo-500 bg-indigo-50 text-indigo-700 shadow-xl ring-4 ring-offset-4 ring-indigo-500; transform: translateY(-5px); }

        .p4-card { @apply p-8 border border-gray-200 rounded-xl mb-6 bg-gray-50 h-full flex flex-col justify-center; }
        .key-word-small { @apply bg-amber-200 px-3 py-1 rounded font-bold text-gray-800 text-sm uppercase border border-amber-300 inline-block mb-4 w-fit; }
        .gap-input-fake { @apply inline-block border-b-4 border-indigo-200 px-2 mx-1 font-bold text-indigo-900 text-center uppercase min-w-[150px] bg-white h-10 align-middle cursor-pointer hover:bg-indigo-50 transition; }
        .gap-input-fake.revealed { @apply bg-green-100 border-green-500 text-green-800; }

        .question-text-large { font-family: 'Inter', sans-serif; font-size: 2.5rem; line-height: 1.4; font-weight: 700; color: #1f2937; text-align: left; }
        .key-word-large { background-color: #facc15; padding: 8px 30px; border-radius: 12px; font-weight: 900; font-size: 2.5rem; color: #1f2937; text-transform: uppercase; border: 3px solid #eab308; display: inline-block; margin-bottom: 2rem; width: fit-content; }
        .gap-line-large { border-bottom: 5px solid #6366f1; min-width: 300px; display: inline-block; height: 60px; margin: 0 15px; cursor: pointer; transition: 0.2s; vertical-align: bottom; }
        .gap-line-large.revealed { color: #166534; font-weight: 900; font-size: 2.5rem; border-bottom-color: #22c55e; text-align: center; }

        .player-card { @apply p-2 rounded-xl border-2 transition-all flex flex-col items-center justify-center min-h-[110px] bg-white relative shadow-sm; }
        .card-submitted { @apply bg-indigo-50 border-indigo-500 text-indigo-700 shadow-md; }
        .card-grading { @apply bg-white border-gray-400 shadow-lg z-10; }
        .grade-btn { @apply w-8 h-8 rounded-full font-bold text-sm flex items-center justify-center border hover:scale-110 active:scale-95 transition; }
        .grade-0 { @apply border-red-200 text-red-300 hover:bg-red-500 hover:text-white; }
        .grade-1 { @apply border-yellow-200 text-yellow-300 hover:bg-yellow-400 hover:text-white; }
        .grade-2 { @apply border-green-200 text-green-300 hover:bg-green-500 hover:text-white; }
        .grade-0.selected { @apply bg-red-500 text-white border-red-600; }
        .grade-1.selected { @apply bg-yellow-400 text-white border-yellow-500; }
        .grade-2.selected { @apply bg-green-500 text-white border-green-600; }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-center relative">

    <div class="btn-back-wrapper"><button id="nav-back-btn" onclick="teacher.handleBack()" class="btn-back">‚Üê Back to Menu</button></div>

    <div id="app-container">
        
        <div class="flex justify-between items-center p-8 border-b bg-white">
            <h1 class="text-4xl font-extrabold text-gray-900">Use of English <span class="text-indigo-600">Trainer Board</span></h1>
            <div class="flex gap-4">
                <div id="timer-display" class="hidden text-3xl font-mono font-black text-gray-700 bg-gray-100 px-4 py-2 rounded-lg">06:00</div>
                <div id="session-info" class="hidden flex items-center gap-4 bg-gray-50 px-6 py-2 rounded-xl border border-gray-200">
                    <span class="text-gray-400 font-bold text-sm tracking-widest uppercase">Room</span>
                    <span id="pin-display" class="text-4xl font-black text-indigo-600 tracking-widest font-mono">----</span>
                </div>
            </div>
        </div>

        <div id="screen-setup" class="flex-1 flex flex-col justify-center items-center gap-12 p-10">
            <div class="w-full max-w-5xl text-center space-y-6">
                <h2 class="text-3xl font-bold text-gray-700">1. Select Level</h2>
                <div class="grid grid-cols-3 gap-8">
                    <button onclick="teacher.selectLevel('B2')" id="btn-lvl-b2" class="level-select-btn btn-b2-style">B2</button>
                    <button onclick="teacher.selectLevel('C1')" id="btn-lvl-c1" class="level-select-btn btn-c1-style">C1</button>
                    <button onclick="teacher.selectLevel('C2')" id="btn-lvl-c2" class="level-select-btn btn-c2-style">C2</button>
                </div>
            </div>
            <div class="w-full max-w-3xl text-center space-y-6">
                <h2 class="text-3xl font-bold text-gray-700">2. Select Mode</h2>
                <div class="grid grid-cols-2 gap-6">
                    <button onclick="teacher.selectMode('LIVE')" id="opt-live" class="mode-select-btn"><span class="text-6xl mb-4">‚ö°Ô∏è</span><span class="text-3xl font-bold text-gray-800">One by One</span></button>
                    <button onclick="teacher.selectMode('EXAM')" id="opt-exam" class="mode-select-btn"><span class="text-6xl mb-4">üìù</span><span class="text-3xl font-bold text-gray-800">Exam Mode</span></button>
                </div>
            </div>
            <button onclick="teacher.createSession()" id="btn-create" disabled class="mt-8 app-btn bg-indigo-600 text-white text-3xl px-24 py-6 shadow-2xl disabled:opacity-30 disabled:cursor-not-allowed hover:bg-indigo-700">Create Class ‚Üí</button>
            <p id="status-msg" class="text-gray-400 font-medium">Connecting...</p>
        </div>

        <div id="screen-lobby" class="hidden flex-1 flex flex-col items-center p-12">
            <div class="flex flex-col md:flex-row gap-20 items-center justify-center w-full mb-12">
                <div class="flex flex-col items-center bg-white p-8 rounded-3xl shadow-xl border-2 border-indigo-50">
                    <div id="qrcode-container"></div>
                    <p class="text-indigo-500 font-bold mt-6 tracking-widest uppercase mb-2">Scan to Join</p>
                    <p id="lobby-url" class="text-xs text-gray-400 font-mono bg-gray-50 p-2 rounded break-all max-w-[200px] text-center">...</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-400 font-bold mb-4 uppercase tracking-wider text-xl">Or Enter Code</p>
                    <div class="p-10 bg-gray-100 rounded-3xl border-4 border-white shadow-inner"><span id="lobby-pin" class="text-9xl font-black text-gray-800 tracking-widest font-mono">----</span></div>
                </div>
            </div>
            <div class="w-full max-w-6xl bg-indigo-50 rounded-3xl p-10 flex-1 border-2 border-indigo-100"><div class="flex justify-between items-center mb-8"><h3 class="text-2xl font-bold text-indigo-900 uppercase tracking-wider">Class Roster</h3><span class="bg-indigo-200 text-indigo-800 px-5 py-2 rounded-full font-bold text-lg" id="player-count">0 Players</span></div><div id="lobby-player-list" class="flex flex-wrap gap-4"></div></div>
            <button onclick="teacher.startGame()" class="mt-10 app-btn bg-indigo-600 text-white text-3xl px-20 py-6 hover:bg-indigo-700 shadow-xl">Start Game ‚Üí</button>
        </div>

        <div id="screen-game" class="hidden flex-1 flex flex-col p-10">
            <div class="bg-white border-4 border-indigo-50 rounded-[2.5rem] p-12 mb-8 relative shadow-sm text-left">
                <span class="absolute top-8 right-8 bg-gray-100 text-gray-500 font-bold px-4 py-2 rounded-lg text-sm uppercase">Live Mode</span>
                <p id="q-sentence1" class="question-text-large mb-10">Loading...</p>
                <div><span id="q-keyword" class="key-word-large">KEY</span></div>
                <div class="question-text-large flex flex-wrap items-baseline gap-4 mt-8"><span id="q-pre">...</span><span id="q-gap" class="gap-line-large" onclick="teacher.toggleCorrectAnswer(this)"></span><span id="q-post">...</span></div>
            </div>
            <div class="flex justify-between items-center mb-8 px-4">
                <div class="flex gap-6">
                    <button id="btn-reveal" onclick="teacher.revealRound()" class="app-btn bg-amber-400 text-amber-900 hover:bg-amber-500 text-2xl px-10">üëÅ Reveal Answers</button>
                    <button onclick="teacher.toggleLeaderboard()" class="app-btn bg-white border-2 border-gray-200 text-gray-600 hover:bg-gray-50 text-2xl">üèÜ</button>
                </div>
                <div class="flex gap-4">
                    <button id="btn-prev" onclick="teacher.prevAction()" class="app-btn bg-gray-500 text-white hover:bg-gray-600 text-2xl px-8" disabled>‚Üê Prev</button>
                    <button onclick="teacher.nextAction()" class="app-btn bg-indigo-600 text-white hover:bg-indigo-700 text-2xl px-12">Next ‚Üí</button>
                </div>
            </div>
            <div id="player-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6 overflow-y-auto max-h-[400px] p-4"></div>
        </div>

        <div id="screen-exam" class="hidden flex-1 flex flex-col p-8 bg-white overflow-hidden">
            <div class="flex justify-between items-center mb-8 border-b-2 border-gray-100 pb-6">
                <h2 class="text-4xl font-extrabold text-gray-800">Exam Mode</h2>
                <div class="flex gap-4">
                    <button id="btn-reveal-exam" onclick="teacher.revealRound()" class="app-btn bg-amber-500 text-white hover:bg-amber-600 text-xl">Reveal All Answers</button>
                    <button onclick="teacher.toggleLeaderboard()" class="app-btn bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-xl">üèÜ Scores</button>
                </div>
            </div>
            <div id="exam-container" class="flex-1 overflow-y-auto pr-6 pb-20 space-y-12 w-full"></div>
        </div>

        <div id="screen-leaderboard" class="hidden flex-1 flex flex-col p-12 bg-indigo-900 text-white items-center justify-center">
            <h2 class="text-6xl font-black text-center mb-12">üèÜ Final Rankings</h2>
            <div id="leaderboard-list" class="w-full max-w-4xl flex-1 overflow-y-auto pr-4 space-y-6"></div>
            <div class="text-center mt-10"><button onclick="teacher.closeLeaderboard()" class="px-12 py-5 rounded-2xl border-4 border-white/20 hover:bg-white/10 font-bold text-2xl transition">Close Leaderboard</button></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";

        const STUDENT_FILE_NAME = "student.html"; 

        const teacher = {
            supabase: null, sessionID: null,
            config: { level: null, mode: 'LIVE' },
            questions: [], examBatch: [], currentQIndex: -1,
            players: {}, submissions: {}, isRevealed: false,
            timer: null, timeLeft: 360,

            init: function() {
                if (typeof supabase !== 'undefined') {
                    this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    document.getElementById('status-msg').innerText = "System Ready.";
                    document.getElementById('status-msg').classList.add('text-green-500');
                } else { alert("Supabase library not loaded."); }
            },

            handleBack: function() {
                if(!document.getElementById('screen-setup').classList.contains('hidden')) { window.location.href = 'index.html'; } 
                else { window.location.reload(); }
            },

            selectLevel: function(lvl) {
                this.config.level = lvl;
                document.querySelectorAll('.level-select-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(`btn-lvl-${lvl.toLowerCase()}`).classList.add('active');
                document.getElementById('btn-create').disabled = false;
            },

            selectMode: function(m) {
                this.config.mode = m;
                const bLive = document.getElementById('opt-live');
                const bExam = document.getElementById('opt-exam');
                bLive.classList.remove('active'); bExam.classList.remove('active');
                if(m === 'LIVE') bLive.classList.add('active'); else bExam.classList.add('active');
            },

            createSession: async function() {
                document.getElementById('btn-create').innerText = "Generating...";
                const { data: qData, error } = await this.supabase.from('exam_part4').select('*').eq('level', this.config.level);
                if(error || !qData.length) { alert("Error: No questions found."); return; }
                this.questions = qData.sort(() => Math.random() - 0.5);
                this.batch = this.config.mode === 'EXAM' ? this.questions.slice(0, 6) : [];
                // Save Order
                const qIds = this.config.mode === 'EXAM' ? this.batch.map(q => q.id) : this.questions.map(q => q.id);

                const pin = Math.floor(1000 + Math.random() * 9000).toString();
                // FIX: Removed 'level' from insert
                const { data: sData } = await this.supabase.from('game_sessions').insert([{ 
                    pin: pin, 
                    status: 'LOBBY', 
                    mode: this.config.mode, 
                    question_queue: qIds 
                }]).select().single();
                
                this.sessionID = sData.id;
                document.getElementById('pin-display').innerText = pin;
                document.getElementById('lobby-pin').innerText = pin;
                this.generateQR(pin);
                this.subscribeToPlayers();
                this.switchScreen('screen-lobby');
            },

            generateQR: function(pin) {
                const currentPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                const joinUrl = `${currentPath}/${STUDENT_FILE_NAME}`;
                document.getElementById('lobby-url').innerText = joinUrl.replace('https://','');
                document.getElementById("qrcode-container").innerHTML = "";
                new QRCode(document.getElementById("qrcode-container"), { text: `${joinUrl}?pin=${pin}`, width: 200, height: 200, colorDark : "#4f46e5", colorLight : "#ffffff" });
            },

            subscribeToPlayers: function() {
                this.supabase.channel('players').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'players', filter: `session_id=eq.${this.sessionID}` }, 
                    (payload) => { this.players[payload.new.id] = payload.new; this.renderLobby(); }).subscribe();
            },

            renderLobby: function() {
                const list = document.getElementById('lobby-player-list');
                list.innerHTML = '';
                const pIds = Object.keys(this.players);
                document.getElementById('player-count').innerText = `${pIds.length} Joined`;
                pIds.forEach(id => { list.innerHTML += `<div class="px-6 py-3 bg-white rounded-xl shadow-sm text-indigo-900 font-bold border border-indigo-100 text-lg animate-bounce">${this.players[id].nickname}</div>`; });
            },

            startGame: async function() {
                document.getElementById('session-info').classList.remove('hidden');
                if (this.config.mode === 'LIVE') { this.nextAction(); } 
                else {
                    await this.supabase.from('game_sessions').update({ status: 'ACTIVE', current_question_ids: this.batch.map(q => q.id) }).eq('id', this.sessionID);
                    this.renderExamMode();
                    this.switchScreen('screen-exam');
                    this.subscribeToBatchSubmissions();
                    this.startTimer();
                }
            },

            startTimer: function() {
                document.getElementById('timer-display').classList.remove('hidden');
                this.timeLeft = 360; 
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    const m = Math.floor(this.timeLeft / 60);
                    const s = this.timeLeft % 60;
                    const display = document.getElementById('timer-display');
                    display.innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    if(this.timeLeft <= 60) display.classList.add('text-red-500');
                    if(this.timeLeft <= 0) { clearInterval(this.timer); display.innerText = "00:00"; }
                }, 1000);
            },

            nextAction: function() {
                this.currentQIndex++;
                if(this.currentQIndex >= this.questions.length) { alert("End of questions"); return; }
                this.loadQuestionToBoard(this.questions[this.currentQIndex]);
            },

            prevAction: function() {
                if(this.currentQIndex <= 0) return;
                this.currentQIndex--;
                this.loadQuestionToBoard(this.questions[this.currentQIndex]);
            },

            loadQuestionToBoard: async function(q) {
                this.submissions = {}; 
                this.isRevealed = false; 
                document.getElementById('q-sentence1').innerText = q.sentence1;
                document.getElementById('q-keyword').innerText = q.key_word;
                document.getElementById('q-pre').innerText = q.sentence2_pre;
                document.getElementById('q-post').innerText = q.sentence2_post;
                const gap = document.getElementById('q-gap');
                gap.innerText = ""; gap.className = "gap-line-large"; gap.dataset.answer = q.answer; 
                const btn = document.getElementById('btn-reveal');
                btn.innerHTML = "üëÅ Reveal Answers";
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-amber-400');
                btn.disabled = false;
                document.getElementById('btn-prev').disabled = this.currentQIndex === 0;
                this.renderGrid();
                this.switchScreen('screen-game');
                await this.supabase.from('game_sessions').update({ status: 'ACTIVE', current_question_ids: [q.id] }).eq('id', this.sessionID);
                this.subscribeToSubmissions(q.id);
            },

            renderExamMode: function() {
                const container = document.getElementById('exam-container');
                container.innerHTML = '';
                this.batch.forEach((q, idx) => {
                    const html = `
                    <div class="flex flex-col xl:flex-row gap-8 w-full border-b-2 border-gray-100 pb-8">
                        <div class="p4-card w-full xl:w-1/2 flex-none">
                            <div class="mb-3 text-gray-500 font-bold text-sm uppercase">Question ${idx+1}</div>
                            <p class="mb-4 text-2xl font-bold text-gray-800 text-left">${q.sentence1}</p>
                            <span class="key-word-small text-lg w-fit">${q.key_word}</span>
                            <div class="flex flex-wrap items-center gap-2 mt-4 text-2xl text-gray-700 font-bold">
                                <span>${q.sentence2_pre}</span>
                                <span class="gap-input-fake" onclick="teacher.toggleCorrectAnswer(this)" data-answer="${q.answer}"></span>
                                <span>${q.sentence2_post}</span>
                            </div>
                        </div>
                        <div id="grid-q-${q.id}" class="w-full xl:w-1/2 grid grid-cols-2 md:grid-cols-3 gap-4 content-start"></div>
                    </div>`;
                    container.innerHTML += html;
                    setTimeout(() => this.renderExamGrid(q.id), 0);
                });
            },

            toggleCorrectAnswer: function(el) {
                if(el.classList.contains('revealed')) { el.innerText = ""; el.classList.remove('revealed'); } 
                else { el.innerText = el.dataset.answer; el.classList.add('revealed'); }
            },

            subscribeToSubmissions: function(qId) {
                if(this.subChannel) this.supabase.removeChannel(this.subChannel);
                this.subChannel = this.supabase.channel('subs').on('postgres_changes', { event: '*', schema: 'public', table: 'submissions', filter: `question_id=eq.${qId}` }, 
                    (payload) => { this.submissions[payload.new.player_id] = payload.new; this.renderGrid(); }).subscribe();
            },

            subscribeToBatchSubmissions: function() {
                this.supabase.channel('exam_subs').on('postgres_changes', { event: '*', schema: 'public', table: 'submissions' }, 
                    (payload) => {
                         const subKey = `${payload.new.player_id}_${payload.new.question_id}`;
                         this.submissions[subKey] = payload.new;
                         this.renderExamGrid(payload.new.question_id);
                    }).subscribe();
            },

            revealRound: async function() {
                this.isRevealed = true;
                const isLive = !document.getElementById('screen-game').classList.contains('hidden');
                if (isLive) {
                     this.renderGrid();
                     const btn = document.getElementById('btn-reveal');
                     btn.innerHTML = "üîí Revealed";
                     btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                     btn.disabled = true;
                } else {
                     this.batch.forEach(q => this.renderExamGrid(q.id));
                     const btn = document.getElementById('btn-reveal-exam');
                     btn.innerText = "Revealed";
                     btn.className = "app-btn bg-gray-400 text-white cursor-not-allowed text-xl";
                     btn.disabled = true;
                }
                await this.supabase.from('game_sessions').update({ status: 'REVEAL' }).eq('id', this.sessionID);
            },

            grade: async function(playerId, qId, points) {
                if (this.config.mode === 'LIVE') {
                    if(this.submissions[playerId]) this.submissions[playerId].points = points;
                    this.renderGrid();
                } else {
                    const key = `${playerId}_${qId}`;
                    if(this.submissions[key]) this.submissions[key].points = points;
                    this.renderExamGrid(qId);
                }
                await this.supabase.from('submissions').update({ points: points }).match({ player_id: playerId, question_id: qId });
            },

            renderGrid: function() {
                const grid = document.getElementById('player-grid');
                grid.innerHTML = '';
                Object.values(this.players).forEach(p => {
                    const sub = this.submissions[p.id];
                    grid.appendChild(this.createCard(p, sub, null));
                });
            },

            renderExamGrid: function(qId) {
                const grid = document.getElementById(`grid-q-${qId}`);
                if(!grid) return;
                grid.innerHTML = '';
                Object.values(this.players).forEach(p => {
                    const sub = this.submissions[`${p.id}_${qId}`];
                    grid.appendChild(this.createCard(p, sub, qId));
                });
            },

            createCard: function(p, sub, qId) {
                const card = document.createElement('div');
                card.className = "player-card";
                if (!this.isRevealed) {
                    if (sub) {
                        card.classList.add('card-submitted');
                        card.innerHTML = `<div class="text-4xl mb-2">‚úÖ</div><div class="font-bold text-xl text-indigo-700">${p.nickname}</div>`;
                    } else {
                        card.innerHTML = `<div class="font-bold text-lg text-gray-700">${p.nickname}</div><div class="text-xs uppercase mt-2 tracking-widest text-gray-300 animate-pulse">Thinking...</div>`;
                    }
                } else {
                    card.classList.add('card-grading');
                    const answerText = (sub && sub.answer_text) ? sub.answer_text.toUpperCase() : "-";
                    const pts = sub ? sub.points : null;
                    const qIdParam = qId ? `'${qId}'` : `'${this.questions[this.currentQIndex].id}'`;
                    card.innerHTML = `
                        <div class="w-full text-center border-b border-gray-100 pb-2 mb-2 font-bold text-gray-400 text-xs">${p.nickname}</div>
                        <div class="text-xl font-black text-gray-800 mb-2 leading-tight">${answerText}</div>
                        <div class="flex gap-2 mt-auto">
                            <button onclick="teacher.grade('${p.id}', ${qIdParam}, 0)" class="grade-btn grade-0 ${pts===0?'selected':''}">0</button>
                            <button onclick="teacher.grade('${p.id}', ${qIdParam}, 1)" class="grade-btn grade-1 ${pts===1?'selected':''}">1</button>
                            <button onclick="teacher.grade('${p.id}', ${qIdParam}, 2)" class="grade-btn grade-2 ${pts===2?'selected':''}">2</button>
                        </div>`;
                }
                return card;
            },

            toggleLeaderboard: async function() {
                const playerIds = Object.keys(this.players);
                if (playerIds.length === 0) return;

                const { data } = await this.supabase
                    .from('submissions')
                    .select('player_id, points')
                    .in('player_id', playerIds);

                const scores = {};
                playerIds.forEach(pid => scores[pid] = 0);

                if(data) {
                    data.forEach(s => {
                        if(s.points) scores[s.player_id] += s.points;
                    });
                }

                const sortedPIDs = Object.keys(scores).sort((a,b) => scores[b] - scores[a]);
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '';
                
                sortedPIDs.forEach((pid, index) => {
                    const p = this.players[pid];
                    const medals = ['ü•á','ü•à','ü•â'];
                    const badge = index < 3 ? medals[index] : `<span class="font-bold text-slate-400">#${index+1}</span>`;
                    list.innerHTML += `
                        <div class="flex items-center p-6 bg-indigo-800 rounded-2xl border border-indigo-700 shadow-lg">
                            <div class="text-4xl mr-6 w-16 text-center">${badge}</div>
                            <div class="flex-1 text-3xl font-bold">${p.nickname}</div>
                            <div class="text-5xl font-black text-amber-400">${scores[pid]}</div>
                        </div>`;
                });
                this.switchScreen('screen-leaderboard');
            },

            closeLeaderboard: function() { this.switchScreen(this.config.mode === 'LIVE' ? 'screen-game' : 'screen-exam'); },

            switchScreen: function(id) {
                ['screen-setup','screen-lobby','screen-game','screen-exam','screen-leaderboard'].forEach(s => document.getElementById(s).classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            }
        };

        teacher.init();
    </script>
</body>
</html>