<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Management Tool</title>
    
    <link rel="stylesheet" href="global.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; 
            min-height: 100vh;
            padding: 20px;
        }

        /* Main Container */
        #tool-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 20px; 
        }

        /* Student Card Styling */
        .student-card {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 8px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; 
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            height: 220px; 
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        /* Highlights */
        .student-card.highlighted {
            background-color: #fcd34d; 
            border: none; 
            box-shadow: 0 0 35px rgba(253, 224, 71, 1); 
            animation: pulse-highlight 1.5s infinite alternate;
        }

        .student-card.absent {
            background-color: #e5e7eb; 
            opacity: 0.7;
            filter: grayscale(10%);
        }

        .student-card button {
            transition: background-color 0.1s;
        }

        /* Avatar */
        .avatar {
            width: 80px; 
            height: 80px; 
            border-radius: 12px; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px; 
            font-weight: 700;
            color: white;
            margin-bottom: 4px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            overflow: hidden; 
        }

        .avatar img {
            width: 100%; 
            height: 100%;
            image-rendering: auto; 
            transform: translate3d(0, 0, 0); 
        }
        
        /* Text Utils */
        .points-text {
            font-size: 2.25rem; 
            line-height: 1;
            font-weight: 800;
            color: #1f2937;
            margin: 2px 0; 
        }
        .name-text {
            font-size: 0.9rem; 
            font-weight: 600;
            color: #374151;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            width: 100%;
            margin-bottom: 0; 
        }

        .student-card button[data-action="absent"] {
            padding-top: 2px; 
            padding-bottom: 2px; 
            font-size: 0.75rem; 
        }

        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 20px rgba(253, 224, 71, 0.8); transform: scale(1); }
            50% { transform: scale(1.01); } 
            100% { box-shadow: 0 0 35px rgba(253, 224, 71, 1); transform: scale(1); }
        }

        /* --- MODAL SYSTEM --- */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
        }
        
        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            transform: scale(0.95);
            transition: transform 0.2s ease-out;
        }

        .modal-backdrop.active .modal-content {
            transform: scale(1);
        }
        
        /* Teams & Timer Modal Specifics */
        .modal-content.teams-result, .modal-content.timer-modal {
            max-width: 700px;
            max-height: 85vh; 
            display: flex;
            flex-direction: column;
            padding: 0; 
            overflow: hidden; 
        }

        .teams-header {
            padding: 20px;
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .teams-footer {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background-color: white;
        }
        
        #text-modal-content {
            overflow-y: auto; 
            padding: 20px;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        .team-card {
            padding: 12px;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s;
        }
        .team-card:hover { transform: scale(1.01); }
        .team-card-members { font-size: 1.1rem; line-height: 1.4; }
        
        /* Prevent Body Scroll when Modal is Open */
        body.modal-open {
            overflow: hidden;
        }
        
        /* Timer Big Text */
        .timer-display-big {
            font-family: monospace;
            font-size: 5rem;
            font-weight: 800;
            color: #1e293b;
            text-align: center;
            margin: 20px 0;
        }
        
        /* Preset Buttons */
        .preset-btn {
            background-color: #e2e8f0;
            color: #475569;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.15s;
        }
        .preset-btn:hover { background-color: #cbd5e1; }
        .preset-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="classroom-theme">
    <div id="tool-container">
        
        <header class="flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-200 mb-4">
    
            <a href="index.html" class="btn-back px-4 py-2 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 transition duration-150 no-underline mb-2 sm:mb-0">
                ← Back
            </a>

            <div class="flex-grow text-center">
                <h1 class="text-3xl font-extrabold text-gray-800 mb-2 sm:mb-0">
                    Classroom Manager
                </h1>
                
                <div id="saved-classes-container" class="hidden mt-2 flex justify-center items-center gap-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">Resume:</span>
                    <select id="saved-classes-select" onchange="window.loadSelectedClass()" class="text-sm border-2 border-indigo-100 rounded-lg px-2 py-1 text-indigo-600 font-bold focus:outline-none focus:border-indigo-500 cursor-pointer">
                        <option value="">Select a class...</option>
                    </select>
                </div>
            </div>

            <div class="flex flex-wrap justify-center sm:justify-end space-x-2 sm:space-x-3 items-center">
                <button id="load-button" onclick="document.getElementById('file-upload').click()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-150">
                    Load New
                </button>
                <input type="file" id="file-upload" accept=".csv, .txt" style="display: none;" onchange="window.handleFileUpload(event)">

                <button id="save-button" onclick="window.saveClass()" disabled
                        class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-150 disabled:opacity-50">
                    Save File
                </button>
                
                <button onclick="window.wipeCurrentData()" class="px-3 py-2 text-red-400 hover:text-red-600 text-sm font-bold border border-transparent hover:border-red-100 rounded-lg" title="Delete this saved class from memory">
                    ✕
                </button>
            </div>

        </header>

        <div id="main-content">
            <h2 id="class-name-label" class="text-xl font-bold text-gray-700 mb-4">No Class Loaded</h2>
            
            <div id="student-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
            </div>
            
            <div class="flex flex-wrap justify-between items-center gap-4 p-4 bg-gray-100 rounded-xl shadow-inner border border-gray-200">
                
                <div class="flex flex-wrap items-center gap-3">
                    <button id="random-button" onclick="window.pickRandomStudent()" disabled
                            class="px-6 py-3 text-lg font-extrabold bg-purple-600 text-white rounded-xl shadow-lg hover:bg-purple-700 transition duration-150 disabled:opacity-50">
                        &#127922; Pick
                    </button>
                    
                    <button id="plus-all-button" onclick="window.adjustAllPoints(1)" disabled
                            class="px-3 py-3 bg-sky-500 text-white font-bold rounded-lg hover:bg-sky-600 transition duration-150 disabled:opacity-50 shadow-sm"
                            title="Add 1 to Everyone">
                        +1 All
                    </button>
                    <button id="minus-all-button" onclick="window.adjustAllPoints(-1)" disabled
                            class="px-3 py-3 bg-sky-500 text-white font-bold rounded-lg hover:bg-sky-600 transition duration-150 disabled:opacity-50 shadow-sm"
                            title="Remove 1 from Everyone">
                        -1 All
                    </button>

                    <p id="current-pick-label" class="text-2xl font-semibold text-gray-800 hidden sm:block ml-2 border-l-2 border-gray-300 pl-4">
                        Ready!
                    </p>
                </div>
                
                <div class="flex flex-wrap items-center gap-3">
                    <button id="timer-modal-btn" onclick="window.openTimerModal()" class="px-4 py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition shadow-sm">
                        ⏱ Timer
                    </button>

                    <button id="teams-button" onclick="window.showGroupSizeOptions()" disabled
                            class="px-4 py-2 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition duration-150 disabled:opacity-50 shadow-sm">
                        &#128101; Teams!
                    </button>
                    
                    <button id="clear-button" onclick="window.clearAllPoints()" disabled
                            class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 transition duration-150 disabled:opacity-50">
                        Clear Points
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <div id="group-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Select Group Size</h3>
            <div id="group-buttons" class="flex justify-around space-x-2"></div>
            <button onclick="closeModal('group-modal')"
                    class="mt-6 w-full px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 font-bold">
                Close
            </button>
        </div>
    </div>
    
    <div id="text-modal" class="modal-backdrop">
        <div class="modal-content teams-result">
            <div class="teams-header">
                <h3 id="text-modal-title" class="text-2xl font-extrabold text-gray-800 text-center">Random Teams</h3>
            </div>
            
            <div id="text-modal-content">
            </div>

            <div class="teams-footer">
                <button onclick="closeModal('text-modal')"
                        class="w-full px-4 py-3 bg-indigo-500 text-white font-bold rounded-xl hover:bg-indigo-600 shadow-lg transition transform active:scale-95">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <div id="timer-modal" class="modal-backdrop">
        <div class="modal-content timer-modal">
            <div class="teams-header bg-indigo-50 border-indigo-100">
                <h3 class="text-2xl font-extrabold text-indigo-800 text-center">Classroom Timer</h3>
            </div>
            
            <div class="p-6 flex flex-col items-center justify-center flex-grow">
                <div id="timer-display-big" class="timer-display-big">00:00</div>
                
                <div class="flex flex-wrap justify-center gap-2 mb-6">
                    <button class="preset-btn" onclick="setTimer(10)">10s</button>
                    <button class="preset-btn" onclick="setTimer(30)">30s</button>
                    <button class="preset-btn" onclick="setTimer(60)">1m</button>
                    <button class="preset-btn" onclick="setTimer(90)">1m30s</button>
                    <button class="preset-btn" onclick="setTimer(120)">2m</button>
                    <button class="preset-btn" onclick="setTimer(300)">5m</button>
                </div>
                
                <div class="flex gap-4 w-full">
                    <button id="timer-start-btn" onclick="startTimer()" class="flex-1 py-3 bg-green-500 text-white font-bold rounded-xl text-lg hover:bg-green-600 shadow-lg">Start</button>
                    <button onclick="resetTimer()" class="flex-1 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl text-lg hover:bg-gray-300">Reset</button>
                </div>
            </div>

            <div class="teams-footer">
                <button onclick="closeModal('timer-modal'); resetTimer();"
                        class="w-full px-4 py-3 bg-indigo-500 text-white font-bold rounded-xl hover:bg-indigo-600 shadow-lg transition">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-red-600">Confirmation</h3>
            <p id="confirm-modal-content" class="mb-6 text-gray-700">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 font-bold">Cancel</button>
                <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 space-y-2"></div>

    <script>
        // --- GLOBAL VARIABLES ---
        let students = [];
        let cardWidgets = {};
        let pickedStudents = [];
        let currentFilename = ""; 
        let toneReady = false; // Initialize Tone flag at the top scope
        const STORAGE_PREFIX = "cls_mgr_"; 
        
        // --- UI References (Defined early so they are available) ---
        const ui = {
            grid: document.getElementById('student-grid'),
            classNameLabel: document.getElementById('class-name-label'),
            currentPickLabel: document.getElementById('current-pick-label'),
            toastContainer: document.getElementById('toast-container'),
            saveButton: document.getElementById('save-button'),
            randomButton: document.getElementById('random-button'),
            teamsButton: document.getElementById('teams-button'),
            plusAllButton: document.getElementById('plus-all-button'),
            minusAllButton: document.getElementById('minus-all-button'),
            clearButton: document.getElementById('clear-button'),
            groupModal: document.getElementById('group-modal'),
            groupButtons: document.getElementById('group-buttons'),
            textModal: document.getElementById('text-modal'),
            textModalTitle: document.getElementById('text-modal-title'),
            textModalContent: document.getElementById('text-modal-content'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalContent: document.getElementById('confirm-modal-content'),
            confirmOk: document.getElementById('confirm-ok'),
            confirmCancel: document.getElementById('confirm-cancel')
        };

        const AVATAR_COLORS = [
            '#EF4444', '#F97316', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#F43F5E'
        ];
        
        const MAX_AVATARS_AVAILABLE = 13; 
        const AVATAR_POOL = Array.from({ length: MAX_AVATARS_AVAILABLE }, (_, i) => `avatars/img_${i + 1}.png`);
        
        function generateAvatarPlaceholder(name) {
            const initial = name[0].toUpperCase();
            const colorIndex = name.charCodeAt(0) % AVATAR_COLORS.length;
            const color = AVATAR_COLORS[colorIndex];
            return { initial, color };
        }

        // --- Auto-Save Functions ---
        function autoSave() {
            if (!currentFilename) return;
            const data = {
                students: students,
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_PREFIX + currentFilename, JSON.stringify(data));
            updateSavedClassesList();
        }

        function updateSavedClassesList() {
            const select = document.getElementById('saved-classes-select');
            const container = document.getElementById('saved-classes-container');
            select.innerHTML = '<option value="">Select a class...</option>';
            
            let hasSaves = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(STORAGE_PREFIX)) {
                    const filename = key.replace(STORAGE_PREFIX, '');
                    const option = document.createElement('option');
                    option.value = filename;
                    option.textContent = filename;
                    select.appendChild(option);
                    hasSaves = true;
                }
            }
            container.classList.toggle('hidden', !hasSaves);
            if (currentFilename) select.value = currentFilename;
        }

        window.loadSelectedClass = function() {
            const select = document.getElementById('saved-classes-select');
            const filename = select.value;
            if (!filename) return;
            
            const savedData = localStorage.getItem(STORAGE_PREFIX + filename);
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    students = parsed.students;
                    currentFilename = filename;
                    ui.classNameLabel.textContent = `${currentFilename}`;
                    pickedStudents = [];
                    drawStudents();
                    showToast(`Resumed ${filename}!`, "success");
                } catch (e) {
                    console.error("Save corrupted", e);
                }
            }
        };

        window.wipeCurrentData = function() {
            if (!currentFilename) return;
            if(confirm(`Delete saved data for "${currentFilename}"?`)) {
                localStorage.removeItem(STORAGE_PREFIX + currentFilename);
                location.reload(); 
            }
        };

        // --- Sound Effects Setup ---
        // Global listener to start audio context on first click
        document.addEventListener('click', async () => {
            if (!toneReady && window.Tone) {
                await Tone.start();
                toneReady = true;
                console.log("Audio Context Started");
            }
        }, { once: true });

        const POSITIVE_SOUND = () => {
            if (!toneReady) return;
            try {
                if (Tone.context.state !== 'running') Tone.context.resume();
                const synth = new Tone.MembraneSynth().toDestination();
                synth.triggerAttackRelease("G6", "16n", Tone.now(), 0.8);
                synth.triggerAttackRelease("C7", "16n", Tone.now() + 0.1, 0.8);
            } catch (e) {}
        };

        const NEGATIVE_SOUND = () => {
            if (!toneReady) return;
            try {
                if (Tone.context.state !== 'running') Tone.context.resume();
                const synth = new Tone.MembraneSynth().toDestination();
                synth.triggerAttackRelease("C3", "8n", Tone.now(), 0.8);
            } catch (e) {}
        };
        
        // BELL SOUND for Timer
        const BELL_SOUND = () => {
            if (!toneReady) return;
            try {
                if (Tone.context.state !== 'running') Tone.context.resume();
                // Simple bell-like synth
                const bell = new Tone.MetalSynth({
                    harmonicity: 12,
                    resonance: 800,
                    modulationIndex: 20,
                    envelope: { decay: 0.4 },
                    volume: -5
                }).toDestination();
                bell.triggerAttackRelease(200, 0.1); 
            } catch(e) {}
        };

        function playSound(amount) {
            if (amount > 0) POSITIVE_SOUND();
            else if (amount < 0) NEGATIVE_SOUND();
        }
        
        // --- TIMER LOGIC ---
        let timerInterval = null;
        let timerSeconds = 0;
        
        window.openTimerModal = function() {
            openModal('timer-modal');
            // Default reset view
            if (!timerInterval && timerSeconds === 0) resetTimer();
        };
        
        window.setTimer = function(seconds) {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            timerSeconds = seconds;
            updateTimerDisplay(timerSeconds);
            document.getElementById('timer-start-btn').textContent = "Start";
            document.getElementById('timer-start-btn').classList.remove('bg-red-500', 'hover:bg-red-600');
            document.getElementById('timer-start-btn').classList.add('bg-green-500', 'hover:bg-green-600');
        };
        
        window.startTimer = function() {
            const btn = document.getElementById('timer-start-btn');
            
            if (timerInterval) {
                // Pause
                clearInterval(timerInterval);
                timerInterval = null;
                btn.textContent = "Resume";
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                // Start
                if(timerSeconds <= 0) return;
                
                btn.textContent = "Pause";
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
                
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    updateTimerDisplay(timerSeconds);
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        BELL_SOUND(); // Play sound
                        btn.textContent = "Start";
                        btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                        btn.classList.add('bg-green-500', 'hover:bg-green-600');
                        showToast("Time's Up!", "warning");
                    }
                }, 1000);
            }
        };
        
        window.resetTimer = function() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            timerSeconds = 0;
            updateTimerDisplay(0);
            const btn = document.getElementById('timer-start-btn');
            btn.textContent = "Start";
            btn.classList.remove('bg-red-500', 'hover:bg-red-600');
            btn.classList.add('bg-green-500', 'hover:bg-green-600');
        };
        
        function updateTimerDisplay(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            document.getElementById('timer-display-big').textContent = `${m}:${s}`;
        }

        // --- Improved Modal Functions ---
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function showToast(message, type = 'info') {
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-orange-500' };
            const color = colors[type] || colors.info;
            const toast = document.createElement('div');
            toast.className = `p-3 text-white rounded-lg shadow-xl ${color} transition-opacity duration-300`;
            toast.textContent = message;
            ui.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showTextModal(title, text) {
            ui.textModalTitle.textContent = title;
            ui.textModalContent.innerHTML = text; 
            openModal('text-modal');
        }

        function showConfirmationModal(title, text, callback) {
            ui.confirmModalTitle.textContent = title;
            ui.confirmModalContent.textContent = text;
            openModal('confirm-modal');

            const handleConfirm = () => { closeModal('confirm-modal'); cleanup(); callback(true); };
            const handleCancel = () => { closeModal('confirm-modal'); cleanup(); callback(false); };
            const cleanup = () => {
                ui.confirmOk.removeEventListener('click', handleConfirm);
                ui.confirmCancel.removeEventListener('click', handleCancel);
            };
            ui.confirmOk.addEventListener('click', handleConfirm);
            ui.confirmCancel.addEventListener('click', handleCancel);
        }

        // --- Logic ---

        function getStudentDataByName(name) { return students.find(s => s.name === name); }

        function toggleActionButtons(enable) {
            const buttons = [ui.saveButton, ui.randomButton, ui.teamsButton, ui.plusAllButton, ui.minusAllButton, ui.clearButton];
            buttons.forEach(btn => btn.disabled = !enable);
        }

        function renderStudentCard(student) {
            const card = document.createElement('div');
            card.id = `card-${student.name.replace(/\s/g, '-')}`;
            card.className = `student-card ${student.absent ? 'absent' : ''} ${student.highlighted ? 'highlighted' : ''}`;
            const avatarData = student.avatarData || generateAvatarPlaceholder(student.name);
            const imagePath = student.avatarPath; 
            
            let avatarHTML = `
                <div class="avatar" style="background-color: ${avatarData.color};">
                    <img src="${imagePath}" alt="${student.name[0]}" onerror="this.parentElement.innerHTML='${avatarData.initial}'; this.parentElement.style.backgroundColor='${avatarData.color}'">
                </div>
            `;
            
            card.innerHTML = `
                ${avatarHTML}
                <div class="points-text" data-points>${student.points}</div>
                <div class="name-text font-bold mb-2">${student.name}</div>
                <div class="flex space-x-2 mt-auto w-full">
                    <button class="flex-1 px-2 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm" ${student.absent ? 'disabled' : ''} onclick="window.adjustIndividualPoints('${student.name}', 1)">+1</button>
                    <button class="flex-1 px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" ${student.absent ? 'disabled' : ''} onclick="window.adjustIndividualPoints('${student.name}', -1)">-1</button>
                </div>
                <button data-action="absent" class="w-full mt-2 px-2 py-1 text-sm rounded-md transition duration-150 ${student.absent ? 'bg-gray-400 text-gray-800 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}" onclick="window.toggleAbsence('${student.name}')">
                    ${student.absent ? 'Mark Present' : 'Mark Absent'}
                </button>
            `;
            cardWidgets[student.name] = { element: card, data: student };
            return card;
        }

        function updateStudentCardUI(studentName) {
            const widget = cardWidgets[studentName];
            if (!widget) return;
            const card = widget.element;
            const data = widget.data;
            card.querySelector('[data-points]').textContent = data.points;
            card.classList.toggle('absent', data.absent);
            card.classList.toggle('highlighted', data.highlighted);
            card.querySelectorAll('.flex > button').forEach(btn => btn.disabled = data.absent);
            const absentBtn = card.querySelector('[data-action="absent"]');
            if (absentBtn) {
                absentBtn.textContent = data.absent ? 'Mark Present' : 'Mark Absent';
                absentBtn.classList.toggle('bg-gray-400', data.absent);
                absentBtn.classList.toggle('bg-gray-300', !data.absent);
            }
        }
        
        function drawStudents() {
            ui.grid.innerHTML = '';
            cardWidgets = {}; 
            if (students.length === 0) {
                ui.grid.innerHTML = '<p class="col-span-full text-center text-gray-500 italic">No students loaded. Use the "Load Class" button above.</p>';
                toggleActionButtons(false);
                return;
            }
            students.forEach(student => ui.grid.appendChild(renderStudentCard(student)));
            toggleActionButtons(true);
        }

        // --- LOADING LOGIC (Modified for Resume) ---
        function loadClassFromContent(filename, content) {
            students = [];
            const lines = content.split('\n').filter(line => line.trim().length > 0);
            const shuffledPaths = [...AVATAR_POOL].sort(() => Math.random() - 0.5);
            let pathIndex = 0;

            lines.forEach((line) => {
                const firstColumn = line.split(',')[0].trim();
                if (firstColumn) {
                    const parts = firstColumn.split('\t'); 
                    const name = parts[0];
                    const points = parseInt(parts[1]) || 0; 
                    const absent = parts[2] === 'true'; 
                    students.push({
                        name: name, points: points, absent: absent,
                        avatarData: generateAvatarPlaceholder(name),
                        avatarPath: shuffledPaths[pathIndex++ % shuffledPaths.length], 
                        highlighted: false
                    });
                }
            });

            if (students.length > 0) {
                currentFilename = filename;
                ui.classNameLabel.textContent = `${filename}`;
                pickedStudents = [];
                drawStudents();
                showToast(`Loaded ${students.length} students.`, 'success');
                autoSave(); // Save this as a new slot immediately
            } else {
                ui.classNameLabel.textContent = "No Class Loaded";
                showToast("No valid students found.", 'error');
            }
        }

        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const filename = file.name;
            // Check if we have a save file for this specific filename
            const savedData = localStorage.getItem(STORAGE_PREFIX + filename);
            
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    students = parsed.students;
                    currentFilename = filename;
                    ui.classNameLabel.textContent = `${currentFilename} (Resumed)`;
                    pickedStudents = [];
                    drawStudents();
                    updateSavedClassesList(); // Refresh dropdown
                    showToast("Resumed previous session!", 'success');
                    return; // Stop here, don't parse the file
                } catch(e) { }
            }

            // Parse fresh if no save exists
            const reader = new FileReader();
            reader.onload = (e) => loadClassFromContent(file.name, e.target.result);
            reader.readAsText(file);
        };
        
        window.saveClass = function() {
            if (students.length === 0) return;
            const header = "Name,Points,Absent\n";
            const rows = students.map(s => `${s.name},${s.points},${s.absent}`).join('\n');
            const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', currentFilename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- Actions with AutoSave ---
        window.adjustAllPoints = function(amount) {
            let updated = false;
            students.forEach(student => {
                if (!student.absent) {
                    student.points += amount;
                    updateStudentCardUI(student.name);
                    updated = true;
                }
            });
            if (updated) playSound(amount);
            showToast(`${amount > 0 ? '+' : ''}${amount} point(s) to everyone!`, 'info');
            autoSave();
        };

        window.clearAllPoints = function() {
            showConfirmationModal("Clear All Points", "Are you sure? This cannot be undone.", (confirmed) => {
                if (confirmed) {
                    students.forEach(s => { s.points = 0; updateStudentCardUI(s.name); });
                    showToast("All points cleared!", 'info');
                    autoSave();
                }
            });
        };

        window.toggleAbsence = function(name) {
            const student = getStudentDataByName(name);
            if (student) {
                student.absent = !student.absent;
                updateStudentCardUI(name);
                autoSave();
            }
        };

        window.adjustIndividualPoints = function(name, amount) {
            const student = getStudentDataByName(name);
            if (student && !student.absent) {
                student.points += amount;
                updateStudentCardUI(name);
                playSound(amount);
                autoSave();
            }
        };

        window.pickRandomStudent = function() {
            const activeStudents = students.filter(s => !s.absent);
            if (activeStudents.length === 0) return;
            if (pickedStudents.length === activeStudents.length) {
                pickedStudents = [];
                students.forEach(s => { 
                    if(s.highlighted) { s.highlighted = false; updateStudentCardUI(s.name); } 
                });
            }
            const availableStudents = activeStudents.filter(s => !pickedStudents.includes(s.name));
            const chosen = availableStudents[Math.floor(Math.random() * availableStudents.length)];
            pickedStudents.push(chosen.name);
            
            students.forEach(s => { 
                if(s.highlighted) { s.highlighted = false; updateStudentCardUI(s.name); } 
            });
            chosen.highlighted = true;
            updateStudentCardUI(chosen.name);
            ui.currentPickLabel.textContent = `Picked: ${chosen.name}`;
            ui.currentPickLabel.classList.remove('hidden', 'sm:hidden');
        };
        
        window.showGroupSizeOptions = function() {
            openModal('group-modal');
            ui.groupButtons.innerHTML = '';
            const activeCount = students.filter(s => !s.absent).length;
            if (activeCount < 2) {
                ui.groupButtons.innerHTML = '<p class="text-red-500">Need 2+ students.</p>';
                return;
            }
            const maxGroupSize = Math.min(6, Math.floor(activeCount / 2));
            for (let size = 2; size <= maxGroupSize; size++) {
                const btn = document.createElement('button');
                btn.textContent = size;
                btn.className = 'px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 flex-1 font-bold';
                btn.onclick = () => { closeModal('group-modal'); window.createRandomGroups(size); };
                ui.groupButtons.appendChild(btn);
            }
        };

        window.createRandomGroups = function(groupSize) {
            let activeStudents = students.filter(s => !s.absent);
            activeStudents.sort(() => Math.random() - 0.5);
            const groups = [];
            for (let i = 0; i < activeStudents.length; i += groupSize) {
                groups.push(activeStudents.slice(i, i + groupSize));
            }
            let groupHtml = '';
            groups.forEach((group, i) => {
                const names = group.map(s => s.name);
                const color = AVATAR_COLORS[i % AVATAR_COLORS.length];
                groupHtml += `
                    <div class="team-card" style="background-color: ${color};">
                        <div class="team-card-members">Team ${i + 1}: ${names.join(', ')}</div>
                    </div>
                `;
            });
            showTextModal("Team Assignments", groupHtml);
        };

        window.onload = function() { 
            drawStudents();
            updateSavedClassesList(); // Init Dropdown
        };
    </script>
</body>
</html>