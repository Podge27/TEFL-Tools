<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Management Tool</title>
    <!-- Load Tailwind CSS for utility classes --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Soft Gray-Blue Background */
            min-height: 100vh;
            padding: 20px;
        }

        /* Main Container for the Tool */
        #tool-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 20px; /* Reduced vertical padding */
        }

        /* Student Card Styling (Sleek and Pro) */
        .student-card {
            background-color: #f8fafc;
            border-radius: 12px;
            padding: 8px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; /* Add background-color transition */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            height: 220px; /* Reduced height to minimize white space below name */
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        /* HIGH-VISIBILITY Highlight (Full card background) */
        .student-card.highlighted {
            background-color: #fcd34d; /* BRIGHT AMBER/YELLOW */
            border: none; /* No border, background does the work */
            box-shadow: 0 0 35px rgba(253, 224, 71, 1); /* Intense yellow shadow */
            animation: pulse-highlight 1.5s infinite alternate;
        }

        .student-card.absent {
            background-color: #e5e7eb; /* Light gray */
            opacity: 0.7;
            filter: grayscale(10%);
        }

        .student-card button {
            transition: background-color 0.1s;
        }

        /* Avatar Placeholder/Image Container Styling */
        .avatar {
            width: 80px; /* Increased size */
            height: 80px; /* Increased size */
            border-radius: 12px; /* Changed from 50% to 12px (rounded square) */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px; /* Slightly larger initials for bigger avatar */
            font-weight: 700;
            color: white;
            margin-bottom: 4px; /* Adjusted vertical space below avatar */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            overflow: hidden; 
        }

        /* Avatar Image Styling (Fixing Quality and Layout Shift) */
        .avatar img {
            width: 100%; /* Explicitly set 100% width and height */
            height: 100%;
            /* --- AGGRESSIVE ANTI-ALIASING FIXES --- */
            image-rendering: auto; 
            image-rendering: optimizeQuality; /* W3C standard */
            -webkit-optimize-contrast: high; /* Chrome/Safari specific */
            -ms-interpolation-mode: bicubic; /* IE/Edge legacy */
            transform: translate3d(0, 0, 0); /* Strongest GPU hint for smoother scaling */
        }
        
        /* Utility Classes */
        .points-text {
            font-size: 2.25rem; /* Slightly larger points text to match larger card */
            line-height: 1;
            font-weight: 800;
            color: #1f2937;
            margin: 2px 0; /* Keep small buffer */
        }
        .name-text {
            font-size: 0.9rem; 
            font-weight: 600;
            color: #374151;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            width: 100%;
            margin-bottom: 0; /* Reduced space below name to push it closer to buttons */
        }

        /* Absent Button Padding Reduction */
        .student-card button[data-action="absent"] {
            padding-top: 2px; 
            padding-bottom: 2px; 
            font-size: 0.75rem; 
        }

        /* Highlight Animation (Added subtle scale transform back for visibility and using brighter shadow) */
        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 20px rgba(253, 224, 71, 0.8); transform: scale(1); }
            50% { transform: scale(1.01); } /* Subtle scaling for visual 'pop' */
            100% { box-shadow: 0 0 35px rgba(253, 224, 71, 1); transform: scale(1); }
        }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }
        
        /* Specific override for the Teams Modal content size and layout */
        .modal-content.teams-result {
            max-width: 650px; /* INCREASED WIDTH for better horizontal display */
            max-height: 90vh; /* Critical: Max height relative to viewport */
            display: flex; /* Enables flex container for fixed header/footer */
            flex-direction: column;
            padding: 20px; /* Reduced padding */
        }
        
        /* Teams List SCROLLING AREA */
        #text-modal-content {
            overflow-y: auto; /* Enables vertical scrolling */
            flex-grow: 1; /* Allows this content to fill available space */
            padding-top: 10px;
            padding-bottom: 10px;
        }
        
        .group-message {
            white-space: pre-wrap;
            font-family: monospace;
            padding: 10px;
            background-color: #f1f5f9;
            border-radius: 6px;
        }
        
        /* Team Card Styling */
        .team-card {
            padding: 10px; /* Reduced padding for compact look */
            border-radius: 10px;
            color: white;
            font-weight: 700;
            margin-bottom: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }
        .team-card:hover {
            transform: scale(1.005); /* Slightly less aggressive scale */
        }
        
        /* Team Card Members (Single line display) */
        .team-card-members {
            font-size: 1.1rem;
            line-height: 1.3;
            /* Ensured white-space is normal to allow text wrapping if needed, but the width increase should handle most cases */
        }
    </style>
</head>
<body class="classroom-theme">
    <div id="tool-container">
        
        <!-- === Top Bar: Class Info, Load/Save, Back === --><header class="flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-200 mb-4">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2 sm:mb-0">Classroom Manager</h1>
            <div class="flex flex-wrap justify-center sm:justify-end space-x-2 sm:space-x-3">
                <button id="load-button" onclick="document.getElementById('file-upload').click()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-150">
                    Load Class
                </button>
                <input type="file" id="file-upload" accept=".csv, .txt" style="display: none;" onchange="window.handleFileUpload(event)">

                <button id="save-button" onclick="window.saveClass()" disabled
                        class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-150 disabled:opacity-50">
                    Save Class
                </button>
                
                <button id="back-button" onclick="window.location.href = 'index.html'"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg shadow-md hover:bg-gray-600 transition duration-150">
                    Back to Tools
                </button>
            </div>
        </header>

        <!-- === Main Class Display and Actions === --><div id="main-content">
            <!-- Class Name Display --><h2 id="class-name-label" class="text-xl font-bold text-gray-700 mb-4">No Class Loaded</h2>
            
            <!-- Student Cards Grid (Now prioritizes screen space) --><div id="student-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
                <!-- Student cards will be rendered here --></div>
            
            <!-- Action Frame (MOVED TO BOTTOM) --><div class="flex flex-wrap justify-between items-end gap-3 p-4 bg-gray-100 rounded-xl shadow-inner">
                
                <!-- LEFT SIDE: Random Pick + Picked Name (Focal point) --><div class="flex flex-wrap items-center gap-3">
                    <button id="random-button" onclick="window.pickRandomStudent()" disabled
                            class="px-6 py-3 text-lg font-extrabold bg-purple-600 text-white rounded-xl shadow-lg hover:bg-purple-700 transition duration-150 disabled:opacity-50">
                        &#127922; Random Pick
                    </button>
                    <!-- Current Pick Display (Large text, positioned next to the random button) --><p id="current-pick-label" class="text-2xl font-semibold text-gray-800 hidden sm:block">
                        Ready!
                    </p>
                </div>
                
                <!-- RIGHT SIDE: Utility Buttons (Fixed position, preventing jumpiness) --><div class="flex flex-wrap items-center gap-3">
                    <button id="teams-button" onclick="window.showGroupSizeOptions()" disabled
                            class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition duration-150 disabled:opacity-50">
                        &#128101; Teams!
                    </button>
                    <button id="plus-all-button" onclick="window.adjustAllPoints(1)" disabled
                            class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition duration-150 disabled:opacity-50">
                        +1 All
                    </button>
                    <button id="minus-all-button" onclick="window.adjustAllPoints(-1)" disabled
                            class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition duration-150 disabled:opacity-50">
                        -1 All
                    </button>
                    <button id="clear-button" onclick="window.clearAllPoints()" disabled
                            class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-150 disabled:opacity-50">
                        Clear All Points
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Modals --><!-- Group Size Modal (Hidden by default) --><div id="group-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Select Group Size</h3>
            <div id="group-buttons" class="flex justify-around space-x-2">
                <!-- Buttons for sizes 2-6 inserted by JS --></div>
            <button onclick="document.getElementById('group-modal').classList.add('hidden')"
                    class="mt-6 w-full px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
                Close
            </button>
        </div>
    </div>
    
    <!-- Generic Text/Result Modal (Hidden by default) --><div id="text-modal" class="modal-backdrop hidden">
        <!-- Teams Result Modal Content -->
        <div class="modal-content teams-result">
            <h3 id="text-modal-title" class="text-3xl font-extrabold mb-4 text-gray-800 text-center">Random Teams!</h3>
            
            <!-- SCROLLING TEAMS LIST -->
            <div id="text-modal-content" class="space-y-3">
                <!-- Teams will be injected here as colorful blocks -->
            </div>

            <!-- FIXED CLOSE BUTTON -->
            <button onclick="document.getElementById('text-modal').classList.add('hidden')"
                    class="mt-4 w-full px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 shrink-0">
                Close
            </button>
        </div>
    </div>
    
    <!-- Confirmation Modal (Hidden by default) --><div id="confirm-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 text-red-600">Confirmation</h3>
            <p id="confirm-modal-content" class="mb-6 text-gray-700">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
                    Cancel
                </button>
                <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Toast/Notification Area --><div id="toast-container" class="fixed bottom-5 right-5 space-y-2"></div>

    <script>
        // --- Global State ---
        let students = [];
        let cardWidgets = {};
        let pickedStudents = [];
        let currentFilename = "class_roster.csv"; // Default filename for saving
        
        // --- Configuration ---
        const AVATAR_COLORS = [
            '#FF5733', '#33FF57', '#3357FF', '#F333FF', '#33FFF3', '#FF8C33', '#8C33FF', '#FF0077', '#00CCFF', '#CCFF00'
        ];
        
        // --- HARDCODED FIX: Max Available Avatars (Update this number if you add/remove files) ---
        // Since you have 13 files (img_1.png to img_13.png), this ensures we only assign valid paths.
        const MAX_AVATARS_AVAILABLE = 13; 
        
        // --- Avatar Logic ---
        // 1. Create a pool of only the paths known to exist (up to MAX_AVATARS_AVAILABLE)
        const AVATAR_POOL = Array.from({ length: MAX_AVATARS_AVAILABLE }, (_, i) => `avatars/img_${i + 1}.png`);
        
        /** Generates a placeholder object for initials and background color. */
        function generateAvatarPlaceholder(name) {
            const initial = name[0].toUpperCase();
            const colorIndex = name.charCodeAt(0) % AVATAR_COLORS.length;
            const color = AVATAR_COLORS[colorIndex];
            
            return { initial, color };
        }

        // --- Sound Effects Setup (Tone.js) ---
        let toneLoaded = false;
        try {
            const script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js";
            script.onload = () => { toneLoaded = true; };
            document.head.appendChild(script);
        } catch (e) { 
            console.warn("Tone.js not available. Using silent feedback. (Error: Script loading failed)");
        }

        const POSITIVE_SOUND = () => {
            if (!toneLoaded) return;
            try {
                // Must start AudioContext only after user interaction
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                // UPDATED: High frequency and short duration for a positive chime
                const synth = new Tone.MembraneSynth().toDestination();
                synth.triggerAttackRelease("G6", "16n", Tone.now(), 0.8);
                synth.triggerAttackRelease("C7", "16n", Tone.now() + 0.1, 0.8);
            } catch (e) { console.error("Tone.js error during sound play:", e); }
        };

        const NEGATIVE_SOUND = () => {
            if (!toneLoaded) return;
            try {
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                const synth = new Tone.MembraneSynth().toDestination();
                synth.triggerAttackRelease("C3", "8n", Tone.now(), 0.8);
            } catch (e) { console.error("Tone.js error during sound play:", e); }
        };

        function playSound(amount) {
            if (amount > 0) {
                POSITIVE_SOUND();
            } else if (amount < 0) {
                NEGATIVE_SOUND();
            }
        }
        
        // --- UI Element References ---
        const ui = {
            grid: document.getElementById('student-grid'),
            classNameLabel: document.getElementById('class-name-label'),
            currentPickLabel: document.getElementById('current-pick-label'),
            saveButton: document.getElementById('save-button'),
            randomButton: document.getElementById('random-button'),
            teamsButton: document.getElementById('teams-button'),
            plusAllButton: document.getElementById('plus-all-button'),
            minusAllButton: document.getElementById('minus-all-button'),
            clearButton: document.getElementById('clear-button'),
            groupModal: document.getElementById('group-modal'),
            groupButtons: document.getElementById('group-buttons'),
            toastContainer: document.getElementById('toast-container'),
            textModal: document.getElementById('text-modal'),
            textModalTitle: document.getElementById('text-modal-title'),
            textModalContent: document.getElementById('text-modal-content'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalContent: document.getElementById('confirm-modal-content'),
            confirmOk: document.getElementById('confirm-ok'),
            confirmCancel: document.getElementById('confirm-cancel')
        };

        // --- Modal/Toast Functions ---

        /** Shows a simple, transient notification. */
        function showToast(message, type = 'info') {
            const colors = {
                info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500'
            };
            const color = colors[type] || colors.info;

            const toast = document.createElement('div');
            toast.className = `p-3 text-white rounded-lg shadow-xl ${color} transition-opacity duration-300`;
            toast.textContent = message;
            
            ui.toastContainer.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        /** Shows a modal for displaying multi-line text (e.g., group results). */
        function showTextModal(title, text) {
            // Note: We are now primarily using this function for the Teams modal, which
            // has been adjusted in the HTML to handle HTML injection directly.
            ui.textModalTitle.textContent = title;
            ui.textModalContent.innerHTML = text; // Inject HTML content
            ui.textModal.classList.remove('hidden');
        }

        /** Shows a modal for confirmation before destructive actions. */
        function showConfirmationModal(title, text, callback) {
            ui.confirmModalTitle.textContent = title;
            ui.confirmModalContent.textContent = text;
            ui.confirmModal.classList.remove('hidden');

            const handleConfirm = () => {
                ui.confirmModal.classList.add('hidden');
                ui.confirmOk.removeEventListener('click', handleConfirm);
                ui.confirmCancel.removeEventListener('click', handleCancel);
                callback(true);
            };

            const handleCancel = () => {
                ui.confirmModal.classList.add('hidden');
                ui.confirmOk.removeEventListener('click', handleConfirm);
                ui.confirmCancel.removeEventListener('click', handleCancel);
                callback(false);
            };

            ui.confirmOk.addEventListener('click', handleConfirm);
            ui.confirmCancel.addEventListener('click', handleCancel);
        }

        // --- Utility Functions ---

        /** Finds student data by name. */
        function getStudentDataByName(name) {
            return students.find(s => s.name === name);
        }

        /** Enables/disables all primary action buttons. */
        function toggleActionButtons(enable) {
            const buttons = [
                ui.saveButton, ui.randomButton, ui.teamsButton, 
                ui.plusAllButton, ui.minusAllButton, ui.clearButton
            ];
            buttons.forEach(btn => btn.disabled = !enable);
        }

        /** Renders a single student card HTML element. */
        function renderStudentCard(student) {
            const card = document.createElement('div');
            card.id = `card-${student.name.replace(/\s/g, '-')}`;
            card.className = `student-card ${student.absent ? 'absent' : ''} ${student.highlighted ? 'highlighted' : ''}`;
            
            const avatarData = student.avatarData || generateAvatarPlaceholder(student.name);

            // Use the randomly assigned avatarPath (e.g., avatars/img_3.png)
            const imagePath = student.avatarPath; 
            
            // Logic to choose between Image and Placeholder
            let avatarHTML = `
                <div class="avatar" style="background-color: ${avatarData.color};">
                    <img src="${imagePath}" 
                        alt="${student.name[0]}"
                        onerror="this.parentElement.innerHTML='${avatarData.initial}'; 
                                 this.parentElement.style.backgroundColor='${avatarData.color}'">
                </div>
            `;
            
            card.innerHTML = `
                ${avatarHTML}
                <div class="points-text" data-points>${student.points}</div>
                <div class="name-text font-bold mb-2">${student.name}</div>
                
                <div class="flex space-x-2 mt-auto w-full">
                    <button class="flex-1 px-2 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm" 
                            ${student.absent ? 'disabled' : ''}
                            onclick="window.adjustIndividualPoints('${student.name}', 1)">
                        +1
                    </button>
                    <button class="flex-1 px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm"
                            ${student.absent ? 'disabled' : ''}
                            onclick="window.adjustIndividualPoints('${student.name}', -1)">
                        -1
                    </button>
                </div>
                
                <button data-action="absent" class="w-full mt-2 px-2 py-1 text-sm rounded-md transition duration-150 ${student.absent ? 'bg-gray-400 text-gray-800 hover:bg-gray-500' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}"
                        onclick="window.toggleAbsence('${student.name}')">
                    ${student.absent ? 'Mark Present' : 'Mark Absent'}
                </button>
            `;
            
            // Store reference to the DOM element
            cardWidgets[student.name] = { element: card, data: student };
            return card;
        }

        /** Updates the DOM for a single student card. */
        function updateStudentCardUI(studentName) {
            const widget = cardWidgets[studentName];
            if (!widget) return;
            
            const card = widget.element;
            const data = widget.data;

            // 1. Update Points
            card.querySelector('[data-points]').textContent = data.points;

            // 2. Update Absent/Highlight Status
            card.classList.toggle('absent', data.absent);
            card.classList.toggle('highlighted', data.highlighted);
            
            // 3. Update Point Buttons Status
            const buttons = card.querySelectorAll('.flex > button');
            buttons.forEach(btn => btn.disabled = data.absent);
            
            // 4. Update Absent Button Text and Style (using data-action="absent" selector)
            const absentBtn = card.querySelector('[data-action="absent"]');
            if (absentBtn) {
                absentBtn.textContent = data.absent ? 'Mark Present' : 'Mark Absent';
                absentBtn.classList.toggle('bg-gray-400', data.absent);
                absentBtn.classList.toggle('text-gray-800', data.absent);
                absentBtn.classList.toggle('bg-gray-300', !data.absent);
                absentBtn.classList.toggle('text-gray-700', !data.absent);
            }
        }
        
        /** Draws the entire class roster grid. */
        function drawStudents() {
            ui.grid.innerHTML = '';
            cardWidgets = {}; // Clear map
            
            if (students.length === 0) {
                ui.grid.innerHTML = '<p class="col-span-full text-center text-gray-500 italic">No students loaded. Use the "Load Class" button above.</p>';
                toggleActionButtons(false);
                return;
            }
            
            students.forEach(student => {
                ui.grid.appendChild(renderStudentCard(student));
            });
            toggleActionButtons(true);
        }

        // --- Logic Methods ---

        /** Loads student data from uploaded CSV/TXT file content (first column only). */
        function loadClassFromContent(filename, content) {
            students = [];
            
            // 1. Split by newlines (rows)
            const lines = content.split('\n').filter(line => line.trim().length > 0);
            
            // 2. Randomize the pool of *available* avatar paths
            const shuffledPaths = [...AVATAR_POOL].sort(() => Math.random() - 0.5);
            let pathIndex = 0;

            // 3. Process each line: take only the first column before the first comma
            lines.forEach((line) => {
                // Takes the entire line if no comma is present, or just the first column
                const firstColumn = line.split(',')[0].trim();
                
                if (firstColumn) {
                    // Try to parse existing data (for saved files with points/absent status)
                    const parts = firstColumn.split('\t'); // Fallback: check tab separation too
                    const name = parts[0];
                    // Default to 0 points, not absent
                    const points = parseInt(parts[1]) || 0; 
                    const absent = parts[2] === 'true'; 
                    
                    students.push({
                        name: name,
                        points: points,
                        absent: absent,
                        avatarData: generateAvatarPlaceholder(name), // Placeholder for fallback
                        // Assign random path from the pool, cycling if the class is larger than the pool
                        avatarPath: shuffledPaths[pathIndex++ % shuffledPaths.length], 
                        highlighted: false
                    });
                }
            });

            if (students.length > 0) {
                currentFilename = filename;
                ui.classNameLabel.textContent = `Class: ${filename}`;
                pickedStudents = [];
                drawStudents();
                showToast(`Loaded ${students.length} students from ${filename}.`, 'success');
            } else {
                ui.classNameLabel.textContent = "No Class Loaded";
                showToast("No valid students found in the file.", 'error');
            }
        }

        /** File handler triggered by the hidden input change. */
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                loadClassFromContent(file.name, e.target.result);
            };
            reader.onerror = () => {
                showToast(`Failed to read file: ${file.name}`, 'error');
            };
            reader.readAsText(file);
        };
        
        /** Generates and triggers the download of the current class data as a CSV. */
        window.saveClass = function() {
            if (students.length === 0) {
                showToast("No class loaded to save.", 'info');
                return;
            }

            // Create CSV content: Name, Points, Absent (true/false)
            const header = "Name,Points,Absent\n";
            const rows = students.map(s => 
                `${s.name},${s.points},${s.absent}`
            ).join('\n');
            
            const csvContent = header + rows;
            
            // Trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', currentFilename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast(`Class data saved to ${currentFilename}.`, 'success');
            } else {
                showToast("Your browser does not support automatic downloads.", 'error');
            }
        };

        /** Adjusts points for all non-absent students. */
        window.adjustAllPoints = function(amount) {
            let updated = false;
            students.forEach(student => {
                if (!student.absent) {
                    student.points += amount;
                    updateStudentCardUI(student.name);
                    updated = true;
                }
            });
            if (updated) playSound(amount);
            showToast(`${amount > 0 ? '+' : ''}${amount} point${amount !== 1 && amount !== -1 ? 's' : ''} added to all present students.`, 'info');
        };

        /** Resets all students' points to 0. */
        window.clearAllPoints = function() {
            showConfirmationModal(
                "Clear All Points", 
                "Are you sure you want to clear all student points? This action cannot be undone.",
                (confirmed) => {
                    if (confirmed) {
                        students.forEach(student => {
                            student.points = 0;
                            updateStudentCardUI(student.name);
                        });
                        showToast("All points cleared!", 'info');
                    }
                }
            );
        };

        /** Toggles absence status for an individual student. */
        window.toggleAbsence = function(name) {
            const student = getStudentDataByName(name);
            if (student) {
                student.absent = !student.absent;
                updateStudentCardUI(name);
                showToast(`${name} marked as ${student.absent ? 'absent' : 'present'}.`, 'info');
            }
        };

        /** Adjusts points for an individual student. */
        window.adjustIndividualPoints = function(name, amount) {
            const student = getStudentDataByName(name);
            if (student && !student.absent) {
                student.points += amount;
                updateStudentCardUI(name);
                playSound(amount);
            }
        };

        /** Picks a random student (no repeats until all are picked). */
        window.pickRandomStudent = function() {
            const activeStudents = students.filter(s => !s.absent);
            
            if (activeStudents.length === 0) {
                ui.currentPickLabel.textContent = "No students available to pick!";
                return;
            }

            // Reset picked list if cycle is complete
            if (pickedStudents.length === activeStudents.length) {
                pickedStudents = [];
                // Clear all previous highlights when resetting cycle
                students.forEach(student => {
                    if (student.highlighted) {
                        student.highlighted = false;
                        updateStudentCardUI(student.name);
                    }
                });
            }

            const availableStudents = activeStudents.filter(s => !pickedStudents.includes(s.name));
            
            const chosenStudentData = availableStudents[Math.floor(Math.random() * availableStudents.length)];
            const chosenName = chosenStudentData.name;
            
            pickedStudents.push(chosenName);
            
            // 1. Clear highlight from the previously picked student
            students.forEach(student => {
                if (student.highlighted && student.name !== chosenName) {
                    student.highlighted = false;
                    updateStudentCardUI(student.name);
                }
            });

            // 2. Set new highlight
            chosenStudentData.highlighted = true;
            updateStudentCardUI(chosenName);
            
            ui.currentPickLabel.textContent = `Picked: ${chosenName}`;
            // Ensure the pick label is visible
            ui.currentPickLabel.classList.remove('hidden', 'sm:hidden');

            // REMOVED: playSound(1); // Removed positive sound for random pick
        };
        
        /** Displays the group size selection modal. */
        window.showGroupSizeOptions = function() {
            ui.groupModal.classList.remove('hidden');
            ui.groupButtons.innerHTML = '';
            
            const activeCount = students.filter(s => !s.absent).length;
            if (activeCount < 2) {
                ui.groupButtons.innerHTML = '<p class="text-red-500">Need at least two active students to group.</p>';
                return;
            }

            // Display options from 2 up to max possible size (min(6, half class))
            const maxGroupSize = Math.min(6, Math.floor(activeCount / 2));

            for (let size = 2; size <= maxGroupSize; size++) {
                const btn = document.createElement('button');
                btn.textContent = size;
                btn.className = 'px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150 flex-1';
                btn.onclick = () => window.createRandomGroups(size);
                ui.groupButtons.appendChild(btn);
            }
            if (maxGroupSize < 2) {
                 ui.groupButtons.innerHTML = '<p class="text-red-500">Not enough students for groups.</p>';
            }
        };

        /** Creates and displays random groups based on size. */
        window.createRandomGroups = function(groupSize) {
            ui.groupModal.classList.add('hidden');
            
            let activeStudents = students.filter(s => !s.absent);
            if (activeStudents.length === 0) return;
            
            // Shuffle students randomly
            activeStudents.sort(() => Math.random() - 0.5);
            
            const groups = [];
            for (let i = 0; i < activeStudents.length; i += groupSize) {
                groups.push(activeStudents.slice(i, i + groupSize));
            }

            // Format the result (using colorful HTML blocks)
            let groupHtml = '';
            groups.forEach((group, i) => {
                const names = group.map(s => s.name);
                // Cycle through colors based on group index (using AVATAR_COLORS)
                const color = AVATAR_COLORS[i % AVATAR_COLORS.length];
                
                // MODIFIED: Formatting names as "Team X: Name1, Name2, Name3"
                groupHtml += `
                    <div class="team-card" style="background-color: ${color};">
                        <div class="team-card-members">Team ${i + 1}: ${names.join(', ')}</div>
                    </div>
                `;
            });
            
            showTextModal("Team Assignments", groupHtml);
            showToast(`Created ${groups.length} groups of size ${groupSize}.`, 'success');
        };

        // --- Initialization ---

        window.onload = function() {
            drawStudents();
        };
    </script>
</body class="classroom-theme">
</html>