<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy Placement Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        
        h1 { color: #003366; margin-bottom: 20px; }
        .hidden { display: none; }
        
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #003366; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #002244; }
        
        /* Question Styles */
        .option-btn { background: #f8f9fa; color: #333; border: 1px solid #ddd; text-align: left; margin: 5px 0; }
        .option-btn:hover { background: #e2e6ea; }
        .selected { background: #003366 !important; color: white !important; border-color: #003366; }

        /* Scramble Styles */
        #scramble-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; min-height: 50px; padding: 10px; border: 2px dashed #ddd; border-radius: 8px; background: #fafafa; }
        #word-bank { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
        .word-tile { background: #FFCC00; color: #003366; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; user-select: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #003366; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <div id="intro-screen">
            <img src="images/logo.png" alt="Academy Logo" style="max-width: 150px; margin-bottom: 20px;">
            <h1>English Placement Test</h1>
            <p>Please enter your details to begin.</p>
            <input type="text" id="student-name" placeholder="Full Name">
            <input type="email" id="student-email" placeholder="Email Address">
            <button onclick="startTest()">Start Test</button>
        </div>

        <div id="quiz-screen" class="hidden">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; color: #666;">
                <span id="progress-text">Question 1</span>
            </div>
            <h2 id="question-text" style="color:#444; font-size: 1.2em; margin-bottom: 25px;"></h2>
            
            <audio id="audio-player" controls style="display:none; width:100%; margin-bottom:20px;"></audio>
            
            <div id="options-container"></div>
            
            <div id="scramble-ui" class="hidden">
                <p style="font-size:0.9em; color:#666;">Tap words to build the sentence:</p>
                <div id="scramble-container"></div> <div id="word-bank"></div> </div>

            <button onclick="nextQuestion()" style="margin-top: 30px;">Next Question</button>
        </div>

        <div id="loading-screen" class="hidden">
            <div class="loader" style="display:block"></div>
            <h3>Analyzing Results...</h3>
            <p>Our AI is grading your test. Please wait.</p>
        </div>

        <div id="result-screen" class="hidden">
            <h1>Test Complete!</h1>
            <p style="font-size: 1.2em;">Your estimated level is:</p>
            <h2 id="final-score" style="color: #003366; font-size: 3em; margin: 10px 0;"></h2>
            <p>We have sent a detailed report to your email.</p>
            <button onclick="location.reload()">Return Home</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";

        
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let questions = [];
        let currentQIndex = 0;
        let answers = [];
        let studentName = "";
        let studentEmail = "";
        let currentScrambleOrder = [];

        // --- 1. START TEST ---
        async function startTest() {
            studentName = document.getElementById('student-name').value;
            studentEmail = document.getElementById('student-email').value;

            if (!studentName || !studentEmail.includes('@')) {
                alert("Please enter a valid name and email.");
                return;
            }

            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');

            // Fetch questions from Supabase
            const { data, error } = await db.from('questions').select('*').order('id');
            if (error) { alert("Error loading test. Please refresh."); return; }
            
            questions = data;
            renderQuestion();
        }

        // --- 2. RENDER QUESTION ---
        function renderQuestion() {
            const q = questions[currentQIndex];
            document.getElementById('progress-text').innerText = `Question ${currentQIndex + 1} of ${questions.length}`;
            document.getElementById('question-text').innerText = q.question_text;
            
            const optsDiv = document.getElementById('options-container');
            const audioPlayer = document.getElementById('audio-player');
            const scrambleUI = document.getElementById('scramble-ui');
            
            // Reset UI
            optsDiv.innerHTML = '';
            audioPlayer.style.display = 'none';
            scrambleUI.classList.add('hidden');
            optsDiv.classList.remove('hidden');
            currentScrambleOrder = []; // Reset scramble

            // HANDLE AUDIO
            if (q.q_type === 'LISTEN_SET' && q.content.audio_url) {
                audioPlayer.src = q.content.audio_url;
                audioPlayer.style.display = 'block';
            }

            // HANDLE MULTIPLE CHOICE (MC) & LISTENING (LISTEN_SET)
            if (q.q_type === 'MC' || q.q_type === 'LISTEN_SET') {
                q.content.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = opt;
                    btn.onclick = () => selectOption(btn, opt);
                    optsDiv.appendChild(btn);
                });
            } 
            // HANDLE SCRAMBLE (SS) - *** THE FIX IS HERE ***
            else if (q.q_type === 'SS') {
                optsDiv.classList.add('hidden'); // Hide normal buttons
                scrambleUI.classList.remove('hidden'); // Show scramble UI
                
                let words = q.content.words;

                // *** SCRAMBLE FIX: Handle Strings vs Arrays ***
                if (typeof words === 'string') {
                    try {
                        words = JSON.parse(words); // Try to turn string "['I','am']" into array
                    } catch (e) {
                        words = words.split(' '); // Fallback: Split by space
                    }
                }
                
                setupScramble(words);
            }
        }

        // --- 3. SCRAMBLE LOGIC ---
        function setupScramble(wordsList) {
            const bank = document.getElementById('word-bank');
            const container = document.getElementById('scramble-container');
            bank.innerHTML = '';
            container.innerHTML = '';

            // Shuffle words for display
            const shuffled = [...wordsList].sort(() => Math.random() - 0.5);

            shuffled.forEach(word => {
                const tile = document.createElement('div');
                tile.className = 'word-tile';
                tile.innerText = word;
                tile.onclick = () => {
                    // Move to container
                    if (tile.parentElement === bank) {
                        container.appendChild(tile);
                        currentScrambleOrder.push(word);
                    } else {
                        // Move back to bank
                        bank.appendChild(tile);
                        currentScrambleOrder = currentScrambleOrder.filter(w => w !== word);
                    }
                };
                bank.appendChild(tile);
            });
        }

        // --- 4. HANDLE ANSWERS ---
        let currentSelection = null;
        function selectOption(btn, text) {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentSelection = text;
        }

        function nextQuestion() {
            const q = questions[currentQIndex];
            let answer = null;

            if (q.q_type === 'SS') {
                if (currentScrambleOrder.length === 0) { alert("Please arrange the words."); return; }
                answer = currentScrambleOrder.join(' ');
            } else {
                if (!currentSelection) { alert("Please select an answer."); return; }
                answer = currentSelection;
            }

            answers.push({ q_id: q.id, answer: answer });
            currentSelection = null;
            currentQIndex++;

            if (currentQIndex < questions.length) {
                renderQuestion();
            } else {
                submitTest();
            }
        }

        // --- 5. SUBMIT TO AI ---
        async function submitTest() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');

            const payload = {
                studentName,
                studentEmail,
                answers
            };

            try {
                // *** NETLIFY FUNCTION CALL - Updated to 'report' ***
                const res = await fetch('/.netlify/functions/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("Server error");

                const result = await res.json();
                
                // Show Result
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                document.getElementById('final-score').innerText = result.level || "Pending";

            } catch (err) {
                console.error(err);
                alert("Test submitted, but we couldn't fetch the report immediately. Check your email.");
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                document.getElementById('final-score').innerText = "Submitted";
            }
        }
    </script>
</body>
</html>