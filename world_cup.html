<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFA World Cup Archive (Final Polish)</title>
    <style>
        /* --- 1. VISUAL STYLE --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f4f9; margin: 0; padding: 0; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        /* HEADER & TABS */
        .header { background: #1a1a2e; color: white; position: sticky; top: 0; z-index: 100; }
        .top-bar { display: flex; align-items: center; padding: 15px; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 15px; }
        h1 { font-size: 1.1rem; margin: 0; flex-grow: 1; }
        
        .gender-tabs { display: flex; background: #111; }
        .tab-btn { flex: 1; background: none; border: none; color: #888; padding: 15px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom: 3px solid #e94560; }

        /* LIST OF CUPS */
        .cup-row { display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #eee; cursor: pointer; }
        .cup-row:hover { background: #f9f9f9; }
        .cup-flag { width: 40px; height: 30px; object-fit: cover; border-radius: 4px; margin-right: 15px; border: 1px solid #ddd; background: #eee; }
        .cup-host { font-weight: bold; font-size: 1.1rem; }
        .cup-year { color: #666; font-size: 0.9rem; }

        /* MENU BUTTONS */
        .menu-grid { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .menu-btn { background: #e94560; color: white; border: none; padding: 18px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; }
        .menu-btn:active { transform: scale(0.98); background: #d63d55; }
        .menu-btn.secondary { background: #16213e; }
        .separator { width: 100%; border: 0; border-top: 1px solid #ddd; margin: 10px 0; }

        /* MATCH & DATA */
        .stage-container { padding: 15px; padding-bottom: 50px; }
        .match-card { background: white; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
        .match-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .match-header:hover { background: #fafafa; }
        .score-line { font-weight: bold; font-size: 1rem; }
        .match-meta { font-size: 0.8rem; color: #888; margin-top: 4px; }
        
        .match-details { display: none; background: #fcfcfc; border-top: 1px solid #eee; }
        
        /* SPLIT GRID SYSTEM */
        .split-grid { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid #eee; }
        .split-col { padding: 15px; }
        .split-col.home { text-align: right; border-right: 1px solid #eee; }
        .split-col.away { text-align: left; }
        
        .section-label { 
            background: #eee; color: #555; text-align: center; 
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; 
            font-weight: bold; padding: 5px;
        }

        /* EVENTS */
        .event-row { margin-bottom: 6px; font-size: 0.9rem; }
        .pen-row { margin-bottom: 4px; font-size: 0.9rem; }

        /* LINEUPS */
        .lineup-title { font-weight: bold; font-size: 0.85rem; color: #333; margin-bottom: 5px; }
        .lineup-list { color: #444; font-size: 0.85rem; line-height: 1.4; margin-bottom: 8px; }
        .subs-title { font-weight: bold; font-size: 0.8rem; color: #666; margin-top: 8px; }
        .sub-row { font-size: 0.8rem; color: #555; }
        .sub-time { font-weight: bold; color: #333; font-size: 0.75rem; background: #eee; padding: 1px 4px; border-radius: 3px; }

        .round-header { background: #e0e0e0; padding: 10px 15px; font-weight: bold; margin-top: 25px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="top-bar">
                <button id="back-btn" class="back-btn hidden" onclick="goBack()">‚Üê</button>
                <h1 id="page-title">World Cup Archive</h1>
            </div>
            <div id="tabs-container" class="gender-tabs">
                <button class="tab-btn active" onclick="switchGender('men', this)">MEN'S</button>
                <button class="tab-btn" onclick="switchGender('women', this)">WOMEN'S</button>
            </div>
        </div>

        <div id="view-home"></div>
        <div id="view-menu" class="hidden"></div>
        <div id="view-stage" class="hidden stage-container"></div>
        <div id="view-text" class="hidden" style="padding: 20px;"></div>
    </div>

    <script>
        /* -------------------------------------------------------
           HARDCODED DATA
           ------------------------------------------------------- */
        const hardcodedData = [
            {
                "id": "WC-2022", "year": 2022, "type": "men", "host": "Qatar", "host_flag_code": "qa", 
                "name": "2022 FIFA Men's World Cup",
                "details": { "overview": "Overview...", "controversies": "Controversies..." },
                "stages_menu": [
                    { "label": "Group Stage", "id": "groups", "view_type": "table_view" },
                    { "label": "Final", "id": "final", "view_type": "bracket_view" }
                ],
                "stage_data": {
                    "groups": { 
                        "matches": [
                            { "match_id": "m1", "date": "20 Nov", "stadium": "Al Bayt", "home_team": "Qatar", "away_team": "Ecuador", "score": "0 - 2", 
                              "goals": [{ "player": "Enner Valencia", "min": "16'", "team": "Ecuador" }, { "player": "Enner Valencia", "min": "31'", "team": "Ecuador" }], 
                              "cards": [{ "player": "Al-Sheeb", "card": "Yellow", "min": "15'", "team": "Qatar" }], 
                              "lineups": null }
                        ],
                        "table": [] 
                    },
                    "final": { 
                        "matches": [
                            { 
                                "match_id": "m64", "date": "18 Dec", "stadium": "Lusail", "home_team": "Argentina", "away_team": "France", "score": "3 - 3 (4-2 pens)",
                                "goals": [{ "player": "Lionel Messi", "min": "23'", "team": "Argentina" }, { "player": "√Ångel Di Mar√≠a", "min": "36'", "team": "Argentina" }, { "player": "Kylian Mbapp√©", "min": "80'", "team": "France" }, { "player": "Kylian Mbapp√©", "min": "81'", "team": "France" }, { "player": "Lionel Messi", "min": "108'", "team": "Argentina" }, { "player": "Kylian Mbapp√©", "min": "118'", "team": "France" }],
                                "cards": [{ "player": "Fern√°ndez", "card": "Yellow", "min": "45'", "team": "Argentina"}],
                                "penalties": [
                                    { "player": "Mbapp√©", "team": "France", "outcome": "Goal" },
                                    { "player": "Messi", "team": "Argentina", "outcome": "Goal" },
                                    { "player": "Coman", "team": "France", "outcome": "Miss" },
                                    { "player": "Dybala", "team": "Argentina", "outcome": "Goal" },
                                    { "player": "Tchouam√©ni", "team": "France", "outcome": "Miss" },
                                    { "player": "Paredes", "team": "Argentina", "outcome": "Goal" },
                                    { "player": "Kolo Muani", "team": "France", "outcome": "Goal" },
                                    { "player": "Montiel", "team": "Argentina", "outcome": "Goal" }
                                ],
                                "lineups": {
                                    "home_manager": "Lionel Scaloni",
                                    "away_manager": "Didier Deschamps",
                                    "home_xi": ["E. Mart√≠nez", "Molina", "Romero", "Otamendi", "Tagliafico", "De Paul", "Fern√°ndez", "Mac Allister", "Messi", "√Ålvarez", "Di Mar√≠a"],
                                    "away_xi": ["Lloris", "Kound√©", "Varane", "Upamecano", "Hern√°ndez", "Tchouam√©ni", "Rabiot", "Demb√©l√©", "Griezmann", "Mbapp√©", "Giroud"],
                                    "home_subs": [{ "min": "64", "in": "Acu√±a", "out": "Di Mar√≠a" }],
                                    "away_subs": [{ "min": "41", "in": "Thuram", "out": "Giroud" }]
                                }
                            }
                        ] 
                    }
                }
            },
            {
                "id": "WWC-2019", "year": 2019, "type": "women", "host": "France", "host_flag_code": "fr",
                "name": "2019 Women's World Cup",
                "details": { "overview": "Overview...", "controversies": "Controversies..." },
                "stages_menu": [{ "label": "Final", "id": "final", "view_type": "bracket_view" }],
                "stage_data": {
                    "final": { "matches": [{ "match_id": "wm1", "date": "07 Jul", "stadium": "Lyon", "home_team": "USA", "away_team": "Netherlands", "score": "2 - 0", "goals": [{"player": "Megan Rapinoe", "min": "61'", "team": "USA"}], "cards": [], "lineups": null }] }
                }
            }
        ];

        /* -------------------------------------------------------
           APP LOGIC
           ------------------------------------------------------- */
        let currentGender = 'men';
        let currentCup = null;
        let historyStack = [];

        renderHome();

        function cleanName(name) {
            if(!name) return "";
            return name.replace(/not applicable /gi, "").replace(/undefined /gi, "").trim();
        }

        function switchGender(gender, btn) {
            currentGender = gender;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderHome();
        }

        function renderHome() {
            showView('view-home', 'World Cup Archive', false);
            const container = document.getElementById('view-home');
            container.innerHTML = '';

            const filteredData = hardcodedData.filter(c => c.type === currentGender);

            filteredData.forEach(cup => {
                const row = document.createElement('div');
                row.className = 'cup-row';
                const flagUrl = `https://flagcdn.com/w80/${cup.host_flag_code.toLowerCase()}.png`;
                row.innerHTML = `<img src="${flagUrl}" class="cup-flag" onerror="this.style.display='none'"><div class="cup-info"><span class="cup-host">${cup.host}</span><span class="cup-year">${cup.year}</span></div>`;
                row.onclick = () => openMenu(cup);
                container.appendChild(row);
            });
        }

        function openMenu(cup) {
            currentCup = cup;
            showView('view-menu', `${cup.year} ${cup.host}`, true);
            const container = document.getElementById('view-menu');
            container.innerHTML = ''; 
            
            const grid = document.createElement('div');
            grid.className = 'menu-grid';
            container.appendChild(grid);

            cup.stages_menu.forEach(stage => {
                const btn = document.createElement('button');
                btn.className = 'menu-btn';
                btn.innerText = stage.label;
                btn.addEventListener('click', () => openStage(stage));
                grid.appendChild(btn);
            });

            const sep = document.createElement('hr');
            sep.className = 'separator';
            grid.appendChild(sep);

            const btnWall = document.createElement('button');
            btnWall.className = 'menu-btn secondary';
            btnWall.innerText = 'üå≥ Wall Chart';
            btnWall.addEventListener('click', () => openWallChart());
            grid.appendChild(btnWall);

            const btnOver = document.createElement('button');
            btnOver.className = 'menu-btn secondary';
            btnOver.innerText = 'üìñ Overview';
            btnOver.addEventListener('click', () => openText('overview'));
            grid.appendChild(btnOver);

            const btnContro = document.createElement('button');
            btnContro.className = 'menu-btn secondary';
            btnContro.innerText = '‚ö†Ô∏è Controversies';
            btnContro.addEventListener('click', () => openText('controversies'));
            grid.appendChild(btnContro);
        }

        function openStage(stage) {
            showView('view-stage', stage.label, true);
            const container = document.getElementById('view-stage');
            container.innerHTML = '';

            if (!currentCup.stage_data[stage.id]) {
                container.innerHTML = `<p style="padding:20px; color:red;">No data found for ID: ${stage.id}</p>`;
                return;
            }
            const data = currentCup.stage_data[stage.id];
            if (stage.view_type === 'table_view' && data.table && data.table.length > 0) {
                container.innerHTML += `<h3>Table</h3><p>(Table data here)</p>`;
            }
            renderMatchList(container, data.matches);
        }

        function openWallChart() {
            showView('view-stage', 'Wall Chart', true);
            const container = document.getElementById('view-stage');
            container.innerHTML = '';
            currentCup.stages_menu.forEach(stage => {
                if(stage.view_type === 'bracket_view') {
                    if(currentCup.stage_data[stage.id] && currentCup.stage_data[stage.id].matches) {
                        container.innerHTML += `<div class="round-header">${stage.label}</div>`;
                        renderMatchList(container, currentCup.stage_data[stage.id].matches);
                    }
                }
            });
        }

        // --- RENDER MATCHES ---
        function renderMatchList(container, matches) {
            matches.forEach(m => {
                const card = document.createElement('div');
                card.className = 'match-card';
                
                // 1. FILTER EVENTS
                const homeGoals = (m.goals || []).filter(g => g.team === m.home_team);
                const awayGoals = (m.goals || []).filter(g => g.team === m.away_team);
                const homeCards = (m.cards || []).filter(c => c.team === m.home_team);
                const awayCards = (m.cards || []).filter(c => c.team === m.away_team);
                const homePens = (m.penalties || []).filter(p => p.team === m.home_team);
                const awayPens = (m.penalties || []).filter(p => p.team === m.away_team);

                // 2. GENERATORS
                const generateEvents = (goals, cards) => {
                    let html = '';
                    goals.forEach(g => html += `<div class="event-row">‚öΩ ${g.min} ${cleanName(g.player)}</div>`);
                    cards.forEach(c => html += `<div class="event-row">üü® ${c.min} ${cleanName(c.player)}</div>`);
                    return html || '&nbsp;';
                };

                const generatePens = (pens) => {
                    let html = '';
                    pens.forEach(p => {
                        const icon = p.outcome === 'Goal' ? '‚úÖ' : '‚ùå';
                        html += `<div class="pen-row">${icon} ${p.player}</div>`;
                    });
                    return html;
                };

                // 3. BUILD SECTIONS (This ensures they stack neatly)
                
                // -- A. MATCH EVENTS BLOCK --
                let detailsHtml = `
                    <div class="section-label">Match Events</div>
                    <div class="split-grid">
                        <div class="split-col home">${generateEvents(homeGoals, homeCards)}</div>
                        <div class="split-col away">${generateEvents(awayGoals, awayCards)}</div>
                    </div>
                `;

                // -- B. PENALTIES BLOCK (Only if they exist) --
                if(m.penalties && m.penalties.length > 0) {
                    detailsHtml += `
                        <div class="section-label">Penalty Shootout</div>
                        <div class="split-grid">
                            <div class="split-col home">${generatePens(homePens)}</div>
                            <div class="split-col away">${generatePens(awayPens)}</div>
                        </div>
                    `;
                }

                // -- C. LINEUPS BLOCK --
                if(m.lineups) {
                    const subFormat = sub => {
                        // FIXED: Ensure "out" is shown
                        return typeof sub === 'string' 
                            ? `<div>${sub}</div>` 
                            : `<div class="sub-row"><span class="sub-time">${sub.min}'</span> ${sub.in} (for ${sub.out})</div>`;
                    };
                    
                    detailsHtml += `
                        <div class="section-label">Lineups</div>
                        <div class="split-grid" style="border-bottom:none;">
                            <div class="split-col home">
                                <div class="lineup-title">Manager: ${m.lineups.home_manager}</div>
                                <div class="lineup-list">${m.lineups.home_xi.join(', ')}</div>
                                ${m.lineups.home_subs ? `<div class="subs-title">Subs</div>` + m.lineups.home_subs.map(subFormat).join('') : ''}
                            </div>
                            <div class="split-col away">
                                <div class="lineup-title">Manager: ${m.lineups.away_manager}</div>
                                <div class="lineup-list">${m.lineups.away_xi.join(', ')}</div>
                                ${m.lineups.away_subs ? `<div class="subs-title">Subs</div>` + m.lineups.away_subs.map(subFormat).join('') : ''}
                            </div>
                        </div>
                    `;
                } else {
                    detailsHtml += `<div style="padding:15px; text-align:center; color:#999;">No lineups available</div>`;
                }

                card.innerHTML = `
                    <div class="match-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'block' ? 'none' : 'block'">
                        <div style="flex-grow:1;">
                            <div class="score-line">${m.home_team} ${m.score} ${m.away_team}</div>
                            <div class="match-meta">${m.date} | ${m.stadium}</div>
                        </div>
                        <div>‚ñæ</div>
                    </div>
                    <div class="match-details">
                        ${detailsHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openText(type) {
            const title = type === 'overview' ? 'Overview' : 'Controversies';
            showView('view-text', title, true);
            const text = currentCup.details[type] || "No text available.";
            document.getElementById('view-text').innerHTML = `<h2>${title}</h2><p>${text}</p>`;
        }

        function showView(viewId, title, showBack) {
            ['view-home', 'view-menu', 'view-stage', 'view-text'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById('page-title').innerText = title;
            
            const backBtn = document.getElementById('back-btn');
            const tabs = document.getElementById('tabs-container');

            window.scrollTo(0,0);

            if(showBack) {
                backBtn.classList.remove('hidden');
                tabs.classList.add('hidden');
                historyStack.push(viewId);
            } else {
                backBtn.classList.add('hidden');
                tabs.classList.remove('hidden');
                historyStack = [];
            }
        }

        function goBack() {
            const current = document.querySelector('div:not(.hidden)[id^="view-"]').id;
            if(current === 'view-menu') {
                renderHome();
            } else {
                openMenu(currentCup);
            }
        }
    </script>
</body>
</html>