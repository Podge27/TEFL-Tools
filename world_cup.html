<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFA World Cup Archive</title>
    <style>
        /* --- 1. VISUAL STYLE --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f4f9; margin: 0; padding: 0; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        /* HEADER & TABS */
        .header { background: #1a1a2e; color: white; position: sticky; top: 0; z-index: 100; }
        .top-bar { display: flex; align-items: center; padding: 15px; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 15px; }
        h1 { font-size: 1.1rem; margin: 0; flex-grow: 1; }
        
        .gender-tabs { display: flex; background: #111; }
        .tab-btn { flex: 1; background: none; border: none; color: #888; padding: 15px; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom: 3px solid #e94560; }

        /* LIST OF CUPS */
        .cup-row { display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #eee; cursor: pointer; }
        .cup-row:hover { background: #f9f9f9; }
        .cup-flag { width: 40px; height: 30px; object-fit: cover; border-radius: 4px; margin-right: 15px; border: 1px solid #ddd; background: #eee; }
        .cup-host { font-weight: bold; font-size: 1.1rem; }
        .cup-year { color: #666; font-size: 0.9rem; }

        /* MENU BUTTONS */
        .menu-grid { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .menu-btn { background: #e94560; color: white; border: none; padding: 18px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; }
        .menu-btn:active { transform: scale(0.98); background: #d63d55; }
        .menu-btn.secondary { background: #16213e; }
        .separator { width: 100%; border: 0; border-top: 1px solid #ddd; margin: 10px 0; }

        /* MATCH & DATA */
        .stage-container { padding: 15px; padding-bottom: 50px; }
        .match-card { background: white; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
        .match-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .match-header:hover { background: #fafafa; }
        .score-line { font-weight: bold; font-size: 1rem; }
        .match-meta { font-size: 0.8rem; color: #888; margin-top: 4px; }
        
        .match-details { display: none; background: #fcfcfc; border-top: 1px solid #eee; }
        
        /* SPLIT GRID SYSTEM */
        .split-grid { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid #eee; }
        .split-col { padding: 15px; }
        .split-col.home { text-align: right; border-right: 1px solid #eee; }
        .split-col.away { text-align: left; }
        
        .section-label { 
            background: #eee; color: #555; text-align: center; 
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; 
            font-weight: bold; padding: 5px;
        }

        /* EVENTS */
        .event-row { margin-bottom: 6px; font-size: 0.9rem; }
        .pen-row { margin-bottom: 4px; font-size: 0.9rem; }

        /* LINEUPS */
        .lineup-title { font-weight: bold; font-size: 0.85rem; color: #333; margin-bottom: 5px; }
        .lineup-list { color: #444; font-size: 0.85rem; line-height: 1.4; margin-bottom: 8px; }
        .subs-title { font-weight: bold; font-size: 0.8rem; color: #666; margin-top: 8px; }
        .sub-row { font-size: 0.8rem; color: #555; }
        .sub-time { font-weight: bold; color: #333; font-size: 0.75rem; background: #eee; padding: 1px 4px; border-radius: 3px; }

        .round-header { background: #e0e0e0; padding: 10px 15px; font-weight: bold; margin-top: 25px; border-radius: 4px; }
        
        .loading { padding: 20px; text-align: center; color: #666; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="top-bar">
                <button id="back-btn" class="back-btn hidden" onclick="goBack()">‚Üê</button>
                <h1 id="page-title">World Cup Archive</h1>
            </div>
            <div id="tabs-container" class="gender-tabs">
                <button class="tab-btn active" onclick="switchGender('men', this)">MEN'S</button>
                <button class="tab-btn" onclick="switchGender('women', this)">WOMEN'S</button>
            </div>
        </div>

        <div id="view-home">
            <div class="loading">Loading data...</div>
        </div>
        <div id="view-menu" class="hidden"></div>
        <div id="view-stage" class="hidden stage-container"></div>
        <div id="view-text" class="hidden" style="padding: 20px;"></div>
    </div>

    <script>
        /* -------------------------------------------------------
           APP LOGIC
           ------------------------------------------------------- */
        let fullData = [];
        let currentGender = 'men';
        let currentCup = null;
        let historyStack = [];

        // 1. FETCH DATA ON LOAD
        fetch('world_cup_data.json')
            .then(response => {
                if (!response.ok) { throw new Error("File not found"); }
                return response.json();
            })
            .then(data => {
                fullData = data;
                renderHome(); // Render only after data is loaded
            })
            .catch(error => {
                document.getElementById('view-home').innerHTML = 
                    `<div style="padding:20px; text-align:center; color:red">
                        <strong>Error loading data.</strong><br>
                        Make sure 'world_cup_data.json' is in the same folder.
                    </div>`;
                console.error('Error loading data:', error);
            });

        // 2. UTILITIES
        function cleanName(name) {
            if(!name) return "";
            return name.replace(/not applicable /gi, "").replace(/undefined /gi, "").trim();
        }

        function switchGender(gender, btn) {
            currentGender = gender;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderHome();
        }

        // 3. RENDER HOME
        function renderHome() {
            showView('view-home', 'World Cup Archive', false);
            const container = document.getElementById('view-home');
            container.innerHTML = '';

            if (fullData.length === 0) {
                container.innerHTML = `<div class="loading">No data loaded yet.</div>`;
                return;
            }

            // Filter data by gender
            const filteredData = fullData.filter(c => c.type === currentGender);

            if (filteredData.length === 0 && currentGender === 'men') {
                container.innerHTML = `<div class="loading">No Men's data found.</div>`;
                return;
            }
            
            if (filteredData.length === 0 && currentGender === 'women') {
                container.innerHTML = `<div class="loading">No Women's data available yet.<br><small>(The database currently only has Men's history)</small></div>`;
                return;
            }

            filteredData.forEach(cup => {
                const row = document.createElement('div');
                row.className = 'cup-row';
                const flagUrl = `https://flagcdn.com/w80/${cup.host_flag_code.toLowerCase()}.png`;
                
                row.innerHTML = `
                    <img src="${flagUrl}" class="cup-flag" onerror="this.style.display='none'">
                    <div class="cup-info">
                        <span class="cup-host">${cup.host}</span>
                        <span class="cup-year">${cup.year}</span>
                    </div>
                `;
                row.onclick = () => openMenu(cup);
                container.appendChild(row);
            });
        }

        // 4. RENDER MENU
        function openMenu(cup) {
            currentCup = cup;
            showView('view-menu', `${cup.year} ${cup.host}`, true);
            const container = document.getElementById('view-menu');
            container.innerHTML = ''; 
            
            const grid = document.createElement('div');
            grid.className = 'menu-grid';
            container.appendChild(grid);

            cup.stages_menu.forEach(stage => {
                const btn = document.createElement('button');
                btn.className = 'menu-btn';
                btn.innerText = stage.label;
                btn.addEventListener('click', () => openStage(stage));
                grid.appendChild(btn);
            });

            const sep = document.createElement('hr');
            sep.className = 'separator';
            grid.appendChild(sep);

            const btnWall = document.createElement('button');
            btnWall.className = 'menu-btn secondary';
            btnWall.innerText = 'üå≥ Wall Chart';
            btnWall.addEventListener('click', () => openWallChart());
            grid.appendChild(btnWall);

            const btnOver = document.createElement('button');
            btnOver.className = 'menu-btn secondary';
            btnOver.innerText = 'üìñ Overview';
            btnOver.addEventListener('click', () => openText('overview'));
            grid.appendChild(btnOver);

            const btnContro = document.createElement('button');
            btnContro.className = 'menu-btn secondary';
            btnContro.innerText = '‚ö†Ô∏è Controversies';
            btnContro.addEventListener('click', () => openText('controversies'));
            grid.appendChild(btnContro);
        }

        // 5. RENDER STAGE
        function openStage(stage) {
            showView('view-stage', stage.label, true);
            const container = document.getElementById('view-stage');
            container.innerHTML = '';

            if (!currentCup.stage_data[stage.id]) {
                container.innerHTML = `<p style="padding:20px; color:red;">No data found for ID: ${stage.id}</p>`;
                return;
            }
            const data = currentCup.stage_data[stage.id];
            
            // Draw Table
            if (stage.view_type === 'table_view' && data.table && data.table.length > 0) {
                // Table Headers
                let tableHtml = `
                    <div style="overflow-x:auto; margin-bottom:20px; border:1px solid #eee; border-radius:8px;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9rem; min-width:300px;">
                        <thead>
                            <tr style="background:#f0f0f0;">
                                <th style="padding:10px; text-align:left;">Team</th>
                                <th style="padding:10px;">W</th>
                                <th style="padding:10px;">D</th>
                                <th style="padding:10px;">L</th>
                                <th style="padding:10px;">Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Table Rows
                data.table.forEach(t => {
                    tableHtml += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:10px;">${t.team}</td>
                            <td style="padding:10px; text-align:center;">${t.w}</td>
                            <td style="padding:10px; text-align:center;">${t.d}</td>
                            <td style="padding:10px; text-align:center;">${t.l}</td>
                            <td style="padding:10px; text-align:center;"><strong>${t.pts}</strong></td>
                        </tr>
                    `;
                });
                
                tableHtml += `</tbody></table></div>`;
                container.innerHTML += tableHtml;
            }

            // Draw Matches
            renderMatchList(container, data.matches);
        }

        function openWallChart() {
            showView('view-stage', 'Wall Chart', true);
            const container = document.getElementById('view-stage');
            container.innerHTML = '';
            
            currentCup.stages_menu.forEach(stage => {
                if(stage.view_type === 'bracket_view') {
                    if(currentCup.stage_data[stage.id] && currentCup.stage_data[stage.id].matches) {
                        container.innerHTML += `<div class="round-header">${stage.label}</div>`;
                        renderMatchList(container, currentCup.stage_data[stage.id].matches);
                    }
                }
            });
        }

        // 6. RENDER MATCH DETAILS
        function renderMatchList(container, matches) {
            matches.forEach(m => {
                const card = document.createElement('div');
                card.className = 'match-card';
                
                // --- FILTERS ---
                const homeGoals = (m.goals || []).filter(g => g.team === m.home_team);
                const awayGoals = (m.goals || []).filter(g => g.team === m.away_team);
                const homeCards = (m.cards || []).filter(c => c.team === m.home_team);
                const awayCards = (m.cards || []).filter(c => c.team === m.away_team);
                const homePens = (m.penalties || []).filter(p => p.team === m.home_team);
                const awayPens = (m.penalties || []).filter(p => p.team === m.away_team);

                // --- GENERATORS ---
                const generateEvents = (goals, cards) => {
                    let html = '';
                    goals.forEach(g => html += `<div class="event-row">‚öΩ ${g.min}' ${cleanName(g.player)}</div>`);
                    cards.forEach(c => html += `<div class="event-row">üü® ${c.min}' ${cleanName(c.player)}</div>`);
                    return html || '&nbsp;';
                };

                const generatePens = (pens) => {
                    let html = '';
                    pens.forEach(p => {
                        const icon = p.outcome === 'Goal' ? '‚úÖ' : '‚ùå';
                        html += `<div class="pen-row">${icon} ${p.player}</div>`;
                    });
                    return html;
                };

                // --- LAYOUT BLOCKS ---
                
                // Block 1: Events
                let detailsHtml = `
                    <div class="section-label">Match Events</div>
                    <div class="split-grid">
                        <div class="split-col home">${generateEvents(homeGoals, homeCards)}</div>
                        <div class="split-col away">${generateEvents(awayGoals, awayCards)}</div>
                    </div>
                `;

                // Block 2: Penalties
                if(m.penalties && m.penalties.length > 0) {
                    detailsHtml += `
                        <div class="section-label">Penalty Shootout</div>
                        <div class="split-grid">
                            <div class="split-col home">${generatePens(homePens)}</div>
                            <div class="split-col away">${generatePens(awayPens)}</div>
                        </div>
                    `;
                }

                // Block 3: Lineups
                if(m.lineups) {
                    const subFormat = sub => {
                        return typeof sub === 'string' 
                            ? `<div>${sub}</div>` 
                            : `<div class="sub-row"><span class="sub-time">${sub.min}'</span> ${sub.in} (for ${sub.out})</div>`;
                    };
                    
                    detailsHtml += `
                        <div class="section-label">Lineups</div>
                        <div class="split-grid" style="border-bottom:none;">
                            <div class="split-col home">
                                <div class="lineup-title">Manager: ${m.lineups.home_manager}</div>
                                <div class="lineup-list">
                                    ${m.lineups.home_xi.length > 0 ? m.lineups.home_xi.join(', ') : 'Starting XI not available'}
                                </div>
                                ${m.lineups.home_subs && m.lineups.home_subs.length > 0 ? `<div class="subs-title">Subs</div>` + m.lineups.home_subs.map(subFormat).join('') : ''}
                            </div>
                            <div class="split-col away">
                                <div class="lineup-title">Manager: ${m.lineups.away_manager}</div>
                                <div class="lineup-list">
                                    ${m.lineups.away_xi.length > 0 ? m.lineups.away_xi.join(', ') : 'Starting XI not available'}
                                </div>
                                ${m.lineups.away_subs && m.lineups.away_subs.length > 0 ? `<div class="subs-title">Subs</div>` + m.lineups.away_subs.map(subFormat).join('') : ''}
                            </div>
                        </div>
                    `;
                } else {
                    detailsHtml += `<div style="padding:15px; text-align:center; color:#999;">No lineups available</div>`;
                }

                // --- CARD STRUCTURE ---
                card.innerHTML = `
                    <div class="match-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'block' ? 'none' : 'block'">
                        <div style="flex-grow:1;">
                            <div class="score-line">${m.home_team} ${m.score} ${m.away_team}</div>
                            <div class="match-meta">${m.date} | ${m.stadium}</div>
                        </div>
                        <div>‚ñæ</div>
                    </div>
                    <div class="match-details">
                        ${detailsHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 7. UTILS
        function openText(type) {
            const title = type === 'overview' ? 'Overview' : 'Controversies';
            showView('view-text', title, true);
            const text = currentCup.details[type] || "No text available.";
            document.getElementById('view-text').innerHTML = `<h2>${title}</h2><p>${text}</p>`;
        }

        function showView(viewId, title, showBack) {
            ['view-home', 'view-menu', 'view-stage', 'view-text'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById('page-title').innerText = title;
            
            const backBtn = document.getElementById('back-btn');
            const tabs = document.getElementById('tabs-container');

            window.scrollTo(0,0);

            if(showBack) {
                backBtn.classList.remove('hidden');
                tabs.classList.add('hidden');
                historyStack.push(viewId);
            } else {
                backBtn.classList.add('hidden');
                tabs.classList.remove('hidden');
                historyStack = [];
            }
        }

        function goBack() {
            const current = document.querySelector('div:not(.hidden)[id^="view-"]').id;
            if(current === 'view-menu') {
                renderHome();
            } else {
                openMenu(currentCup);
            }
        }
    </script>
</body>
</html>