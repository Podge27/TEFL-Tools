<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Grammar Tool</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="global.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- CORE THEME --- */
        :root {
            --bg-paper: #FFFDF5;
            --text-main: #2D3748;
            --btn-blue: #4299E1;
            --btn-teal: #38B2AC;
            --btn-orange: #ED8936;
        }

        body { 
            font-family: 'Verdana', 'Segoe UI', sans-serif; 
            margin: 0; color: var(--text-main); 
            display: flex; flex-direction: column; height: 100vh; 
            background: var(--bg-paper); overflow: hidden;
        }

        /* --- HEADER --- */
        header { 
            background: #E2E8F0; height: 70px; flex-shrink: 0;
            display: flex; align-items: center; padding: 0 20px;
            border-bottom: 3px solid #CBD5E0; gap: 15px; z-index: 50;
        }

        .nav-btn {
            background: white; border: 2px solid #CBD5E0; border-bottom: 4px solid #CBD5E0;
            font-weight: bold; padding: 8px 15px; border-radius: 8px; cursor: pointer;
        }
        .nav-btn:active { transform: translateY(2px); border-bottom: 2px solid #CBD5E0; }
        
        #sidebar-toggle { background: var(--btn-orange); color: white; border-color: #C05621; }
        #header-title { font-size: 1.4rem; font-weight: 700; margin-left: 10px; flex-grow: 1; text-align: right;}

        /* --- LAYOUT --- */
        .main-container { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 70px); position: relative; }
        
        /* MAIN APP SIDEBAR (Push Layout) */
        #app-sidebar { 
            width: 260px; background: #2D3748; color: white;
            display: flex; flex-direction: column; padding: 20px; 
            transition: margin-left 0.3s ease; flex-shrink: 0;
            border-right: 5px solid #1A202C; overflow-y: auto; 
            z-index: 40; /* Standard layer */
        }
        #app-sidebar.collapsed { margin-left: -310px; }

        /* STAGE */
        #stage { 
            flex: 1; padding: 40px; overflow-y: auto; 
            background: var(--bg-paper); display: flex; flex-direction: column;
            position: relative;
        }

        /* --- LOGO AREA --- */
        .logo-wrapper {
            display: flex; justify-content: center; align-items: center; gap: 30px;
            margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px dashed #CBD5E0;
        }
        .logo-img { height: 80px; width: auto; object-fit: contain; }

        /* --- BUTTONS & GRID --- */
        .fun-btn { 
            background: var(--btn-teal); color: white; border: none;
            border-bottom: 6px solid #2C7A7B; padding: 20px; font-size: 1.3rem; 
            font-weight: bold; cursor: pointer; border-radius: 15px; text-align: center;
        }
        .fun-btn:hover { filter: brightness(110%); transform: translateY(-2px); }
        
        .resource-btn {
            width: 100%; background: #4A5568; color: white; border: none;
            border-bottom: 4px solid #2D3748; padding: 15px; text-align: left;
            font-size: 1.1rem; cursor: pointer; margin-bottom: 12px; border-radius: 10px;
            text-transform: capitalize; 
        }
        .resource-btn.active { background: var(--btn-blue); border-bottom-color: #2B6CB0; transform: translateX(5px); }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .hidden { display: none !important; }

        /* --- CONTENT STYLES --- */
        #menu-view { max-width: 900px; margin: 0 auto; width: 100%; text-align: center; }
        
        /* Centered Lesson Content */
        #lesson-content {
            max-width: 800px; margin: 0 auto; width: 100%; 
            font-size: 1.1rem; line-height: 1.6;
        }

        .gap-container { font-size: 2.5rem; line-height: 2.5; text-align: center; margin-top: 30px; }
        .gap-box { border-bottom: 4px dashed #4A5568; min-width: 100px; display: inline-block; cursor: pointer; color: transparent; margin: 0 10px; }
        .gap-box.revealed { color: #2F855A; border-bottom: 4px solid #2F855A; }

        /* =========================================
           WHITEBOARD PRO (Fixed Overlay)
           ========================================= */
        #whiteboard-wrapper {
            position: fixed; /* COVERS EVERYTHING */
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: #f4f4f4; z-index: 5000; /* Highest Z-Index */
            display: flex;
        }

        /* WB HEADER CONTROLS */
        #wb-header-controls { display: flex; gap: 10px; margin-left: 10px; }

        /* WB SIDEBAR */
        #wb-sidebar {
            width: 200px; background: #e5e5e5; border-right: 1px solid #ccc;
            display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0;
            transition: margin-left 0.3s ease;
        }
        #wb-sidebar.collapsed { margin-left: -200px; }
        
        .sidebar-header {
            padding: 10px; background: #ddd; font-weight: bold; font-size: 0.85rem; color: #555;
            display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 5;
        }
        .page-card {
            background: white; margin: 10px; padding: 5px; border-radius: 6px; cursor: pointer;
            border: 2px solid transparent; display: flex; flex-direction: column; gap: 5px;
        }
        .page-card.active { border-color: #2563EB; box-shadow: 0 0 0 1px #2563EB; }
        .thumb-box { height: 100px; background: #f0f0f0; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .thumb-box img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* WB MAIN AREA */
        #wb-main { flex: 1; display: flex; flex-direction: column; padding: 10px; position: relative; overflow: hidden; }

        /* WB TOOLBAR */
        #wb-toolbar {
            display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; align-items: center;
            background: white; padding: 8px; border-radius: 8px; border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 10;
            transition: all 0.3s ease; max-height: 200px; overflow: visible;
        }
        #wb-toolbar.collapsed { max-height: 0; padding: 0; opacity: 0; overflow: hidden; margin-bottom:0; border:none;}

        .tool-btn {
            padding: 6px 10px; border: 1px solid #ccc; border-bottom: 2px solid #ccc;
            background: #f9f9f9; border-radius: 6px; cursor: pointer; font-weight: 600; 
            color: #555; font-family: 'Inter', sans-serif; font-size: 0.85rem;
            display: flex; align-items: center; gap: 4px;
        }
        .tool-btn.active { background: #333; color: white; border-color: #000; }
        .btn-delete { color: #d32f2f; background: #fff5f5; border-color: #feb2b2; }
        .sep { width: 1px; height: 20px; background: #ddd; margin: 0 2px; }

        /* DROPDOWNS */
        .dropdown-container { position: relative; }
        .dropdown-menu {
            position: absolute; top: 110%; left: 0; background: white;
            border: 1px solid #ccc; border-radius: 8px; padding: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 5px; z-index: 20; min-width: 140px;
        }
        #save-menu { right: 0; left: auto; }

        /* CANVAS FRAME */
        .canvas-frame {
            flex: 1; width: 100%; background: #e5e5e5; border: 1px solid #ccc; border-radius: 8px;
            position: relative; overflow: auto; display: flex; flex-direction: column; align-items: center;
        }
        .canvas-container { background-color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 20px; margin-bottom: 60px; }

        /* FLOAT BUTTONS */
        #btn-extend-float {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; border: none; padding: 10px 20px; border-radius: 20px; 
            cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 5;
        }

        /* UTILS */
        #color-palette { display: flex; align-items: center; }
        .color-dot { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; margin: 0 2px; box-shadow: 0 0 0 1px #ddd; border: 2px solid transparent; }
        .color-dot.active { transform: scale(1.2); border-color: #333; }
        
        /* CURSORS */
        .cursor-pen { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="black"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>') 0 24, auto !important; }
        .cursor-marker { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="deeppink"><path d="M18.5 2.5L21.5 5.5L7.5 19.5H4.5V16.5L18.5 2.5Z"/></svg>') 0 24, auto !important; }
        .cursor-rubber { cursor: cell !important; }

    </style>
</head>
<body>

    <header>
        <button id="sidebar-toggle" class="nav-btn hidden" onclick="toggleMainSidebar()"><span>‚ò∞</span> Menu</button>
        <button id="header-back-btn" class="nav-btn" onclick="handleBackClick()"><span>‚Ü©</span> Back</button>
        
        <div id="wb-header-controls" class="hidden">
            <button class="tool-btn" onclick="toggleWbSidebar()">‚ò∞ Slides</button>
            <button class="tool-btn" onclick="toggleWbToolbar()">‚úé Tools</button>
        </div>

        <div id="header-title">Tefl Tools</div>
    </header>

    <div class="main-container">
        
        <aside id="app-sidebar" class="collapsed">
            <h3 style="color: #A0AEC0; font-size: 0.85rem;">LESSONS</h3>
            <div id="resource-buttons"></div>
        </aside>

        <main id="stage">
            
            <div id="menu-view">
                
                <div class="logo-wrapper">
                    <img src="assets/logo1.png" alt="Company 1" class="logo-img" onerror="this.style.display='none'">
                    <img src="assets/logo2.svg" alt="Company 2" class="logo-img" onerror="this.style.display='none'">
                </div>

                <div id="level-selection">
                    <h1>Courses</h1>
                    <div id="level-list" class="grid"></div>
                </div>
                <div id="topic-selection" class="hidden">
                    <h1>Modules</h1>
                    <div id="topic-list" class="grid"></div>
                </div>
            </div>

            <div id="content-view" class="hidden">
                <div id="intro-message" style="text-align: center; color: #A0AEC0; margin-top: 100px;">
                    <h2>Select a lesson from the menu üëà</h2>
                </div>
                <div id="lesson-content"></div>
            </div>

            <div id="whiteboard-wrapper" class="hidden">
                
                <aside id="wb-sidebar" class="collapsed">
                    <div class="sidebar-header">
                        <span>SLIDES</span>
                        <button onclick="addPage()" style="border:none;background:none;cursor:pointer;">+</button>
                    </div>
                    <div id="wb-sidebar-content"></div>
                </aside>

                <div id="wb-main">
                    <div id="wb-toolbar">
                        <button class="tool-btn" onclick="undo()">‚Ü©</button>
                        <button class="tool-btn" onclick="redo()">‚Ü™</button>
                        <div class="sep"></div>
                        <button class="tool-btn active" id="btn-pen" onclick="setTool('pen', this)">üñä</button>
                        <button class="tool-btn" id="btn-marker" onclick="setTool('marker', this)">üñç</button>
                        <button class="tool-btn" onclick="setTool('rubber', this)">‚¨ú</button>
                        <div class="sep"></div>
                        <button class="tool-btn" onclick="setTool('text', this)">Tt</button>
                        
                        <div class="dropdown-container">
                            <button class="tool-btn" onclick="toggleDropdown('shapes-menu')">üìê ‚ñæ</button>
                            <div id="shapes-menu" class="dropdown-menu hidden" style="flex-direction:row;">
                                <button class="tool-btn" onclick="addShape('line')">‚ï±</button>
                                <button class="tool-btn" onclick="addShape('rect')">‚¨ú</button>
                                <button class="tool-btn" onclick="addShape('circle')">‚ö™</button>
                                <button class="tool-btn" onclick="addShape('speech')">üí¨</button>
                            </div>
                        </div>

                        <button class="tool-btn" onclick="triggerImageUpload()">üñºÔ∏è</button>
                        <input type="file" id="img-upload" accept="image/*" style="display:none" onchange="addImage(this)">

                        <div class="dropdown-container">
                            <button class="tool-btn" onclick="toggleDropdown('arrange-menu')">üìö ‚ñæ</button>
                            <div id="arrange-menu" class="dropdown-menu hidden">
                                <button class="tool-btn" onclick="setLayer('back')">To Back</button>
                                <button class="tool-btn" onclick="setLayer('front')">To Front</button>
                                <button class="tool-btn" onclick="flipObject('h')">Flip</button>
                                <button class="tool-btn" onclick="groupObjects()">Group</button>
                                <button class="tool-btn" onclick="ungroupObjects()">Ungroup</button>
                            </div>
                        </div>

                        <button class="tool-btn" onclick="toggleCurtain()" id="btn-curtain">üõë</button>
                        <button class="tool-btn" onclick="toggleZoom()" id="btn-zoom">üîç 100%</button>
                        <button class="tool-btn btn-delete" onclick="deleteSelected()">üóë</button>
                        
                        <div class="sep"></div>
                        <div class="dropdown-container">
                            <button class="tool-btn" onclick="toggleDropdown('bg-menu')">üìÑ ‚ñæ</button>
                            <div id="bg-menu" class="dropdown-menu hidden">
                                <button class="tool-btn" onclick="setPaper('blank')">Blank</button>
                                <button class="tool-btn" onclick="setPaper('lines')">Lines</button>
                                <button class="tool-btn" onclick="setPaper('grid')">Grid</button>
                            </div>
                        </div>
                        
                        <div class="sep"></div>
                        <div id="color-palette"></div>
                        <div class="sep"></div>

                        <button class="tool-btn" onclick="prevPage()">‚¨Ö</button>
                        <span id="page-indicator" style="font-size:0.8rem; font-weight:bold;">1/1</span>
                        <button class="tool-btn" onclick="nextPage()">‚û°</button>
                        <button class="tool-btn" onclick="addPage()">+</button>
                        
                        <div style="flex:1;"></div>
                        
                        <div class="dropdown-container">
                            <button class="tool-btn" onclick="toggleDropdown('save-menu')">üíæ ‚ñæ</button>
                            <div id="save-menu" class="dropdown-menu hidden">
                                <button class="tool-btn" onclick="downloadBackup()">Save File</button>
                                <button class="tool-btn" onclick="exportPDF()">Export PDF</button>
                            </div>
                        </div>
                        <button class="tool-btn" onclick="triggerLoad()">‚¨Ü</button>
                        <input type="file" id="file-upload" accept=".json" style="display:none" onchange="loadBackup(this)">
                        <button class="tool-btn" onclick="clearPage()">üßπ</button>
                    </div>

                    <div class="canvas-frame">
                        <canvas id="c"></canvas>
                        <button id="btn-extend-float" onclick="extendPage()">‚¨á Extend Page</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- 1. GLOBAL STATE ---
        let grammarData = [];
        let currentView = 'levels'; 
        let currentLevel = '';

        // --- WHITEBOARD STATE ---
        let canvas; 
        let wbPages = []; 
        let wbBackgrounds = []; 
        let wbThumbnails = [];
        let currentPageIndex = 0;
        let currentTool = 'pen';
        let currentColor = '#333333';
        let isZoomedOut = false;
        
        const PALETTES = {
            pen: ['#333333', '#2563EB', '#DC2626', '#16A34A'], 
            marker: ['#FEF08A', '#FBCFE8', '#A5B4FC', '#67E8F9'] 
        };
        const SVG_SPEECH = "M20,2H4C2.9,2,2,2.9,2,4v18l4-4h14c1.1,0,2-0.9,2-2V4C22,2.9,21.1,2,20,2z";
        
        let history = []; let historyStep = -1; let isHistoryProcessing = false;

        document.addEventListener('DOMContentLoaded', () => {
            fetch('grammar.json').then(res => res.json()).then(data => {
                grammarData = data;
                renderLevels();
                updateHeader();
            }).catch(() => console.error("Missing grammar.json"));

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown-container')) {
                    document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.add('hidden'));
                }
            });
        });

        // --- APP NAVIGATION ---
        function handleBackClick() {
            // If Whiteboard open, close it (Full Reset)
            const wb = document.getElementById('whiteboard-wrapper');
            if (!wb.classList.contains('hidden')) {
                wb.classList.add('hidden');
                document.getElementById('wb-header-controls').classList.add('hidden');
                
                // Show Lesson Content again
                document.getElementById('content-view').classList.remove('hidden');
                document.getElementById('app-sidebar').classList.remove('hidden');
                document.getElementById('app-sidebar').classList.remove('collapsed'); // Auto-open sidebar
                return;
            }

            if (currentView === 'levels') window.location.href = 'index.html'; 
            else if (currentView === 'topics') renderLevels();
            else if (currentView === 'content') renderTopics(currentLevel);
        }

        function toggleMainSidebar() { document.getElementById('app-sidebar').classList.toggle('collapsed'); }

        function updateHeader() {
            const btn = document.getElementById('header-back-btn');
            const toggle = document.getElementById('sidebar-toggle');
            
            if (currentView === 'levels') {
                btn.innerHTML = '‚úï Exit'; toggle.classList.add('hidden'); 
                document.getElementById('app-sidebar').classList.add('hidden');
            } else if (currentView === 'topics') {
                btn.innerHTML = '‚Ü© Levels'; toggle.classList.add('hidden'); 
                document.getElementById('app-sidebar').classList.add('hidden');
            } else if (currentView === 'content') {
                btn.innerHTML = '‚Ü© Modules'; toggle.classList.remove('hidden'); 
                document.getElementById('app-sidebar').classList.remove('hidden');
            }
        }

        function hideAll() {
            document.getElementById('menu-view').classList.add('hidden');
            document.getElementById('level-selection').classList.add('hidden');
            document.getElementById('topic-selection').classList.add('hidden');
            document.getElementById('content-view').classList.add('hidden');
            document.getElementById('whiteboard-wrapper').classList.add('hidden');
        }

        // --- GRAMMAR RENDERERS ---
        function renderLevels() {
            currentView = 'levels'; hideAll();
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('level-selection').classList.remove('hidden');
            const list = document.getElementById('level-list'); list.innerHTML = "";
            [...new Set(grammarData.map(i => i.level))].forEach(lvl => {
                const btn = document.createElement('button'); btn.className = 'fun-btn'; btn.innerText = lvl;
                btn.onclick = () => { currentLevel = lvl; renderTopics(lvl); };
                list.appendChild(btn);
            });
            updateHeader();
        }

        function renderTopics(lvl) {
            currentView = 'topics'; hideAll();
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('topic-selection').classList.remove('hidden');
            const list = document.getElementById('topic-list'); list.innerHTML = "";
            grammarData.filter(i => i.level === lvl).forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'fun-btn'; btn.style.backgroundColor = '#ED8936'; btn.style.borderBottomColor = '#C05621';
                btn.innerText = item.topic;
                btn.onclick = () => loadLesson(item.slug);
                list.appendChild(btn);
            });
            updateHeader();
        }

        function loadLesson(slug) {
            currentView = 'content'; hideAll();
            document.getElementById('content-view').classList.remove('hidden'); updateHeader();
            
            // Auto-open sidebar for lessons
            document.getElementById('app-sidebar').classList.remove('collapsed');

            const point = grammarData.find(i => i.slug === slug);
            const btnBox = document.getElementById('resource-buttons');
            const stage = document.getElementById('lesson-content');
            
            btnBox.innerHTML = ""; stage.innerHTML = "";
            document.getElementById('intro-message').classList.remove('hidden');

            // 1. WHITEBOARD BUTTON
            const wbBtn = document.createElement('button');
            wbBtn.className = 'resource-btn';
            wbBtn.innerHTML = "‚úèÔ∏è <b>Whiteboard</b>"; 
            wbBtn.style.color = "#ED8936";
            wbBtn.onclick = () => {
                activateButton(wbBtn);
                openWhiteboard();
            };
            btnBox.appendChild(wbBtn);

            // 2. RESOURCES
            if(point && point.resources) {
                Object.keys(point.resources).forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'resource-btn';
                    btn.innerText = key.replace(/_/g, ' '); 
                    
                    btn.onclick = () => {
                        activateButton(btn);
                        document.getElementById('intro-message').classList.add('hidden');
                        stage.classList.remove('hidden');
                        document.getElementById('whiteboard-wrapper').classList.add('hidden');
                        
                        const res = point.resources[key];
                        stage.innerHTML = res; // Direct HTML injection
                    };
                    btnBox.appendChild(btn);
                });
            }
        }

        function activateButton(activeBtn) {
            document.querySelectorAll('.resource-btn').forEach(b => b.classList.remove('active'));
            activeBtn.classList.add('active');
        }

        // ============================================
        // --- WHITEBOARD PRO LOGIC ---
        // ============================================

        function openWhiteboard() {
            document.getElementById('whiteboard-wrapper').classList.remove('hidden');
            document.getElementById('wb-header-controls').classList.remove('hidden');
            if (!canvas) initWhiteboard(); else resizeCanvas();
        }

        function toggleWbSidebar() { document.getElementById('wb-sidebar').classList.toggle('collapsed'); }
        function toggleWbToolbar() { document.getElementById('wb-toolbar').classList.toggle('collapsed'); setTimeout(resizeCanvas, 300); }

        function initWhiteboard() {
            canvas = new fabric.Canvas('c', { isDrawingMode: true, backgroundColor: 'white', selection: true });
            canvas.on('path:created', onCanvasChange); canvas.on('object:modified', onCanvasChange); canvas.on('object:added', (e) => { if(!isHistoryProcessing && !e.target.isCurtain) onCanvasChange(); });

            const saved = localStorage.getItem('integratedWb');
            if (saved) { 
                const data = JSON.parse(saved); wbPages = data.pages; wbBackgrounds = data.bgs; wbThumbnails = data.thumbs;
                if(wbThumbnails.length < wbPages.length) wbThumbnails = new Array(wbPages.length).fill(null);
                loadPage(0);
            } else { 
                wbPages = [JSON.stringify(canvas)]; wbBackgrounds = ['blank']; wbThumbnails = [null];
                saveHistory(); resizeCanvas();
            }
            setTool('pen', document.getElementById('btn-pen')); renderWbSidebar();
        }

        function onCanvasChange() { saveHistory(); if(this.thumbTimeout) clearTimeout(this.thumbTimeout); this.thumbTimeout = setTimeout(() => { generateThumbnail(); }, 500); }
        function resizeCanvas() { const frame = document.querySelector('.canvas-frame'); if(!frame) return; const w = frame.clientWidth - 4; let h = frame.clientHeight - 4; if (canvas && canvas.getHeight() > h) h = canvas.getHeight(); if(canvas) { canvas.setWidth(w); canvas.setHeight(h); canvas.renderAll(); canvas.calcOffset(); } }

        function renderWbSidebar() {
            const container = document.getElementById('wb-sidebar-content'); container.innerHTML = '';
            wbPages.forEach((pg, idx) => {
                const card = document.createElement('div'); card.className = `page-card ${idx === currentPageIndex ? 'active' : ''}`;
                card.onclick = () => { if(idx !== currentPageIndex) switchPage(idx); };
                const thumbBox = document.createElement('div'); thumbBox.className = 'thumb-box';
                if (wbThumbnails[idx]) { const img = document.createElement('img'); img.src = wbThumbnails[idx]; thumbBox.appendChild(img); } else { thumbBox.innerText = `Slide ${idx + 1}`; }
                card.appendChild(thumbBox); container.appendChild(card);
            });
        }

        function generateThumbnail() { const dataUrl = canvas.toDataURL({ format: 'jpeg', quality: 0.5, multiplier: 0.2 }); wbThumbnails[currentPageIndex] = dataUrl; renderWbSidebar(); saveToStorage(); }
        function switchPage(index) { saveCurrentState(); currentPageIndex = index; loadPage(index); renderWbSidebar(); }
        function loadPage(index) { const data = wbPages[index]; const json = JSON.parse(data); const frame = document.querySelector('.canvas-frame'); let targetH = frame.clientHeight - 4; if(json.height && json.height > targetH) targetH = json.height; canvas.setHeight(targetH); canvas.setWidth(frame.clientWidth - 4); canvas.loadFromJSON(data, () => { setPaper(wbBackgrounds[index] || 'blank'); history = [data]; historyStep = 0; applyToolSettings(); }); currentPageIndex = index; updateUI(); }
        function addPage() { saveCurrentState(); canvas.clear(); resizeCanvas(); canvas.setBackgroundColor('white', null); wbPages.push(JSON.stringify(canvas)); wbBackgrounds.push('blank'); wbThumbnails.push(null); currentPageIndex = wbPages.length - 1; history = []; historyStep = -1; saveHistory(); updateUI(); renderWbSidebar(); }
        function extendPage() { canvas.setHeight(canvas.getHeight() + 600); setPaper(wbBackgrounds[currentPageIndex]); onCanvasChange(); }
        function saveCurrentState() { wbPages[currentPageIndex] = JSON.stringify(canvas); saveToStorage(); }
        function saveToStorage() { const data = { pages: wbPages, bgs: wbBackgrounds, thumbs: wbThumbnails }; localStorage.setItem('integratedWb', JSON.stringify(data)); }
        function prevPage() { if(currentPageIndex > 0) switchPage(currentPageIndex - 1); }
        function nextPage() { if(currentPageIndex === wbPages.length - 1) addPage(); else switchPage(currentPageIndex + 1); }

        function setTool(tool, btn) { currentTool = tool; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.add('hidden')); if (tool === 'pen') renderColors('pen'); else if (tool === 'marker') renderColors('marker'); applyToolSettings(); }
        function applyToolSettings() { if(isZoomedOut) return; const canvasEl = document.querySelector('.upper-canvas'); canvas.isDrawingMode = false; canvas.selection = true; if (currentTool === 'pen') { canvas.isDrawingMode = true; canvas.freeDrawingBrush = new fabric.PencilBrush(canvas); canvas.freeDrawingBrush.width = 3; canvas.freeDrawingBrush.color = currentColor; if(canvasEl) canvasEl.className = 'upper-canvas cursor-pen'; } else if (currentTool === 'marker') { canvas.isDrawingMode = true; canvas.freeDrawingBrush = new fabric.PencilBrush(canvas); canvas.freeDrawingBrush.width = 25; canvas.freeDrawingBrush.color = hexToRgba(currentColor, 0.4); if(canvasEl) canvasEl.className = 'upper-canvas cursor-marker'; } else if (currentTool === 'rubber') { canvas.isDrawingMode = true; canvas.freeDrawingBrush = new fabric.PencilBrush(canvas); canvas.freeDrawingBrush.width = 40; canvas.freeDrawingBrush.color = 'white'; if(canvasEl) canvasEl.className = 'upper-canvas cursor-rubber'; } else if (currentTool === 'text') { const text = new fabric.IText('Type here...', { left: 100, top: 100, fontSize: 30, fontFamily: 'Inter', fill: currentColor }); canvas.add(text); canvas.setActiveObject(text); setTool('select'); if(canvasEl) canvasEl.className = 'upper-canvas'; } else { if(canvasEl) canvasEl.className = 'upper-canvas'; } }

        function toggleDropdown(id) { const menu = document.getElementById(id); const isHidden = menu.classList.contains('hidden'); document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.add('hidden')); if(isHidden) menu.classList.remove('hidden'); }
        function toggleCurtain() { const cur = canvas.getObjects().find(o => o.isCurtain); if(cur) { canvas.remove(cur); document.getElementById('btn-curtain').classList.remove('active'); } else { const c = new fabric.Rect({left:0,top:0,width:canvas.getWidth(),height:canvas.getHeight(),fill:'rgba(100,100,100,0.95)',selectable:true,hasControls:false,isCurtain:true}); canvas.add(c); canvas.setActiveObject(c); setTool('select'); document.getElementById('btn-curtain').classList.add('active'); } }
        function toggleZoom() { const btn = document.getElementById('btn-zoom'); const frame = document.querySelector('.canvas-frame'); if (!isZoomedOut) { const ratio = frame.clientHeight / canvas.getHeight(); if (ratio < 1) { canvas.setZoom(ratio); canvas.setWidth(canvas.getWidth() * ratio); canvas.setHeight(canvas.getHeight() * ratio); btn.innerHTML = "üîç Fit"; isZoomedOut = true; } } else { loadPage(currentPageIndex); btn.innerHTML = "üîç 100%"; isZoomedOut = false; } }
        function setPaper(type) { wbBackgrounds[currentPageIndex] = type; if (type === 'blank') { canvas.setBackgroundColor('white', canvas.renderAll.bind(canvas)); } else { const pC = document.createElement('canvas'); const ctx = pC.getContext('2d'); if (type === 'lines') { pC.width=40; pC.height=40; ctx.fillStyle='white'; ctx.fillRect(0,0,40,40); ctx.beginPath(); ctx.moveTo(0,39); ctx.lineTo(40,39); ctx.strokeStyle='#add8e6'; ctx.stroke(); } else { pC.width=30; pC.height=30; ctx.fillStyle='white'; ctx.fillRect(0,0,30,30); ctx.beginPath(); ctx.moveTo(0,29); ctx.lineTo(30,29); ctx.moveTo(29,0); ctx.lineTo(29,30); ctx.strokeStyle='#ddd'; ctx.stroke(); } canvas.setBackgroundColor(new fabric.Pattern({ source: pC, repeat: 'repeat' }), canvas.renderAll.bind(canvas)); } saveHistory(); }
        function addShape(type) { let shape; const opts = { left: 150, top: 150, fill: 'transparent', stroke: currentColor, strokeWidth: 3 }; switch(type) { case 'line': shape = new fabric.Line([50, 100, 200, 100], { ...opts, fill: currentColor }); break; case 'rect': shape = new fabric.Rect({ ...opts, width: 100, height: 100 }); break; case 'circle': shape = new fabric.Circle({ ...opts, radius: 50 }); break; case 'speech': shape = new fabric.Path(SVG_SPEECH, { ...opts, scaleX:3, scaleY:3 }); break; } if(shape) { canvas.add(shape); canvas.setActiveObject(shape); setTool('select'); } }
        
        function renderColors(type) { const container = document.getElementById('color-palette'); container.innerHTML = ''; const palette = PALETTES[type] || PALETTES['pen']; palette.forEach((color, index) => { const dot = document.createElement('div'); dot.className = 'color-dot'; dot.style.backgroundColor = color; if (index === 0) { dot.classList.add('active'); currentColor = color; } dot.onclick = () => { document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); dot.classList.add('active'); setColor(color); }; container.appendChild(dot); }); setColor(palette[0]); }
        function setColor(color) { currentColor = color; const ao = canvas.getActiveObject(); if(ao && currentTool === 'select') { if(ao.type==='i-text') ao.set('fill', color); else ao.set('stroke', color); canvas.renderAll(); saveHistory(); } if(currentTool!=='rubber') applyToolSettings(); }
        function triggerImageUpload() { document.getElementById('img-upload').click(); }
        function addImage(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{fabric.Image.fromURL(e.target.result, i=>{if(i.width>canvas.width/2)i.scaleToWidth(canvas.width/2);canvas.add(i);canvas.setActiveObject(i);});}; r.readAsDataURL(f); }
        function deleteSelected() { const ao=canvas.getActiveObject(); if(ao){if(ao.type==='activeSelection')ao.forEachObject(o=>canvas.remove(o));else canvas.remove(ao);canvas.discardActiveObject();saveHistory();} }
        function setLayer(a) { const o = canvas.getActiveObject(); if(o) a==='back'?canvas.sendToBack(o):canvas.bringToFront(o); saveHistory(); }
        function flipObject(d) { const o = canvas.getActiveObject(); if(o) d==='h'?o.toggle('flipX'):o.toggle('flipY'); canvas.renderAll(); saveHistory(); }
        function groupObjects() { const o = canvas.getActiveObject(); if(o && o.type==='activeSelection') { o.toGroup(); canvas.requestRenderAll(); saveHistory(); } }
        function ungroupObjects() { const o = canvas.getActiveObject(); if(o && o.type==='group') { o.toActiveSelection(); canvas.requestRenderAll(); saveHistory(); } }
        function hexToRgba(hex, alpha) { let c; if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){ c= hex.substring(1).split(''); if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; } c= '0x'+c.join(''); return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')'; } return hex; }

        function undo() { if (historyStep > 0) { isHistoryProcessing = true; historyStep--; canvas.loadFromJSON(history[historyStep], () => { canvas.renderAll(); isHistoryProcessing = false; applyToolSettings(); }); }}
        function redo() { if (historyStep < history.length - 1) { isHistoryProcessing = true; historyStep++; canvas.loadFromJSON(history[historyStep], () => { canvas.renderAll(); isHistoryProcessing = false; applyToolSettings(); }); }}
        function saveHistory() { if (isHistoryProcessing) return; if (historyStep < history.length - 1) history = history.slice(0, historyStep + 1); history.push(JSON.stringify(canvas)); historyStep++; }
        function clearPage() { canvas.clear(); setPaper(wbBackgrounds[currentPageIndex]); saveHistory(); }
        function updateUI() { document.getElementById('page-indicator').innerText = `${currentPageIndex + 1} / ${wbPages.length}`; document.getElementById('btn-curtain').classList.remove('active'); }

        function downloadBackup() { saveCurrentState(); let name = prompt("Filename:", "lesson"); if(!name) return; const data = { pages: wbPages, bgs: wbBackgrounds, thumbs: wbThumbnails }; const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); a.download = name + ".json"; document.body.appendChild(a); a.click(); a.remove(); }
        function triggerLoad() { document.getElementById('file-upload').click(); }
        function loadBackup(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { try { const d = JSON.parse(e.target.result); wbPages = d.pages; wbBackgrounds = d.bgs; wbThumbnails = d.thumbs; loadPage(0); renderWbSidebar(); alert("Loaded!"); } catch(err) { alert("Error loading."); } }; r.readAsText(f); }
        async function exportPDF() { saveCurrentState(); const { jsPDF } = window.jspdf; const pdf = new jsPDF('l', 'px', [canvas.width, canvas.height]); const tC = document.createElement('canvas'); const hF = new fabric.Canvas(tC); for(let i=0; i<wbPages.length; i++) { const pd = JSON.parse(wbPages[i]); hF.setWidth(pd.width||canvas.width); hF.setHeight(pd.height||canvas.height); if(i>0) pdf.addPage([hF.getWidth(), hF.getHeight()]); await new Promise(r => hF.loadFromJSON(wbPages[i], () => { const bg = wbBackgrounds[i]; if(bg!=='blank') { const p=document.createElement('canvas');const x=p.getContext('2d'); if(bg==='lines'){p.width=40;p.height=40;x.fillStyle='white';x.fillRect(0,0,40,40);x.beginPath();x.moveTo(0,39);x.lineTo(40,39);x.strokeStyle='#add8e6';x.stroke();} else{p.width=30;p.height=30;x.fillStyle='white';x.fillRect(0,0,30,30);x.beginPath();x.moveTo(0,29);x.lineTo(30,29);x.moveTo(29,0);x.lineTo(29,30);x.strokeStyle='#ddd';x.stroke();} hF.setBackgroundColor(new fabric.Pattern({source:p,repeat:'repeat'}), r); } else hF.setBackgroundColor('white', r); })); pdf.addImage(hF.toDataURL("image/jpeg", 0.8), 'JPEG', 0, 0, hF.getWidth(), hF.getHeight()); } pdf.save("export.pdf"); }
    </script>
</body>
</html>