<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Grammar Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- 1. CORE THEME --- */
        :root {
            --bg-paper: #FFFDF5;
            --text-main: #2D3748;
            --btn-blue: #4299E1;
            --btn-teal: #38B2AC;
            --btn-orange: #ED8936;
        }

        body { 
            font-family: 'Verdana', 'Segoe UI', sans-serif; 
            margin: 0; color: var(--text-main); 
            display: flex; flex-direction: column; height: 100vh; 
            background: var(--bg-paper); overflow: hidden;
        }

        /* --- 2. HEADER --- */
        header { 
            background: #E2E8F0; height: 70px; flex-shrink: 0;
            display: flex; align-items: center; padding: 0 20px;
            border-bottom: 3px solid #CBD5E0; gap: 15px;
        }

        .nav-btn {
            background: white; border: 2px solid #CBD5E0; border-bottom: 4px solid #CBD5E0;
            font-weight: bold; padding: 8px 15px; border-radius: 8px; cursor: pointer;
        }
        .nav-btn:active { transform: translateY(2px); border-bottom: 2px solid #CBD5E0; }
        
        #sidebar-toggle { background: var(--btn-orange); color: white; border-color: #C05621; }
        #header-title { font-size: 1.4rem; font-weight: 700; margin-left: 10px; }

        /* --- 3. LAYOUT --- */
        .main-container { display: flex; flex: 1; overflow: hidden; height: calc(100vh - 70px); }
        
        #sidebar { 
            width: 260px; background: #2D3748; color: white;
            display: flex; flex-direction: column; padding: 20px; 
            transition: margin-left 0.3s; flex-shrink: 0;
            border-right: 5px solid #1A202C; overflow-y: auto; 
        }
        #sidebar.collapsed { margin-left: -310px; }

        #stage { 
            flex: 1; padding: 40px; overflow-y: auto; 
            background: var(--bg-paper); display: flex; flex-direction: column;
        }

        /* --- 4. BUTTONS & GRID (FIXED STRETCHING) --- */
        #menu-view { max-width: 900px; margin: 0 auto; width: 100%; text-align: center; }

        .fun-btn { 
            background: var(--btn-teal); color: white; border: none;
            border-bottom: 6px solid #2C7A7B; padding: 20px; font-size: 1.3rem; 
            font-weight: bold; cursor: pointer; border-radius: 15px; text-align: center;
        }
        .fun-btn:hover { filter: brightness(110%); transform: translateY(-2px); }
        
        .resource-btn {
            width: 100%; background: #4A5568; color: white; border: none;
            border-bottom: 4px solid #2D3748; padding: 15px; text-align: left;
            font-size: 1.1rem; cursor: pointer; margin-bottom: 12px; border-radius: 10px;
            text-transform: capitalize; 
        }
        .resource-btn.active { background: var(--btn-blue); border-bottom-color: #2B6CB0; transform: translateX(5px); }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin-top: 30px; 
        }
        .hidden { display: none !important; }

        /* --- 5. WHITEBOARD TOOLBAR --- */
        #content-view {
            height: 100%; display: flex; flex-direction: column;
        }

        #wb-toolbar {
            display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center;
            background: #E2E8F0; padding: 10px; border-radius: 10px; border: 3px solid #CBD5E0;
            flex-shrink: 0; /* Prevents toolbar from shrinking */
        }
        .tool-btn {
            padding: 8px 12px; border: 2px solid #CBD5E0; border-bottom: 4px solid #CBD5E0;
            background: white; border-radius: 6px; cursor: pointer; font-weight: bold; color: #4A5568;
        }
        .tool-btn.active { background: var(--btn-blue); color: white; border-color: #2B6CB0; }
        .tool-btn:active { transform: translateY(2px); border-bottom: 2px solid #CBD5E0; }

        /* DYNAMIC COLORS CONTAINER */
        #color-palette { display: flex; align-items: center; }
        
        .color-dot {
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid #CBD5E0; cursor: pointer;
            box-shadow: 0 0 0 2px white; margin: 0 4px; transition: transform 0.1s;
        }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { transform: scale(1.25); border-color: #2D3748; box-shadow: 0 0 0 2px #CBD5E0; }

        /* --- CANVAS FRAME FIX (FULL HEIGHT) --- */
        #whiteboard-wrapper {
            flex: 1; /* Grow to fill space */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; /* Important for flex containers */
        }

        .canvas-frame {
            flex: 1; /* Fill all remaining vertical space */
            width: 100%;
            background: white;
            border: 4px solid #CBD5E0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative; 
            overflow: hidden;
        }
        
        /* CUSTOM CURSORS */
        .cursor-pen { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="black"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>') 0 24, auto !important; }
        .cursor-marker { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="deeppink"><path d="M18.5 2.5L21.5 5.5L7.5 19.5H4.5V16.5L18.5 2.5Z"/></svg>') 0 24, auto !important; }
        .cursor-rubber { cursor: cell !important; }

        /* --- CONTENT DISPLAY --- */
        .sentence-list { list-style: none; padding: 0; text-align: center; }
        .sentence-list li { font-size: 3rem; margin-bottom: 30px; background: white; padding: 20px; border-radius: 15px; border: 2px solid #E2E8F0; }
        .gap-container { font-size: 2.5rem; line-height: 2.5; text-align: center; margin-top: 30px; }
        .gap-box { border-bottom: 4px dashed #4A5568; min-width: 100px; display: inline-block; cursor: pointer; color: transparent; margin: 0 10px; }
        .gap-box.revealed { color: #2F855A; border-bottom: 4px solid #2F855A; }

    </style>
</head>
<body>

    <header>
        <button id="sidebar-toggle" class="nav-btn hidden" onclick="toggleSidebar()"><span>‚ò∞</span> Menu</button>
        <button id="header-back-btn" class="nav-btn" onclick="handleBackClick()"><span>‚Ü©</span> Back</button>
        <div id="header-title">Grammar Playground</div>
    </header>

    <div class="main-container">
        
        <aside id="sidebar" class="hidden">
            <h3 style="color: #A0AEC0; font-size: 0.85rem;">TOOLS</h3>
            <div id="resource-buttons"></div>
        </aside>

        <main id="stage">
            
            <div id="menu-view">
                <div id="level-selection">
                    <h1>Levels</h1>
                    <div id="level-list" class="grid"></div>
                </div>
                <div id="topic-selection" class="hidden">
                    <h1>Topics</h1>
                    <div id="topic-list" class="grid"></div>
                </div>
            </div>

            <div id="content-view" class="hidden">
                <div id="intro-message" style="text-align: center; color: #A0AEC0; margin-top: 100px;">
                    <h2>Select an activity üëà</h2>
                </div>
                
                <div id="lesson-content"></div>

                <div id="whiteboard-wrapper" class="hidden">
                    <div id="wb-toolbar">
                        <button class="tool-btn" onclick="undo()" title="Undo">‚Ü©</button>
                        <button class="tool-btn" onclick="redo()" title="Redo">‚Ü™</button>
                        <div style="width:1px; height:25px; background:#CBD5E0; margin:0 5px;"></div>

                        <button class="tool-btn active" id="btn-pen" onclick="setTool('pen', this)">üñä Pen</button>
                        <button class="tool-btn" id="btn-marker" onclick="setTool('marker', this)">üñç Highlight</button>
                        <button class="tool-btn" onclick="setTool('rubber', this)">‚¨ú Rubber</button>
                        <button class="tool-btn" onclick="setTool('text', this)">Tt Type</button>
                        <button class="tool-btn" onclick="deleteSelected()" style="color:#C53030;" title="Delete Selected">üóë</button>
                        
                        <div style="width:1px; height:25px; background:#CBD5E0; margin:0 5px;"></div>
                        
                        <div id="color-palette"></div>

                        <div style="width:1px; height:25px; background:#CBD5E0; margin:0 5px;"></div>

                        <button class="tool-btn" onclick="prevPage()">‚¨Ö</button>
                        <span id="page-indicator" style="font-weight:bold; font-size:0.9rem;">1 / 1</span>
                        <button class="tool-btn" onclick="nextPage()">Next ‚û°</button>
                        <button class="tool-btn" onclick="addPage()">+ New Page</button>
                        
                        <div style="flex:1;"></div>
                        
                        <button class="tool-btn" onclick="downloadBackup()" style="margin-right:5px;">‚¨á Save File</button>
                        <button class="tool-btn" onclick="triggerLoad()">‚¨Ü Load File</button>
                        <input type="file" id="file-upload" style="display:none" onchange="loadBackup(this)">
                        
                        <div style="width:1px; height:25px; background:#CBD5E0; margin:0 5px;"></div>
                        <button class="tool-btn" onclick="clearPage()">üßπ Clear</button>
                    </div>
                    
                    <div class="canvas-frame">
                        <canvas id="c"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. DATA LOADING ---
        let grammarData = [];
        let currentView = 'levels'; 
        let currentLevel = '';

        // Whiteboard State
        let canvas; 
        let wbPages = []; 
        let currentPageIndex = 0;
        let currentTool = 'pen';
        let currentColor = '#2D3748';
        
        // Colors Config
        const PALETTES = {
            pen: ['#2D3748', '#3182CE', '#E53E3E', '#38A169'], 
            marker: ['#FFFF00', '#FF69B4', '#9F7AEA', '#00FFFF'] 
        };

        // Undo/Redo State
        let history = [];
        let historyStep = -1;
        let isHistoryProcessing = false;

        document.addEventListener('DOMContentLoaded', () => {
            fetch('grammar.json')
                .then(res => { if(!res.ok) throw new Error(); return res.json(); })
                .then(data => {
                    grammarData = data;
                    renderLevels();
                    updateHeader();
                    initWhiteboard();
                })
                .catch(() => alert("Could not load grammar.json. Ensure file exists and you are using a local server."));
        });

        // --- NAVIGATION ---
        function handleBackClick() {
            if (currentView === 'levels') window.location.href = 'index.html'; 
            else if (currentView === 'topics') renderLevels();
            else if (currentView === 'content') renderTopics(currentLevel);
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }

        function updateHeader() {
            const btn = document.getElementById('header-back-btn');
            const toggle = document.getElementById('sidebar-toggle');
            
            if (currentView === 'levels') {
                btn.innerHTML = '‚úï Exit'; toggle.classList.add('hidden'); 
                document.getElementById('sidebar').classList.add('hidden');
            } else if (currentView === 'topics') {
                btn.innerHTML = '‚Ü© Levels'; toggle.classList.add('hidden'); 
                document.getElementById('sidebar').classList.add('hidden');
            } else if (currentView === 'content') {
                btn.innerHTML = '‚Ü© Topics'; toggle.classList.remove('hidden'); 
                document.getElementById('sidebar').classList.remove('hidden');
            }
        }

        function hideAll() {
            document.getElementById('menu-view').classList.add('hidden');
            document.getElementById('level-selection').classList.add('hidden');
            document.getElementById('topic-selection').classList.add('hidden');
            document.getElementById('content-view').classList.add('hidden');
        }

        // --- RENDERERS ---
        function renderLevels() {
            currentView = 'levels'; hideAll();
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('level-selection').classList.remove('hidden');
            const list = document.getElementById('level-list'); list.innerHTML = "";
            [...new Set(grammarData.map(i => i.level))].forEach(lvl => {
                const btn = document.createElement('button'); btn.className = 'fun-btn'; btn.innerText = lvl;
                btn.onclick = () => { currentLevel = lvl; renderTopics(lvl); };
                list.appendChild(btn);
            });
            updateHeader();
        }

        function renderTopics(lvl) {
            currentView = 'topics'; hideAll();
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('topic-selection').classList.remove('hidden');
            const list = document.getElementById('topic-list'); list.innerHTML = "";
            grammarData.filter(i => i.level === lvl).forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'fun-btn'; btn.style.backgroundColor = '#ED8936'; btn.style.borderBottomColor = '#C05621';
                btn.innerText = item.topic;
                btn.onclick = () => loadLesson(item.slug);
                list.appendChild(btn);
            });
            updateHeader();
        }

        function loadLesson(slug) {
            currentView = 'content'; hideAll();
            document.getElementById('content-view').classList.remove('hidden'); updateHeader();
            
            const point = grammarData.find(i => i.slug === slug);
            const btnBox = document.getElementById('resource-buttons');
            const stage = document.getElementById('lesson-content');
            const wbWrapper = document.getElementById('whiteboard-wrapper');
            
            btnBox.innerHTML = ""; stage.innerHTML = "";
            document.getElementById('intro-message').classList.remove('hidden');
            wbWrapper.classList.add('hidden');

            // WHITEBOARD BUTTON
            const wbBtn = document.createElement('button');
            wbBtn.className = 'resource-btn';
            wbBtn.innerHTML = "‚úèÔ∏è <b>Whiteboard</b>"; 
            wbBtn.style.color = "#ED8936";
            wbBtn.onclick = () => {
                activateButton(wbBtn);
                stage.classList.add('hidden');
                document.getElementById('intro-message').classList.add('hidden');
                wbWrapper.classList.remove('hidden');
                resizeCanvas();
            };
            btnBox.appendChild(wbBtn);

            // RESOURCES
            if(point && point.resources) {
                Object.keys(point.resources).forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'resource-btn';
                    btn.innerText = key.replace(/_/g, ' '); 
                    
                    btn.onclick = () => {
                        activateButton(btn);
                        wbWrapper.classList.add('hidden');
                        stage.classList.remove('hidden');
                        document.getElementById('intro-message').classList.add('hidden');
                        
                        const res = point.resources[key];
                        if (Array.isArray(res) && res[0].q) {
                             stage.innerHTML = `<div class="gap-container">` + 
                                res.map((item, idx) => {
                                    const parts = item.q.split('___');
                                    return `<div>${idx+1}. ${parts[0]}<span class="gap-box" onclick="this.classList.toggle('revealed');this.innerText=this.innerText==''?'${item.a}':''"></span>${parts[1]||''}</div><br>`;
                                }).join('') + `</div>`;
                        } else if (Array.isArray(res)) {
                            stage.innerHTML = `<ul class="sentence-list">${res.map(s => `<li>${s}</li>`).join('')}</ul>`;
                        } else if (typeof res === 'string' && (res.includes('http') || res.endsWith('.png'))) {
                            stage.innerHTML = `<div style="text-align:center"><img src="${res}" style="max-width:100%; border-radius:10px;"></div>`;
                        } else {
                            stage.innerHTML = res;
                        }
                    };
                    btnBox.appendChild(btn);
                });
            }
        }

        function activateButton(activeBtn) {
            document.querySelectorAll('.resource-btn').forEach(b => b.classList.remove('active'));
            activeBtn.classList.add('active');
        }

        // --- WHITEBOARD LOGIC ---
        function initWhiteboard() {
            canvas = new fabric.Canvas('c', { isDrawingMode: true, backgroundColor: 'white' });
            
            canvas.on('path:created', saveHistory);
            canvas.on('object:modified', saveHistory);
            canvas.on('object:added', () => { if(!isHistoryProcessing) saveHistory(); });

            // Auto-load from browser memory
            const saved = localStorage.getItem('grammarWb');
            if (saved) { wbPages = JSON.parse(saved); loadPage(0); }
            else { 
                wbPages = [JSON.stringify(canvas)]; 
                saveHistory(); 
            }
            
            setTool('pen', document.getElementById('btn-pen'));
        }

        function resizeCanvas() {
            // Force resizing to fit the flex container
            setTimeout(() => {
                const frame = document.querySelector('.canvas-frame');
                if (frame) {
                    canvas.setWidth(frame.clientWidth);
                    canvas.setHeight(frame.clientHeight);
                    canvas.renderAll();
                    canvas.calcOffset(); 
                }
            }, 10);
        }

        function renderColors(type) {
            const container = document.getElementById('color-palette');
            container.innerHTML = '';
            const palette = PALETTES[type] || PALETTES['pen'];
            palette.forEach((color, index) => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.backgroundColor = color;
                if (index === 0) { dot.classList.add('active'); currentColor = color; }
                dot.onclick = () => {
                    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                    setColor(color);
                };
                container.appendChild(dot);
            });
            setColor(palette[0]); 
        }

        function setTool(tool, btn) {
            currentTool = tool;
            if(btn) {
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            if (tool === 'pen') renderColors('pen');
            else if (tool === 'marker') renderColors('marker');
            applyToolSettings();
        }

        function applyToolSettings() {
            const canvasEl = document.querySelector('.upper-canvas');
            if (currentTool === 'pen') {
                canvas.isDrawingMode = true;
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.width = 3;
                canvas.freeDrawingBrush.color = currentColor;
                if(canvasEl) canvasEl.className = 'upper-canvas cursor-pen';
            } 
            else if (currentTool === 'marker') {
                canvas.isDrawingMode = true;
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.width = 25;
                canvas.freeDrawingBrush.color = hexToRgba(currentColor, 0.4);
                if(canvasEl) canvasEl.className = 'upper-canvas cursor-marker';
            }
            else if (currentTool === 'rubber') {
                canvas.isDrawingMode = true;
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.width = 40;
                canvas.freeDrawingBrush.color = 'white'; 
                if(canvasEl) canvasEl.className = 'upper-canvas cursor-rubber';
            }
            else if (currentTool === 'text') {
                canvas.isDrawingMode = false;
                const text = new fabric.IText('Type here...', { left: 100, top: 100, fontSize: 30, fill: currentColor });
                canvas.add(text);
                canvas.setActiveObject(text);
                saveHistory();
                if(canvasEl) canvasEl.className = 'upper-canvas';
            }
        }

        function setColor(color) {
            currentColor = color;
            if (currentTool !== 'rubber') applyToolSettings();
        }

        function deleteSelected() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                canvas.remove(activeObj);
                saveHistory();
            } else {
                alert("Select an object (like a text box) first to delete it.");
            }
        }

        // --- UNDO / REDO ---
        function saveHistory() {
            if (isHistoryProcessing) return;
            if (historyStep < history.length - 1) history = history.slice(0, historyStep + 1);
            history.push(JSON.stringify(canvas));
            historyStep++;
        }

        function undo() {
            if (historyStep > 0) {
                isHistoryProcessing = true;
                historyStep--;
                canvas.loadFromJSON(history[historyStep], () => { canvas.renderAll(); isHistoryProcessing = false; });
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                isHistoryProcessing = true;
                historyStep++;
                canvas.loadFromJSON(history[historyStep], () => { canvas.renderAll(); isHistoryProcessing = false; });
            }
        }

        function clearPage() {
            canvas.clear(); canvas.setBackgroundColor('white', canvas.renderAll.bind(canvas)); saveHistory();
        }

        // --- PAGE MANAGEMENT ---
        function saveCurrentState() {
            wbPages[currentPageIndex] = JSON.stringify(canvas);
            localStorage.setItem('grammarWb', JSON.stringify(wbPages));
        }

        function addPage() {
            saveCurrentState();
            canvas.clear(); canvas.setBackgroundColor('white', canvas.renderAll.bind(canvas));
            wbPages.push(JSON.stringify(canvas));
            currentPageIndex = wbPages.length - 1;
            history = []; historyStep = -1; saveHistory();
            updateUI();
        }

        function prevPage() {
            if(currentPageIndex > 0) { saveCurrentState(); currentPageIndex--; loadPage(currentPageIndex); }
        }

        function nextPage() {
            // Auto create new page if we are at the end
            if(currentPageIndex === wbPages.length - 1) {
                addPage();
            } else {
                saveCurrentState(); currentPageIndex++; loadPage(currentPageIndex);
            }
        }

        function loadPage(index) {
            canvas.loadFromJSON(wbPages[index], () => { canvas.renderAll(); history = [wbPages[index]]; historyStep = 0; });
            currentPageIndex = index; updateUI();
        }

        function updateUI() {
            document.getElementById('page-indicator').innerText = `${currentPageIndex + 1} / ${wbPages.length}`;
        }

        // --- FILE SAVING & LOADING ---
        function downloadBackup() {
            saveCurrentState();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(wbPages));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "lesson_plan.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function triggerLoad() {
            document.getElementById('file-upload').click();
        }

        function loadBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedPages = JSON.parse(e.target.result);
                    wbPages = loadedPages;
                    currentPageIndex = 0;
                    loadPage(0);
                    localStorage.setItem('grammarWb', JSON.stringify(wbPages));
                    alert("Lesson loaded successfully!");
                } catch(err) {
                    alert("Error loading file.");
                }
            };
            reader.readAsText(file);
        }

        function hexToRgba(hex, alpha) {
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c= hex.substring(1).split('');
                if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
                c= '0x'+c.join('');
                return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
            }
            return hex;
        }
    </script>
</body>
</html>