<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Send Note</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 400px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #2c3e50; text-align: center; }
        .room-badge { background: #3498db; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; display: block; width: fit-content; margin: 0 auto 15px auto; }
        input, textarea { width: 100%; box-sizing: border-box; padding: 15px; margin-bottom: 15px; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 16px; }
        button { width: 100%; padding: 15px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        #statusMsg { text-align: center; margin-top: 10px; font-weight: bold; min-height: 20px; }
    </style>
</head>
<body>

    <div class="container" id="loginSection">
        <h2>Join Class</h2>
        <span id="roomBadgeLogin" class="room-badge">Room: ...</span>
        <input type="text" id="studentName" placeholder="Your Name">
        <button onclick="login()">Start</button>
    </div>

    <div class="container hidden" id="writeSection">
        <span id="roomBadgeWrite" class="room-badge">Room: ...</span>
        <h2 id="welcomeMsg"></h2>
        <textarea id="noteContent" rows="5" placeholder="Type here..."></textarea>
        <button onclick="sendNote()">Send to Board</button>
        <p id="statusMsg"></p>
    </div>

    <script>
        const SB_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";
// FIX: Use supabaseClient to avoid the name crash
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        
        // 1. GET ROOM FROM URL
        const urlParams = new URLSearchParams(window.location.search);
        let roomID = urlParams.get('room');

        if (!roomID) {
            roomID = prompt("Please enter the Room Name:");
        }
        
        if (roomID) {
            document.getElementById('roomBadgeLogin').innerText = "Room: " + roomID;
            document.getElementById('roomBadgeWrite').innerText = "Room: " + roomID;
        }

        let myName = localStorage.getItem('student_name') || ""; 
        if (myName) showEditor();

        function login() {
            const inputName = document.getElementById('studentName').value.trim();
            if (!inputName) return alert("Enter a name");
            myName = inputName;
            localStorage.setItem('student_name', myName);
            showEditor();
        }

        function showEditor() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('writeSection').classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = "Hi, " + myName;
        }

        async function sendNote() {
            const content = document.getElementById('noteContent').value.trim();
            const status = document.getElementById('statusMsg');
            if (!content) return;

            status.innerText = "Sending...";
            status.style.color = "grey";

            // FIX: Use supabaseClient
            const { error } = await supabaseClient.from('notes').insert([{ 
                student_name: myName, 
                content: content,
                order_index: 9999,
                room_id: roomID 
            }]);

            if (error) {
                status.innerText = "Error!";
                status.style.color = "red";
                console.error(error);
            } else {
                status.innerText = "Sent!";
                status.style.color = "green";
                document.getElementById('noteContent').value = "";
                setTimeout(() => { status.innerText = ""; }, 2000);
            }
        }
    </script>
</body>
</html>