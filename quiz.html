<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Quiz Library</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">

    <a href="index.html" class="absolute top-6 left-6 flex items-center gap-2 text-gray-600 hover:text-indigo-700 font-bold transition z-50 group">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform group-hover:-translate-x-1 transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span>Back to Tools</span>
    </a>

    <div id="app-container" class="w-full max-w-6xl mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden min-h-[700px] flex flex-col relative">
        
        <div class="bg-white border-b border-gray-100 px-8 py-6 flex justify-between items-center">
            <h1 class="text-3xl font-black text-gray-900">Quiz <span class="text-indigo-600">Time</span></h1>
            <span id="current-level-badge" class="hidden bg-indigo-100 text-indigo-700 px-4 py-1 rounded-full font-bold text-sm">LEVEL</span>
        </div>

        <div id="view-levels" class="flex-1 flex flex-col justify-center items-center p-12">
            <h2 class="text-3xl font-bold text-gray-700 mb-10">Choose your level</h2>
            
            <div id="loading-msg" class="text-indigo-500 font-bold animate-pulse mb-4 text-xl">
                ‚è≥ Connecting to Database...
            </div>
            
            <div id="error-msg" class="hidden bg-red-50 border-2 border-red-200 p-6 rounded-xl max-w-2xl text-center">
                <h3 class="text-red-700 font-black text-xl mb-2">‚ö†Ô∏è Database Connection Error</h3>
                <p id="error-text" class="text-red-600 font-medium"></p>
            </div>

            <div id="level-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl"></div>
        </div>

        <div id="view-menu" class="hidden flex-1 p-10 bg-gray-50 overflow-y-auto">
            <button onclick="app.showLevels()" class="mb-6 text-sm font-bold text-gray-400 hover:text-gray-600">‚Üê Change Level</button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                <div>
                    <h3 class="text-xl font-black text-blue-500 mb-4 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-blue-500"></span> GRAMMAR
                    </h3>
                    <div id="list-grammar" class="space-y-3"></div>
                </div>
                <div>
                    <h3 class="text-xl font-black text-green-500 mb-4 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-green-500"></span> VOCABULARY
                    </h3>
                    <div id="list-vocab" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="view-player" class="hidden flex-1 flex flex-col p-10 bg-white">
            <div class="w-full bg-gray-100 h-2 rounded-full mb-8">
                <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <div class="flex-1 max-w-3xl mx-auto w-full">
                <div class="flex justify-between items-center mb-6">
                    <span id="q-counter" class="text-gray-400 font-bold text-sm uppercase tracking-widest">Question 1</span>
                    <button onclick="app.exitQuiz()" class="text-gray-400 hover:text-red-500 font-bold text-sm transition flex items-center gap-1">EXIT <span class="text-lg">‚úï</span></button>
                </div>

                <h2 id="q-text" class="text-2xl md:text-3xl font-bold text-gray-800 mt-4 mb-8 leading-relaxed">...</h2>
                <div id="q-options" class="space-y-2"></div>
                
                <div id="feedback" class="hidden mt-6 p-6 rounded-xl bg-gray-50 border border-gray-200">
                    <h3 id="fb-title" class="font-bold text-lg mb-1"></h3>
                    <p id="fb-text" class="text-gray-600"></p>
                </div>
            </div>

            <div class="border-t border-gray-100 pt-6 mt-6 flex justify-end">
                <button id="next-btn" onclick="app.nextQuestion()" class="hidden px-6 py-3 font-bold rounded-xl shadow-md transition transform hover:scale-105 active:scale-95 text-white text-center bg-indigo-600 hover:bg-indigo-700">Continue ‚Üí</button>
            </div>
        </div>

        <div id="view-results" class="hidden flex-1 flex flex-col items-center justify-center p-10">
            <h2 class="text-4xl font-black text-gray-800 mb-8">Quiz Complete!</h2>
            <div id="res-circle" class="w-40 h-40 rounded-full border-8 flex flex-col items-center justify-center mx-auto mb-6">
                <span id="res-percent" class="text-5xl font-black">0%</span>
            </div>
            <p id="res-text" class="text-xl text-gray-500 font-medium mb-10">You scored 0/0</p>
            <div class="flex flex-wrap gap-4 justify-center">
                <button onclick="app.showMenu()" class="px-6 py-3 font-bold rounded-xl shadow-md transition transform hover:scale-105 active:scale-95 text-white text-center bg-gray-800 hover:bg-gray-900">Back to Menu</button>
                <button onclick="app.restartQuiz()" class="px-6 py-3 font-bold rounded-xl shadow-md transition transform hover:scale-105 active:scale-95 text-white text-center bg-indigo-600 hover:bg-indigo-700">Retry Quiz</button>
                <button id="btn-review" onclick="app.showReview()" class="hidden px-6 py-3 font-bold rounded-xl shadow-md transition transform hover:scale-105 active:scale-95 text-white text-center bg-orange-500 hover:bg-orange-600">Review Mistakes</button>
            </div>
        </div>

        <div id="view-review" class="hidden flex-1 p-10 bg-gray-50 overflow-y-auto">
            <div class="max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-black text-gray-800">Incorrect Answers</h2>
                    <button onclick="app.switchView('view-results')" class="text-gray-500 hover:text-gray-800 font-bold">Close Review</button>
                </div>
                <div id="review-list" class="space-y-6"></div>
                <div class="mt-8 text-center">
                    <button onclick="app.switchView('view-results')" class="px-6 py-3 font-bold rounded-xl shadow-md transition transform hover:scale-105 active:scale-95 text-white text-center bg-gray-800">Back to Results</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 2. CONFIGURE SUPABASE ---
        // PASTE YOUR KEYS HERE
        const SUPABASE_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";

        
        // --- 2. CREATE CLIENT (Renamed to dbClient to fix error) ---
        const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let quizzes = []; 

        const app = {
            state: { currentQuiz: null, qIdx: 0, score: 0, selectedLevel: null, wrongAnswers: [] },

            init: async function() {
                try {
                    // --- 3. FETCH FROM DATABASE ---
                    // We use 'dbClient' now instead of 'supabase'
                    const { data, error } = await dbClient
                        .from('grammar_quizzes')
                        .select('*');

                    if (error) throw error;

                    if (data && data.length > 0) {
                        quizzes = data;
                        document.getElementById('loading-msg').style.display = 'none';
                        this.renderLevels();
                    } else {
                        // If table is empty, show a specific message
                        throw new Error("Connected, but the 'grammar_quizzes' table is empty.");
                    }

                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById('loading-msg').style.display = 'none';
                    const errDiv = document.getElementById('error-msg');
                    errDiv.classList.remove('hidden');
                    document.getElementById('error-text').innerText = error.message;
                }
            },

            // --- VIEW MANAGER ---
            switchView: function(viewId) {
                ['view-levels', 'view-menu', 'view-player', 'view-results', 'view-review'].forEach(id => {
                    const el = document.getElementById(id);
                    el.classList.add('hidden');
                    el.classList.remove('flex'); 
                });
                
                const target = document.getElementById(viewId);
                target.classList.remove('hidden');
                // Re-add flex for specific containers that need centering
                if(['view-player', 'view-results', 'view-review'].includes(viewId)) {
                   target.classList.add('flex');
                }
            },

            // --- LEVEL RENDERER ---
            renderLevels: function() {
                if(!quizzes || quizzes.length === 0) return;
                const levels = [...new Set(quizzes.map(q => q.level))].sort();
                const container = document.getElementById('level-grid');
                container.innerHTML = '';
                
                const gradients = { 
                    'kids': 'from-yellow-400 to-orange-500', 
                    'A1': 'from-blue-300 to-blue-500', 
                    'A2': 'from-blue-400 to-blue-600', 
                    'B1': 'from-indigo-400 to-indigo-600', 
                    'B2': 'from-indigo-500 to-indigo-700', 
                    'C1': 'from-orange-400 to-pink-500', 
                    'C2': 'from-green-500 to-emerald-700' 
                };

                levels.forEach(lvl => {
                    const btn = document.createElement('div');
                    const grad = gradients[lvl] || 'from-gray-500 to-gray-700';
                    btn.className = `flex flex-col items-center justify-center p-8 rounded-2xl border-4 border-transparent transition-all duration-300 cursor-pointer shadow-lg hover:-translate-y-2 hover:border-indigo-200 bg-gradient-to-br ${grad} text-white`;
                    btn.innerHTML = `<span class="text-6xl font-black opacity-80 uppercase">${lvl}</span><span class="font-bold mt-2 opacity-75">SELECT</span>`;
                    btn.onclick = () => this.selectLevel(lvl);
                    container.appendChild(btn);
                });
            },

            selectLevel: function(lvl) {
                this.state.selectedLevel = lvl;
                document.getElementById('current-level-badge').innerText = lvl;
                document.getElementById('current-level-badge').classList.remove('hidden');
                this.renderMenu(lvl);
                this.switchView('view-menu');
            },

            showLevels: function() {
                this.switchView('view-levels');
                document.getElementById('current-level-badge').classList.add('hidden');
            },

            // --- MENU RENDERER ---
            renderMenu: function(lvl) {
                const gList = document.getElementById('list-grammar');
                const vList = document.getElementById('list-vocab');
                gList.innerHTML = ''; vList.innerHTML = '';
                const filtered = quizzes.filter(q => q.level === lvl).sort((a,b) => a.title.localeCompare(b.title));
                
                if(filtered.length === 0) { gList.innerHTML = "<p class='text-gray-400 italic'>No quizzes found.</p>"; return; }

                filtered.forEach(q => {
                    const card = document.createElement('div');
                    const borderColor = q.category === 'grammar' ? 'border-blue-500' : 'border-green-500';
                    card.className = `bg-white p-5 rounded-xl border-l-8 shadow-sm hover:shadow-md transition-all cursor-pointer flex justify-between items-center border-gray-100 hover:bg-gray-50 translate-x-1 ${borderColor}`;
                    card.innerHTML = `<div><h4 class="font-bold text-gray-800 text-lg">${q.title}</h4><span class="text-xs font-bold text-gray-400 uppercase tracking-wide">${q.questions.length} Questions</span></div><div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">‚ñ∂</div>`;
                    card.onclick = () => this.startQuiz(q);
                    if(q.category === 'grammar') gList.appendChild(card); else vList.appendChild(card);
                });
            },

            showMenu: function() { this.switchView('view-menu'); },

            // --- QUIZ PLAYER LOGIC ---
            startQuiz: function(quiz) {
                this.state.currentQuiz = quiz;
                this.state.qIdx = 0;
                this.state.score = 0;
                this.state.wrongAnswers = []; 
                this.switchView('view-player');
                this.renderQuestion();
            },

            exitQuiz: function() {
                if(confirm("Exit this quiz? Your progress will be lost.")) {
                    this.showMenu();
                }
            },

            renderQuestion: function() {
                const q = this.state.currentQuiz.questions[this.state.qIdx];
                const total = this.state.currentQuiz.questions.length;
                document.getElementById('q-counter').innerText = `Question ${this.state.qIdx + 1} of ${total}`;
                document.getElementById('q-text').innerText = q.text;
                document.getElementById('feedback').classList.add('hidden');
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('progress-bar').style.width = `${((this.state.qIdx)/total)*100}%`;

                const optContainer = document.getElementById('q-options');
                optContainer.innerHTML = ''; 

                const revealBtn = document.createElement('div');
                revealBtn.className = 'w-full py-10 border-4 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold text-xl hover:bg-indigo-50 hover:border-indigo-300 hover:text-indigo-500 transition-all flex flex-col items-center justify-center gap-2 cursor-pointer';
                revealBtn.innerHTML = `<span>üëÅÔ∏è Show Options</span><span class="text-sm font-normal opacity-70">(Try to answer without looking!)</span>`;
                
                const hideBar = document.createElement('div');
                hideBar.className = 'hidden flex justify-end mb-2';
                hideBar.innerHTML = `<button class="text-xs font-bold text-gray-400 hover:text-indigo-600 uppercase tracking-wider flex items-center gap-1">Hide Options ‚¨ÜÔ∏è</button>`;

                const choicesWrapper = document.createElement('div');
                choicesWrapper.className = 'hidden space-y-2'; 

                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-5 rounded-xl border-2 border-gray-100 font-semibold text-gray-700 transition-all hover:border-indigo-300 hover:bg-indigo-50 mb-3 option-btn';
                    btn.innerText = opt;
                    btn.onclick = () => this.checkAnswer(idx, btn);
                    choicesWrapper.appendChild(btn);
                });

                // Toggle Logic
                revealBtn.onclick = () => {
                    revealBtn.classList.add('hidden');
                    revealBtn.classList.remove('flex'); 
                    hideBar.classList.remove('hidden');
                    choicesWrapper.classList.remove('hidden');
                };

                hideBar.onclick = () => {
                    revealBtn.classList.remove('hidden');
                    revealBtn.classList.add('flex'); 
                    hideBar.classList.add('hidden');
                    choicesWrapper.classList.add('hidden');
                };

                optContainer.appendChild(revealBtn);
                optContainer.appendChild(hideBar);
                optContainer.appendChild(choicesWrapper);
            },

            checkAnswer: function(selectedIndex, btnElement) {
                const allBtns = document.querySelectorAll('.option-btn');
                allBtns.forEach(b => b.disabled = true);
                
                btnElement.classList.remove('border-gray-100', 'hover:border-indigo-300');
                btnElement.classList.add('border-indigo-600', 'bg-indigo-50', 'ring-2', 'ring-indigo-200');

                const q = this.state.currentQuiz.questions[this.state.qIdx];
                const fbBox = document.getElementById('feedback');
                const fbTitle = document.getElementById('fb-title');
                const fbText = document.getElementById('fb-text');

                fbBox.classList.remove('hidden');
                document.getElementById('next-btn').classList.remove('hidden');

                if(selectedIndex === q.answer) {
                    this.state.score++;
                    fbBox.className = "mt-6 p-6 rounded-xl bg-green-50 border border-green-200";
                    fbTitle.innerHTML = "‚úÖ Correct!";
                    fbTitle.className = "font-bold text-lg mb-1 text-green-700";
                } else {
                    this.state.wrongAnswers.push({
                        question: q.text,
                        userSelected: q.options[selectedIndex],
                        correctAnswer: q.options[q.answer],
                        explanation: q.explanation
                    });
                    fbBox.className = "mt-6 p-6 rounded-xl bg-red-50 border border-red-200";
                    fbTitle.innerHTML = "‚ùå Not quite.";
                    fbTitle.className = "font-bold text-lg mb-1 text-red-700";
                }
                fbText.innerText = q.explanation;
            },

            nextQuestion: function() {
                this.state.qIdx++;
                if(this.state.qIdx < this.state.currentQuiz.questions.length) {
                    this.renderQuestion();
                } else {
                    this.showResults();
                }
            },

            restartQuiz: function() { this.startQuiz(this.state.currentQuiz); },

            showResults: function() {
                this.switchView('view-results');
                const total = this.state.currentQuiz.questions.length;
                const score = this.state.score;
                const percent = Math.round((score / total) * 100);

                document.getElementById('res-percent').innerText = `${percent}%`;
                document.getElementById('res-text').innerText = `You scored ${score} out of ${total}`;
                
                const circle = document.getElementById('res-circle');
                const reviewBtn = document.getElementById('btn-review');

                if(percent >= 80) circle.className = "w-40 h-40 rounded-full border-8 flex flex-col items-center justify-center mx-auto mb-6 border-green-100 text-green-600 bg-green-50";
                else if (percent >= 50) circle.className = "w-40 h-40 rounded-full border-8 flex flex-col items-center justify-center mx-auto mb-6 border-yellow-100 text-yellow-600 bg-yellow-50";
                else circle.className = "w-40 h-40 rounded-full border-8 flex flex-col items-center justify-center mx-auto mb-6 border-red-100 text-red-600 bg-red-50";

                if(score < total) reviewBtn.classList.remove('hidden');
                else reviewBtn.classList.add('hidden');
            },

            showReview: function() {
                this.switchView('view-review');
                const container = document.getElementById('review-list');
                container.innerHTML = '';
                this.state.wrongAnswers.forEach(item => {
                    const card = document.createElement('div');
                    card.className = "p-6 rounded-xl border-2 border-red-100 bg-red-50/30 mb-4";
                    card.innerHTML = `<h4 class="font-bold text-lg text-gray-800 mb-3">${item.question}</h4><div class="flex flex-col gap-2 mb-3"><div class="p-3 bg-red-100 text-red-700 rounded-lg font-semibold border border-red-200"><span class="text-xs uppercase tracking-wider block mb-1 text-red-500">You chose:</span>‚ùå ${item.userSelected}</div><div class="p-3 bg-green-100 text-green-700 rounded-lg font-semibold border border-green-200"><span class="text-xs uppercase tracking-wider block mb-1 text-green-500">Correct Answer:</span>‚úÖ ${item.correctAnswer}</div></div><p class="text-sm text-gray-600 italic">üí° ${item.explanation}</p>`;
                    container.appendChild(card);
                });
            }
        };

        app.init();
    </script>
</body>
</html>