<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Quiz Library + AI</title>
    
    <link rel="stylesheet" href="global.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .loader { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #ffffff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { background-color: #4f46e5; color: white; }
        .tab-inactive { background-color: white; color: #4b5563; }
        
        /* Reveal Button Animation */
        .reveal-box:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-6xl mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden min-h-[700px] flex flex-col relative">
        
        <div class="bg-white border-b border-gray-100 px-8 py-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <a href="index.html" class="btn-back px-4 py-2 text-sm no-underline shadow-sm hover:shadow-md">
                    ‚Üê Back
                </a>
                <h1 class="text-3xl font-black text-gray-900">Quiz <span class="text-indigo-600">Hub</span></h1>
            </div>
            <span id="current-level-badge" class="hidden bg-indigo-100 text-indigo-700 px-4 py-1 rounded-full font-bold text-sm">LEVEL</span>
        </div>

        <div id="view-levels" class="flex-1 flex flex-col justify-center items-center p-12">
            <h2 class="text-3xl font-bold text-gray-700 mb-10">Choose your level</h2>
            <div id="loading-msg" class="text-indigo-500 font-bold animate-pulse mb-4 text-xl">‚è≥ Connecting...</div>
            <div id="level-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl"></div>
        </div>

        <div id="view-menu" class="hidden flex-1 p-6 md:p-10 bg-gray-50 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <button onclick="app.showLevels()" class="text-sm font-bold text-gray-400 hover:text-gray-600 flex items-center gap-1">‚Üê Change Level</button>
            </div>

            <div class="bg-gradient-to-r from-indigo-600 to-purple-700 rounded-2xl p-6 md:p-8 mb-10 text-white shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="text-2xl font-black mb-2">‚ú® Teacher's Assistant AI</h3>
                    <p class="mb-6 opacity-90 text-indigo-100">Instantly generate a Cambridge-style quiz. It will open in <span class="font-bold text-white">Preview Mode</span>.</p>
                    
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="ai-topic" placeholder="Topic (e.g. Climate Change, 90s Music)" class="flex-1 p-4 rounded-xl text-gray-800 font-bold focus:outline-none focus:ring-4 focus:ring-purple-400 placeholder-gray-400">
                        <select id="ai-type" class="p-4 rounded-xl text-gray-800 font-bold focus:outline-none focus:ring-4 focus:ring-purple-400 cursor-pointer">
                            <option value="vocabulary">Vocabulary</option>
                            <option value="grammar">Grammar</option>
                        </select>
                        <button onclick="app.generateQuiz()" id="btn-generate" class="bg-indigo-900 hover:bg-indigo-950 text-white px-8 py-4 rounded-xl font-black transition shadow-lg flex items-center gap-2 justify-center min-w-[160px] border border-indigo-400/30">
                            <span id="gen-text">Preview Quiz</span>
                            <div id="gen-loader" class="hidden loader"></div>
                        </button>
                    </div>
                </div>
                <div class="absolute -right-10 -top-10 w-64 h-64 bg-white opacity-10 rounded-full blur-3xl"></div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                <div class="flex bg-white p-1 rounded-xl shadow-sm border border-gray-200">
                    <button onclick="app.setTab('official')" id="tab-official" class="px-6 py-2 rounded-lg font-bold text-sm transition-all tab-active">üìö Official Library</button>
                    <button onclick="app.setTab('community')" id="tab-community" class="px-6 py-2 rounded-lg font-bold text-sm transition-all tab-inactive">ü§ñ User Generated</button>
                </div>
                
                <div class="relative w-full md:w-64">
                    <input type="text" id="search-input" onkeyup="app.handleSearch()" placeholder="Search quizzes..." class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-200 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100">
                    <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-lg font-black text-gray-400 uppercase tracking-widest mb-4 border-b pb-2">Grammar</h3>
                    <div id="list-grammar" class="space-y-3"></div>
                </div>
                <div>
                    <h3 class="text-lg font-black text-gray-400 uppercase tracking-widest mb-4 border-b pb-2">Vocabulary</h3>
                    <div id="list-vocab" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="view-player" class="hidden flex-1 flex flex-col p-6 md:p-10 bg-white">
            <div class="w-full bg-gray-100 h-2 rounded-full mb-8">
                <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="flex-1 max-w-3xl mx-auto w-full">
                <div class="flex justify-between items-center mb-6">
                    <span id="q-counter" class="text-gray-400 font-bold text-sm uppercase tracking-widest">Question 1</span>
                    
                    <div class="flex gap-2">
                        <button id="btn-save-cloud" onclick="app.saveCurrentQuiz()" class="hidden px-4 py-1 rounded-lg bg-green-100 text-green-700 font-bold text-xs hover:bg-green-200 transition flex items-center gap-1">
                            ‚òÅÔ∏è Save to Library
                        </button>
                        <button onclick="app.exitQuiz()" class="text-gray-400 hover:text-red-500 font-bold text-sm transition">EXIT ‚úï</button>
                    </div>
                </div>

                <h2 id="q-text" class="text-2xl md:text-3xl font-bold text-gray-800 mt-4 mb-8 leading-relaxed">...</h2>
                
                <div id="q-options" class="space-y-2"></div>
                
                <div id="feedback" class="hidden mt-6 p-6 rounded-xl bg-gray-50 border border-gray-200">
                    <h3 id="fb-title" class="font-bold text-lg mb-1"></h3>
                    <p id="fb-text" class="text-gray-600"></p>
                </div>
            </div>
            
            <div class="border-t border-gray-100 pt-6 mt-6 flex justify-between items-center">
                <button id="prev-btn" onclick="app.prevQuestion()" class="hidden px-6 py-3 font-bold rounded-xl text-gray-500 hover:bg-gray-100 hover:text-gray-800 transition">
                    ‚Üê Back
                </button>
                <button id="next-btn" onclick="app.nextQuestion()" class="px-6 py-3 font-bold rounded-xl shadow-md transition transform hover:scale-105 text-white bg-indigo-600">
                    Continue ‚Üí
                </button>
            </div>
        </div>

        <div id="view-results" class="hidden flex-1 flex flex-col items-center justify-center p-10">
            <h2 class="text-4xl font-black text-gray-800 mb-8">Quiz Complete!</h2>
            <div id="res-circle" class="w-40 h-40 rounded-full border-8 flex flex-col items-center justify-center mx-auto mb-6">
                <span id="res-percent" class="text-5xl font-black">0%</span>
            </div>
            <p id="res-text" class="text-xl text-gray-500 font-medium mb-10">Score: 0/0</p>
            <button onclick="app.showMenu()" class="px-6 py-3 font-bold rounded-xl shadow-md bg-gray-800 text-white hover:bg-gray-900">Back to Menu</button>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://ehhkjhyanmovymjqlxwo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoaGtqaHlhbm1vdnltanFseHdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODI3NzQsImV4cCI6MjA4Mjk1ODc3NH0.LIbusFxccfDl_Jxf3NO0CIKo4WRUA-88R9bQwQ1QWuk";


        const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allQuizzes = []; 

        const app = {
            state: { 
                currentQuiz: null, 
                qIdx: 0, 
                score: 0, 
                selectedLevel: null,
                activeTab: 'official', 
                searchTerm: ''
            },

            init: async function() {
                try {
                    const { data, error } = await dbClient.from('grammar_quizzes').select('*');
                    if (data) {
                        allQuizzes = data;
                        document.getElementById('loading-msg').style.display = 'none';
                        this.renderLevels();
                    } else if (error) {
                        console.error(error);
                        document.getElementById('loading-msg').innerText = "Database Error";
                    }
                } catch (e) { 
                    console.error(e);
                    document.getElementById('loading-msg').innerText = "Connection Failed";
                }
            },

            // --- AI GENERATION ---
            generateQuiz: async function() {
                const topic = document.getElementById('ai-topic').value;
                const type = document.getElementById('ai-type').value;
                const btnText = document.getElementById('gen-text');
                const loader = document.getElementById('gen-loader');

                if(!topic) return alert("Please type a topic!");

                btnText.innerText = "Dreaming...";
                loader.classList.remove('hidden');

                try {
                    const response = await fetch('/.netlify/functions/quiz-generator', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            topic: topic, 
                            level: this.state.selectedLevel || 'B1',
                            type: type
                        })
                    });
                    const newQuiz = await response.json();
                    if(newQuiz.error) throw new Error(newQuiz.error);

                    newQuiz.is_unsaved_preview = true; 
                    newQuiz.is_generated = true;

                    this.startQuiz(newQuiz);

                } catch (error) {
                    alert("AI Error: " + error.message);
                } finally {
                    btnText.innerText = "Preview Quiz";
                    loader.classList.add('hidden');
                }
            },

            saveCurrentQuiz: async function() {
                const q = this.state.currentQuiz;
                if(!q) return;

                const btn = document.getElementById('btn-save-cloud');
                const originalText = btn.innerText;
                btn.innerText = "Saving...";

                const finalId = q.id || `auto_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;

                const { error } = await dbClient
                    .from('grammar_quizzes')
                    .upsert({ 
                        id: finalId, 
                        title: q.title,
                        level: q.level,
                        category: q.category,
                        topic: q.topic,
                        questions: q.questions,
                        is_generated: true
                    }, { onConflict: 'id' });

                if(error) {
                    alert("Error saving: " + error.message);
                    btn.innerText = originalText;
                } else {
                    btn.className = "px-4 py-1 rounded-lg bg-green-100 text-green-700 font-bold text-xs cursor-default";
                    btn.innerText = "Saved to Library ‚úÖ";
                    btn.onclick = null; 
                    
                    q.id = finalId;
                    delete q.is_unsaved_preview;
                    
                    const existingIdx = allQuizzes.findIndex(x => x.id === finalId);
                    if (existingIdx > -1) {
                        allQuizzes[existingIdx] = q;
                    } else {
                        allQuizzes.push(q);
                    }
                }
            },

            // --- TABS & SEARCH ---
            setTab: function(tabName) {
                this.state.activeTab = tabName;
                const offBtn = document.getElementById('tab-official');
                const comBtn = document.getElementById('tab-community');
                
                if(tabName === 'official') {
                    offBtn.className = "px-6 py-2 rounded-lg font-bold text-sm transition-all tab-active shadow-sm";
                    comBtn.className = "px-6 py-2 rounded-lg font-bold text-sm transition-all tab-inactive hover:bg-gray-50";
                } else {
                    offBtn.className = "px-6 py-2 rounded-lg font-bold text-sm transition-all tab-inactive hover:bg-gray-50";
                    comBtn.className = "px-6 py-2 rounded-lg font-bold text-sm transition-all tab-active shadow-sm";
                }
                this.renderMenu(this.state.selectedLevel);
            },

            handleSearch: function() {
                this.state.searchTerm = document.getElementById('search-input').value.toLowerCase();
                this.renderMenu(this.state.selectedLevel);
            },

            // --- RENDER LOGIC ---
            renderLevels: function() {
                const levels = ["kids", "A1", "A2", "B1", "B2", "C1", "C2"];
                const container = document.getElementById('level-grid');
                container.innerHTML = '';
                
                const gradients = { 
                    'kids': 'from-yellow-400 to-orange-500', 
                    'A1': 'from-blue-300 to-blue-500', 
                    'A2': 'from-blue-400 to-blue-600', 
                    'B1': 'from-indigo-400 to-indigo-600', 
                    'B2': 'from-indigo-500 to-indigo-700', 
                    'C1': 'from-orange-400 to-pink-500', 
                    'C2': 'from-green-500 to-emerald-700' 
                };

                levels.forEach(lvl => {
                    const btn = document.createElement('div');
                    const grad = gradients[lvl] || 'from-gray-500 to-gray-700';
                    btn.className = `flex flex-col items-center justify-center p-8 rounded-2xl cursor-pointer shadow-lg hover:-translate-y-1 transition-all duration-300 bg-gradient-to-br ${grad} text-white`;
                    btn.innerHTML = `<span class="text-5xl font-black opacity-90 uppercase">${lvl}</span>`;
                    btn.onclick = () => {
                        this.state.selectedLevel = lvl;
                        document.getElementById('current-level-badge').innerText = lvl;
                        document.getElementById('current-level-badge').classList.remove('hidden');
                        this.renderMenu(lvl);
                        this.switchView('view-menu');
                    };
                    container.appendChild(btn);
                });
            },

            renderMenu: function(lvl) {
                const gList = document.getElementById('list-grammar');
                const vList = document.getElementById('list-vocab');
                gList.innerHTML = ''; vList.innerHTML = '';
                
                const filtered = allQuizzes.filter(q => {
                    const matchesLevel = q.level === lvl;
                    const isGen = !!q.is_generated; 
                    const matchesTab = (this.state.activeTab === 'official') ? !isGen : isGen;
                    const matchesSearch = q.title.toLowerCase().includes(this.state.searchTerm);
                    return matchesLevel && matchesTab && matchesSearch;
                });

                if(filtered.length === 0) {
                    const msg = `<p class="text-gray-400 text-sm italic">No quizzes found.</p>`;
                    gList.innerHTML = msg;
                    vList.innerHTML = msg;
                    return;
                }
                
                const createCard = (q) => {
                    const d = document.createElement('div');
                    const borderColor = q.category === 'grammar' ? 'border-blue-500' : 'border-green-500';
                    d.className = `bg-white p-5 rounded-xl border-l-8 shadow-sm hover:shadow-md transition-all cursor-pointer flex justify-between items-center border-gray-100 hover:bg-gray-50 translate-x-1 ${borderColor}`;
                    d.innerHTML = `<div><h4 class="font-bold text-gray-800 text-lg">${q.title}</h4><span class="text-xs font-bold text-gray-400 uppercase">${q.questions.length} Qs</span></div><div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">‚ñ∂</div>`;
                    d.onclick = () => this.startQuiz(q);
                    return d;
                };

                filtered.forEach(q => {
                    if(q.category === 'grammar') gList.appendChild(createCard(q));
                    else vList.appendChild(createCard(q));
                });
            },

            // --- STANDARD PLAYER ---
            switchView: function(id) {
                ['view-levels', 'view-menu', 'view-player', 'view-results'].forEach(v => {
                    document.getElementById(v).classList.add('hidden');
                    document.getElementById(v).classList.remove('flex');
                });
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                if(id !== 'view-menu') el.classList.add('flex');
            },

            startQuiz: function(quiz) {
                this.state.currentQuiz = quiz;
                this.state.qIdx = 0;
                this.state.score = 0;
                this.switchView('view-player');

                const saveBtn = document.getElementById('btn-save-cloud');
                if (quiz.is_unsaved_preview) {
                    saveBtn.classList.remove('hidden');
                    saveBtn.innerText = "‚òÅÔ∏è Save to Library";
                    saveBtn.className = "px-4 py-1 rounded-lg bg-green-100 text-green-700 font-bold text-xs hover:bg-green-200 transition flex items-center gap-1";
                    saveBtn.onclick = () => this.saveCurrentQuiz();
                } else {
                    saveBtn.classList.add('hidden');
                }

                this.renderQuestion();
            },

            renderQuestion: function() {
                const q = this.state.currentQuiz.questions[this.state.qIdx];
                const total = this.state.currentQuiz.questions.length;
                document.getElementById('q-counter').innerText = `Question ${this.state.qIdx + 1} of ${total}`;
                document.getElementById('q-text').innerText = q.text;
                
                document.getElementById('feedback').classList.add('hidden');
                // Ensure Continue button is always visible
                document.getElementById('next-btn').classList.remove('hidden');
                
                // Toggle Prev Button Visibility
                const prevBtn = document.getElementById('prev-btn');
                if (this.state.qIdx === 0) {
                    prevBtn.classList.add('hidden');
                } else {
                    prevBtn.classList.remove('hidden');
                }

                document.getElementById('progress-bar').style.width = `${(this.state.qIdx / total) * 100}%`;
                
                const optContainer = document.getElementById('q-options');
                optContainer.innerHTML = ''; 

                // --- 1. REVEAL BUTTON ---
                const revealBtn = document.createElement('div');
                revealBtn.className = 'reveal-box w-full py-10 border-4 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold text-xl hover:bg-indigo-50 hover:border-indigo-300 hover:text-indigo-500 transition-all flex flex-col items-center justify-center gap-2 cursor-pointer';
                revealBtn.innerHTML = `<span>üëÅÔ∏è Show Options</span><span class="text-sm font-normal opacity-70">(Try to answer without looking!)</span>`;
                
                // --- 2. HIDE BAR ---
                const hideBar = document.createElement('div');
                hideBar.className = 'hidden flex justify-end mb-2';
                hideBar.innerHTML = `<button class="text-xs font-bold text-gray-400 hover:text-indigo-600 uppercase tracking-wider flex items-center gap-1">Hide Options ‚¨ÜÔ∏è</button>`;

                // --- 3. CHOICES WRAPPER ---
                const choicesWrapper = document.createElement('div');
                choicesWrapper.className = 'hidden space-y-2'; 

                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-5 rounded-xl border-2 border-gray-100 font-semibold text-gray-700 transition-all hover:border-indigo-300 hover:bg-indigo-50 mb-3 option-btn';
                    btn.innerText = opt;
                    btn.onclick = () => this.checkAnswer(idx, btn, q);
                    choicesWrapper.appendChild(btn);
                });

                // Toggle Logic
                revealBtn.onclick = () => {
                    revealBtn.classList.add('hidden');
                    revealBtn.classList.remove('flex'); 
                    hideBar.classList.remove('hidden');
                    choicesWrapper.classList.remove('hidden');
                };

                hideBar.onclick = () => {
                    revealBtn.classList.remove('hidden');
                    revealBtn.classList.add('flex'); 
                    hideBar.classList.add('hidden');
                    choicesWrapper.classList.add('hidden');
                };

                optContainer.appendChild(revealBtn);
                optContainer.appendChild(hideBar);
                optContainer.appendChild(choicesWrapper);
            },

            checkAnswer: function(selectedIndex, btnElement, q) {
                // IMPORTANT: Pass 'q' to this function so we know which question we are checking
                const allBtns = document.querySelectorAll('.option-btn');
                allBtns.forEach(b => b.disabled = true);
                
                btnElement.classList.remove('border-gray-100', 'hover:border-indigo-300', 'hover:bg-indigo-50');
                btnElement.classList.add('border-indigo-600', 'bg-indigo-50', 'ring-2', 'ring-indigo-200');

                const fbBox = document.getElementById('feedback');
                const fbTitle = document.getElementById('fb-title');
                const fbText = document.getElementById('fb-text');

                fbBox.classList.remove('hidden');

                if(selectedIndex === q.answer) {
                    this.state.score++;
                    fbBox.className = "mt-6 p-6 rounded-xl bg-green-50 border border-green-200";
                    fbTitle.innerHTML = "‚úÖ Correct!";
                    fbTitle.className = "font-bold text-lg mb-1 text-green-700";
                } else {
                    fbBox.className = "mt-6 p-6 rounded-xl bg-red-50 border border-red-200";
                    fbTitle.innerHTML = "‚ùå Not quite.";
                    fbTitle.className = "font-bold text-lg mb-1 text-red-700";
                }
                fbText.innerText = q.explanation;
            },

            // --- ADDED PREV FUNCTION ---
            prevQuestion: function() {
                if (this.state.qIdx > 0) {
                    this.state.qIdx--;
                    this.renderQuestion();
                }
            },

            nextQuestion: function() {
                this.state.qIdx++;
                if(this.state.qIdx < this.state.currentQuiz.questions.length) this.renderQuestion();
                else this.showResults();
            },

            showResults: function() {
                this.switchView('view-results');
                const percent = Math.round((this.state.score / this.state.currentQuiz.questions.length) * 100);
                document.getElementById('res-percent').innerText = `${percent}%`;
                document.getElementById('res-text').innerText = `Score: ${this.state.score}/${this.state.currentQuiz.questions.length}`;
            },

            showMenu: function() { this.switchView('view-menu'); },
            showLevels: function() { this.switchView('view-levels'); },
            exitQuiz: function() { if(confirm("Quit?")) this.showMenu(); }
        };

        app.init();
    </script>
</body>
</html>